# ç†è§£æ‰©æ•£æ¨¡å‹

## å¼•è¨€ï¼šç”Ÿæˆæ¨¡å‹

ç»™å®šä»æ„Ÿå…´è¶£åˆ†å¸ƒä¸­è§‚å¯Ÿåˆ°çš„æ ·æœ¬ $x$ï¼Œç”Ÿæˆæ¨¡å‹çš„ç›®æ ‡æ˜¯å­¦ä¹ æ¨¡æ‹Ÿå…¶çœŸå®çš„æ•°æ®åˆ†å¸ƒ $p(x)$ã€‚ä¸€æ—¦å­¦ä¹ å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥éšæ„ä»æˆ‘ä»¬çš„è¿‘ä¼¼æ¨¡å‹ä¸­ç”Ÿæˆæ–°çš„æ ·æœ¬ã€‚æ­¤å¤–ï¼Œåœ¨æŸäº›å…¬å¼åŒ–ä¸‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å­¦ä¹ åˆ°çš„æ¨¡å‹æ¥è¯„ä¼°è§‚æµ‹æˆ–é‡‡æ ·æ•°æ®çš„å¯èƒ½æ€§ã€‚

åœ¨å½“å‰æ–‡çŒ®ä¸­ï¼Œæœ‰å‡ ç§ä¼—æ‰€å‘¨çŸ¥çš„æ–¹å‘ï¼Œè¿™é‡Œåªæ˜¯ç®€è¦åœ°åœ¨é«˜å±‚æ¬¡ä¸Šä»‹ç»ã€‚ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGANsï¼‰ä»¥å¯¹æŠ—æ€§æ–¹å¼å­¦ä¹ å¤æ‚åˆ†å¸ƒçš„é‡‡æ ·è¿‡ç¨‹ã€‚å¦ä¸€ç±»è¢«ç§°ä¸ºâ€œåŸºäºä¼¼ç„¶çš„â€ç”Ÿæˆæ¨¡å‹ï¼Œå¯»æ±‚å­¦ä¹ ä¸€ä¸ªæ¨¡å‹ï¼Œä¸ºè§‚æµ‹åˆ°çš„æ•°æ®æ ·æœ¬åˆ†é…é«˜ä¼¼ç„¶ã€‚è¿™åŒ…æ‹¬è‡ªå›å½’æ¨¡å‹ã€å½’ä¸€åŒ–æµæ¨¡å‹å’Œå˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEsï¼‰ã€‚å¦ä¸€ç§ç±»ä¼¼çš„æ–¹æ³•æ˜¯åŸºäºèƒ½é‡çš„å»ºæ¨¡ï¼Œå…¶ä¸­å­¦ä¹ ä¸€ä¸ªåˆ†å¸ƒä½œä¸ºä»»æ„çµæ´»çš„èƒ½é‡å‡½æ•°ï¼Œç„¶åè¿›è¡Œå½’ä¸€åŒ–ã€‚

åˆ†æ•°ç”Ÿæˆæ¨¡å‹ä¸æ­¤å¯†åˆ‡ç›¸å…³ï¼›å®ƒä»¬ä¸æ˜¯å­¦ä¹ æ¨¡æ‹Ÿèƒ½é‡å‡½æ•°æœ¬èº«ï¼Œè€Œæ˜¯å­¦ä¹ èƒ½é‡æ¨¡å‹çš„åˆ†æ•°ä½œä¸ºç¥ç»ç½‘ç»œã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å’Œå›é¡¾æ‰©æ•£æ¨¡å‹ï¼Œæ­£å¦‚æˆ‘ä»¬å°†å±•ç¤ºçš„ï¼Œå®ƒä»¬æ—¢æœ‰åŸºäºä¼¼ç„¶çš„è§£é‡Šï¼Œä¹Ÿæœ‰åŸºäºåˆ†æ•°çš„è§£é‡Šã€‚æˆ‘ä»¬ä»¥æå…¶è¯¦å°½çš„ç»†èŠ‚å±•ç¤ºäº†è¿™äº›æ¨¡å‹èƒŒåçš„æ•°å­¦ï¼Œç›®çš„æ˜¯è®©ä»»ä½•äººéƒ½èƒ½å¤Ÿè·Ÿéšå¹¶ç†è§£æ‰©æ•£æ¨¡å‹æ˜¯ä»€ä¹ˆä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

## èƒŒæ™¯ï¼šELBOã€VAEå’Œå±‚æ¬¡VAE

å¯¹äºè®¸å¤šæ¨¡æ€ï¼Œå¯ä»¥è®¤ä¸ºè§‚å¯Ÿåˆ°çš„æ•°æ®ç”±ä¸€ä¸ªç›¸å…³çš„ä¸å¯è§æ½œåœ¨å˜é‡è¡¨ç¤ºæˆ–ç”Ÿæˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡éšæœºå˜é‡ $ z$ æ¥è¡¨ç¤ºã€‚è¡¨è¾¾è¿™ä¸€æƒ³æ³•çš„æœ€å¥½ç›´è§‰æ˜¯é€šè¿‡æŸæ‹‰å›¾çš„æ´ç©´å¯“è¨€ã€‚åœ¨å¯“è¨€ä¸­ï¼Œä¸€ç¾¤äººä¸€ç”Ÿä¸­éƒ½è¢«é”åœ¨ä¸€ä¸ªæ´ç©´é‡Œï¼Œåªèƒ½çœ‹åˆ°æŠ•å°„åœ¨ä»–ä»¬é¢å‰å¢™ä¸Šçš„äºŒç»´é˜´å½±ï¼Œè¿™äº›é˜´å½±æ˜¯ç”±åœ¨ç«å‰ç»è¿‡çš„ä¸å¯è§çš„ä¸‰ç»´ç‰©ä½“äº§ç”Ÿçš„ã€‚å¯¹äºè¿™äº›äººæ¥è¯´ï¼Œä»–ä»¬è§‚å¯Ÿåˆ°çš„ä¸€åˆ‡éƒ½æ˜¯ç”±ä»–ä»¬æ°¸è¿œæ— æ³•çœ‹åˆ°çš„æ›´é«˜ç»´åº¦çš„æŠ½è±¡æ¦‚å¿µå†³å®šçš„ã€‚

ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬åœ¨ç°å®ä¸–ç•Œä¸­é‡åˆ°çš„ç‰©ä½“ä¹Ÿå¯èƒ½æ˜¯ç”±æŸäº›æ›´é«˜å±‚æ¬¡çš„è¡¨ç¤ºç”Ÿæˆçš„ï¼›ä¾‹å¦‚ï¼Œè¿™äº›è¡¨ç¤ºå¯èƒ½å°è£…äº†é¢œè‰²ã€å¤§å°ã€å½¢çŠ¶ç­‰æŠ½è±¡å±æ€§ã€‚ç„¶åï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°çš„å¯ä»¥è¢«è§£é‡Šä¸ºè¿™äº›æŠ½è±¡æ¦‚å¿µçš„ä¸‰ç»´æŠ•å½±æˆ–å®ä¾‹åŒ–ï¼Œå°±åƒæ´ç©´å±…æ°‘è§‚å¯Ÿåˆ°çš„å®é™…ä¸Šæ˜¯ä¸‰ç»´ç‰©ä½“çš„äºŒç»´æŠ•å½±ä¸€æ ·ã€‚å°½ç®¡æ´ç©´å±…æ°‘æ°¸è¿œçœ‹ä¸åˆ°ï¼ˆç”šè‡³å®Œå…¨ç†è§£ä¸äº†ï¼‰éšè—çš„ç‰©ä½“ï¼Œä»–ä»¬ä»ç„¶å¯ä»¥æ¨ç†å¹¶æ¨æ–­å‡ºå…³äºå®ƒä»¬çš„ä¿¡æ¯ï¼›ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥è¿‘ä¼¼æ½œåœ¨è¡¨ç¤ºæ¥æè¿°æˆ‘ä»¬è§‚å¯Ÿåˆ°çš„æ•°æ®ã€‚

å°½ç®¡æŸæ‹‰å›¾çš„æ´ç©´å¯“è¨€é˜é‡Šäº†æ½œåœ¨å˜é‡ä½œä¸ºå¯èƒ½ä¸å¯è§‚å¯Ÿçš„è¡¨ç¤ºæ¥å†³å®šè§‚å¯Ÿç»“æœçš„èƒŒåæ€æƒ³ï¼Œä½†è¿™ä¸ªç±»æ¯”çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œåœ¨ç”Ÿæˆå»ºæ¨¡ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¯»æ±‚å­¦ä¹ ä½äºè§‚å¯Ÿç»´åº¦çš„æ½œåœ¨è¡¨ç¤ºï¼Œè€Œä¸æ˜¯é«˜äºè§‚å¯Ÿç»´åº¦çš„ã€‚è¿™æ˜¯å› ä¸ºè¯•å›¾å­¦ä¹ ä¸€ä¸ªæ¯”è§‚å¯Ÿç»“æœæ›´é«˜ç»´åº¦çš„è¡¨ç¤ºï¼Œæ²¡æœ‰å¼ºæœ‰åŠ›çš„å…ˆéªŒçŸ¥è¯†æ˜¯æ²¡æœ‰ç”¨çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œå­¦ä¹ ä½ç»´æ½œåœ¨å˜é‡ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§å‹ç¼©å½¢å¼ï¼Œå¹¶ä¸”æœ‰å¯èƒ½æ­ç¤ºå‡ºæè¿°è§‚å¯Ÿç»“æœçš„è¯­ä¹‰ä¸Šæœ‰æ„ä¹‰çš„ç»“æ„ã€‚

### è¯æ®ä¸‹ç•Œï¼ˆEvidence Lower Bound, ELBOï¼‰

æ•°å­¦ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡æ½œåœ¨å˜é‡å’Œæˆ‘ä»¬è§‚å¯Ÿåˆ°çš„æ•°æ®ç”±ä¸€ä¸ªè”åˆåˆ†å¸ƒ $ p(x, z)$ æ¥å»ºæ¨¡ã€‚å›æƒ³ä¸€ä¸‹ï¼Œç”Ÿæˆå»ºæ¨¡ä¸­ç§°ä¸ºâ€œåŸºäºä¼¼ç„¶çš„â€æ–¹æ³•ä¹‹ä¸€æ˜¯å­¦ä¹ ä¸€ä¸ªæ¨¡å‹æ¥æœ€å¤§åŒ–æ‰€æœ‰è§‚æµ‹åˆ°çš„ $ x$ çš„ä¼¼ç„¶ $ p(x)$ã€‚æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥æ“ä½œè¿™ä¸ªè”åˆåˆ†å¸ƒæ¥æ¢å¤æˆ‘ä»¬è§‚æµ‹æ•°æ®çš„ä¼¼ç„¶ $ p(x)$ï¼›æˆ‘ä»¬å¯ä»¥æ˜ç¡®åœ°å¯¹æ½œåœ¨å˜é‡ $ z$ è¿›è¡Œè¾¹ç¼˜åŒ–ï¼š

$$
\begin{equation}
p(\boldsymbol{x}) = \int p(\boldsymbol{x}, \boldsymbol{z})d\boldsymbol{z}
\end{equation}
$$


æˆ–è€…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ¦‚ç‡é“¾å¼æ³•åˆ™ï¼š

$$
\begin{equation}
p(\boldsymbol{x}) = \frac{p(\boldsymbol{x}, \boldsymbol{z})}{p(\boldsymbol{z}\mid\boldsymbol{x})}
\end{equation}
$$

ç›´æ¥è®¡ç®—å’Œæœ€å¤§åŒ–ä¼¼ç„¶ $ p(x)$ æ˜¯å›°éš¾çš„ï¼Œå› ä¸ºå®ƒè¦ä¹ˆæ¶‰åŠå°†æ‰€æœ‰æ½œåœ¨å˜é‡ $ z$ åœ¨å…¬å¼ (1) ä¸­ç§¯åˆ†å‡ºæ¥ï¼Œè¿™å¯¹äºå¤æ‚æ¨¡å‹æ¥è¯´æ˜¯ä¸å¯è¡Œçš„ï¼Œè¦ä¹ˆæ¶‰åŠè·å¾—çœŸå®çš„æ½œåœ¨ç¼–ç å™¨ $ p(z|x)$ åœ¨å…¬å¼ (2) ä¸­ã€‚ç„¶è€Œï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºä¸€ä¸ªç§°ä¸ºè¯æ®ä¸‹ç•Œï¼ˆELBOï¼‰çš„é¡¹ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯è¯æ®çš„ä¸€ä¸ªä¸‹ç•Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯æ®è¢«é‡åŒ–ä¸ºè§‚æµ‹æ•°æ®çš„å¯¹æ•°ä¼¼ç„¶ã€‚ç„¶åï¼Œæœ€å¤§åŒ–ELBOæˆä¸ºä¸€ä¸ªä»£ç†ç›®æ ‡ï¼Œç”¨äºä¼˜åŒ–æ½œåœ¨å˜é‡æ¨¡å‹ï¼›åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œå½“ELBOè¢«å¼ºæœ‰åŠ›åœ°å‚æ•°åŒ–å¹¶ä¸”è¢«å®Œç¾ä¼˜åŒ–æ—¶ï¼Œå®ƒä¸è¯æ®å®Œå…¨ç­‰ä»·ã€‚æ­£å¼åœ°ï¼ŒELBOçš„æ–¹ç¨‹æ˜¯ï¼š

$$
\begin{equation}
\mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]
\end{equation}
$$

ä¸ºäº†æ˜ç¡®ä¸è¯æ®çš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æ•°å­¦ä¸Šå†™ä¸ºï¼š

$$
\begin{equation}
\log p(\boldsymbol{x}) \geq \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]
\end{equation}
$$

è¿™é‡Œï¼Œ$ q_{\phi}(z|x)$ æ˜¯ä¸€ä¸ªçµæ´»çš„è¿‘ä¼¼å˜åˆ†åˆ†å¸ƒï¼Œå…¶å‚æ•° $ \phi$ æ˜¯æˆ‘ä»¬å¯»æ±‚ä¼˜åŒ–çš„ã€‚ç›´è§‚ä¸Šï¼Œå®ƒå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªå¯å‚æ•°åŒ–çš„æ¨¡å‹ï¼Œå­¦ä¹ ä¼°è®¡ç»™å®šè§‚æµ‹ $ x$ çš„æ½œåœ¨å˜é‡çš„çœŸå®åˆ†å¸ƒï¼›æ¢å¥è¯è¯´ï¼Œå®ƒå¯»æ±‚è¿‘ä¼¼çœŸå®çš„åéªŒ $ p(z|x)$ã€‚æ­£å¦‚æˆ‘ä»¬å°†åœ¨æ¢ç´¢å˜åˆ†è‡ªç¼–ç å™¨æ—¶çœ‹åˆ°çš„ï¼Œé€šè¿‡è°ƒæ•´å‚æ•° $ \phi$ æ¥å¢åŠ ä¸‹ç•Œï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®å¯ç”¨æ¥æ¨¡æ‹ŸçœŸå®æ•°æ®åˆ†å¸ƒå¹¶ä»ä¸­é‡‡æ ·çš„ç»„ä»¶ï¼Œä»è€Œå­¦ä¹ ä¸€ä¸ªç”Ÿæˆæ¨¡å‹ã€‚

### è¯æ®ä¸‹ç•Œï¼ˆELBOï¼‰çš„æ¨å¯¼

è®©æˆ‘ä»¬ä»å…¬å¼(1)å¼€å§‹æ¨å¯¼ELBOï¼š
$$
\begin{align}
\log p(\boldsymbol{x})
&= \log \int p(\boldsymbol{x}, \boldsymbol{z})d\boldsymbol{z}\\
&= \log \int \frac{p(\boldsymbol{x}, \boldsymbol{z})q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}d\boldsymbol{z}\\
&= \log \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]\\
&\geq \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log \frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]
\end{align}
$$


åœ¨è¿™ä¸ªæ¨å¯¼ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åº”ç”¨è©¹æ£®ä¸ç­‰å¼ç›´æ¥å¾—åˆ°äº†æˆ‘ä»¬çš„ä¸‹ç•Œã€‚ç„¶è€Œï¼Œè¿™å¹¶æ²¡æœ‰æä¾›å…³äºå®é™…å‘ç”Ÿçš„æƒ…å†µçš„æœ‰ç”¨ä¿¡æ¯ï¼›å…³é”®çš„æ˜¯ï¼Œè¿™ä¸ªè¯æ˜æ²¡æœ‰ç»™å‡ºä¸ºä»€ä¹ˆELBO å®é™…ä¸Šæ˜¯è¯æ®ä¸‹ç•Œçš„ç›´è§‰ï¼Œå› ä¸ºè©¹æ£®ä¸ç­‰å¼æŠŠå®ƒæ¨¡ç³Šå¤„ç†äº†ã€‚æ­¤å¤–ï¼Œä»…ä»…çŸ¥é“ELBOæ˜¯æ•°æ®çš„ä¸‹ç•Œï¼Œå¹¶æ²¡æœ‰çœŸæ­£å‘Šè¯‰æˆ‘ä»¬ä¸ºä»€ä¹ˆæˆ‘ä»¬æƒ³è¦å°†å…¶æœ€å¤§åŒ–ä½œä¸ºç›®æ ‡ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£è¯æ®å’ŒELBOä¹‹é—´çš„å…³ç³»ï¼Œè®©æˆ‘ä»¬è¿›è¡Œå¦ä¸€ä¸ªæ¨å¯¼ï¼Œè¿™æ¬¡ä½¿ç”¨å…¬å¼(2)ï¼š

$$
\begin{align}
\log p(\boldsymbol{x}) & = \log p(\boldsymbol{x}) \int q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})dz\\
          & = \int q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})\log p(\boldsymbol{x})dz\\
          & = \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log p(\boldsymbol{x})\right]\\
          & = \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{p(\boldsymbol{z}\mid\boldsymbol{x})}\right]\\
          & = \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}{p(\boldsymbol{z}\mid\boldsymbol{x})q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]\\
          & = \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right] + \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}{p(\boldsymbol{z}\mid\boldsymbol{x})}\right]\\
          & = \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right] + \mathcal{D}_{\text{KL}}(q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x}) \mid\mid p(\boldsymbol{z}\mid\boldsymbol{x})) \\
          & \geq \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]
\end{align}
$$


ä»è¿™ä¸ªæ¨å¯¼ä¸­ï¼Œæˆ‘ä»¬æ¸…æ¥šåœ°ä»å…¬å¼(15)è§‚å¯Ÿåˆ°è¯æ®ç­‰äºELBOåŠ ä¸Šè¿‘ä¼¼åéªŒ $ q_{\phi}(z|x)$ å’ŒçœŸå®åéªŒ $ p(z|x)$ ä¹‹é—´çš„KLæ•£åº¦ã€‚å®é™…ä¸Šï¼Œæ­£æ˜¯è¿™ä¸ªKLæ•£åº¦é¡¹åœ¨ç¬¬ä¸€ä¸ªæ¨å¯¼çš„å…¬å¼(8)ä¸­é€šè¿‡è©¹æ£®ä¸ç­‰å¼è¢«ç¥å¥‡åœ°ç§»é™¤äº†ã€‚ç†è§£è¿™ä¸ªé¡¹æ˜¯ç†è§£ELBOå’Œè¯æ®ä¹‹é—´å…³ç³»çš„å…³é”®ï¼Œä¹Ÿæ˜¯ç†è§£ä¸ºä»€ä¹ˆä¼˜åŒ–ELBOæ˜¯ä¸€ä¸ªåˆé€‚çš„ç›®æ ‡çš„åŸå› ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆELBOç¡®å®æ˜¯ä¸€ä¸ªä¸‹ç•Œï¼š

> è¯æ®å’ŒELBOä¹‹é—´çš„å·®å¼‚æ˜¯ä¸€ä¸ªä¸¥æ ¼éè´Ÿçš„KLé¡¹ï¼Œå› æ­¤ELBOçš„å€¼æ°¸è¿œä¸èƒ½è¶…è¿‡è¯æ®ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬æ¢è®¨ä¸ºä»€ä¹ˆå¯»æ±‚æœ€å¤§åŒ–ELBOã€‚

> å¼•å…¥äº†æˆ‘ä»¬æƒ³è¦å»ºæ¨¡çš„æ½œåœ¨å˜é‡ $ z$ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å­¦ä¹ æè¿°æˆ‘ä»¬è§‚æµ‹æ•°æ®çš„æ½œåœ¨ç»“æ„ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æƒ³è¦ä¼˜åŒ–æˆ‘ä»¬çš„å˜åˆ†åéªŒ $ q_{\phi}(z|x)$ çš„å‚æ•°ï¼Œä»¥ä¾¿å®ƒå®Œå…¨åŒ¹é…çœŸå®çš„åéªŒåˆ†å¸ƒ $ p(z|x)$ï¼Œè¿™é€šè¿‡æœ€å°åŒ–å®ƒä»¬çš„KLæ•£åº¦ï¼ˆç†æƒ³æƒ…å†µä¸‹ä¸ºé›¶ï¼‰æ¥å®ç°ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç›´æ¥æœ€å°åŒ–è¿™ä¸ªKLæ•£åº¦é¡¹æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è®¿é—®çœŸå®çš„ $ p(z|x)$ åˆ†å¸ƒã€‚ä½†æ˜¯ï¼Œè¯·è§‚å¯Ÿï¼Œåœ¨å…¬å¼(15)çš„å·¦ä¾§ï¼Œæˆ‘ä»¬æ•°æ®çš„ä¼¼ç„¶æ€§ï¼ˆå› æ­¤æˆ‘ä»¬çš„è¯æ®é¡¹ $ \log p(x)$ï¼‰ç›¸å¯¹äº $ \phi$ æ€»æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œå› ä¸ºå®ƒæ˜¯é€šè¿‡ä»è”åˆåˆ†å¸ƒ $ p(x, z)$ ä¸­è¾¹ç¼˜åŒ–æ‰€æœ‰æ½œåœ¨ $ z$ æ¥è®¡ç®—çš„ï¼Œæ ¹æœ¬ä¸ä¾èµ–äº $ \phi$ã€‚ç”±äºELBOå’ŒKLæ•£åº¦é¡¹åŠ èµ·æ¥æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œå¯¹ELBOé¡¹çš„ä»»ä½•æœ€å¤§åŒ–éƒ½å¿…ç„¶å¼•èµ·KLæ•£åº¦é¡¹çš„ç­‰é‡æœ€å°åŒ–ã€‚å› æ­¤ï¼ŒELBOå¯ä»¥ä½œä¸ºä¸€ä¸ªä»£ç†ç›®æ ‡æ¥æœ€å¤§åŒ–ï¼Œä½œä¸ºå­¦ä¹ å¦‚ä½•å®Œç¾åœ°æ¨¡æ‹ŸçœŸå®æ½œåœ¨åéªŒåˆ†å¸ƒçš„ä»£ç†ï¼›æˆ‘ä»¬è¶Šä¼˜åŒ–ELBOï¼Œæˆ‘ä»¬çš„è¿‘ä¼¼åéªŒå°±è¶Šæ¥è¿‘çœŸå®åéªŒã€‚æ­¤å¤–ï¼Œä¸€æ—¦è®­ç»ƒå®Œæˆï¼ŒELBOè¿˜å¯ä»¥ç”¨æ¥ä¼°è®¡è§‚æµ‹æˆ–ç”Ÿæˆæ•°æ®çš„å¯èƒ½æ€§ï¼Œå› ä¸ºå®ƒè¢«å­¦ä¹ æ¥è¿‘ä¼¼æ¨¡å‹è¯æ® $ \log p(x)$ã€‚

### å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVariational Autoencodersï¼‰

åœ¨å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰çš„é»˜è®¤å…¬å¼ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥æœ€å¤§åŒ–è¯æ®ä¸‹ç•Œï¼ˆELBOï¼‰ã€‚è¿™ç§æ–¹æ³•æ˜¯å˜åˆ†çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç”± $\phi$ å‚æ•°åŒ–çš„æ½œåœ¨åéªŒåˆ†å¸ƒæ—ä¸­ä¼˜åŒ–æœ€ä½³çš„ $ q_{\phi}(z|x)$ã€‚å®ƒè¢«ç§°ä¸ºè‡ªç¼–ç å™¨ï¼Œå› ä¸ºå®ƒè®©äººæƒ³èµ·ä¼ ç»Ÿçš„è‡ªç¼–ç å™¨æ¨¡å‹ï¼Œå…¶ä¸­è¾“å…¥æ•°æ®è¢«è®­ç»ƒåœ¨ç»å†ä¸€ä¸ªä¸­é—´ç“¶é¢ˆè¡¨ç¤ºæ­¥éª¤åè¿›è¡Œé¢„æµ‹ã€‚ä¸ºäº†æ˜ç¡®è¿™ç§è”ç³»ï¼Œè®©æˆ‘ä»¬è¿›ä¸€æ­¥å‰–æELBOé¡¹ï¼š
$$
\begin{align}
\mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{x}, \boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]
&= \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z})p(\boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]\\
&= \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z})\right] + \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log\frac{p(\boldsymbol{z})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\right]\\
&= \underbrace{\mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z})\right]}_\text{reconstruction term} - \underbrace{\mathcal{D}_{\text{KL}}(q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x}) \mid\mid p(\boldsymbol{z}))}_\text{prior matching term}
\end{align}
$$

åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä¸€ä¸ªä¸­é—´ç“¶é¢ˆåˆ†å¸ƒ $ q_{\phi}(z|x)$ï¼Œå®ƒå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªç¼–ç å™¨ï¼›å°†è¾“å…¥è½¬æ¢ä¸ºå¯èƒ½çš„æ½œåœ¨åˆ†å¸ƒã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä¸€ä¸ªç¡®å®šæ€§å‡½æ•° $ p_{\theta}(x|z)$ å°†ç»™å®šçš„æ½œåœ¨å‘é‡ $ z$ è½¬æ¢ä¸ºè§‚æµ‹ $ x$ï¼Œè¿™å¯ä»¥è¢«è§£é‡Šä¸ºè§£ç å™¨ã€‚


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/vae.webp" alt="Visualizing a Variational Autoencoder" style="zoom:33%;" />
</div>


> å¯è§†åŒ–æ™®é€šå˜åˆ†è‡ªåŠ¨ç¼–ç å™¨ã€‚é€šè¿‡é‡å‚æ•°åŒ–æŠ€å·§è”åˆå­¦ä¹ æ½œåœ¨ç¼–ç å™¨å’Œè§£ç å™¨ [6, 7]

æ–¹ç¨‹(19)ä¸­çš„ä¸¤é¡¹å„è‡ªæœ‰ç›´è§‚çš„æè¿°ï¼š

- ç¬¬ä¸€é¡¹æµ‹é‡äº†ä»æˆ‘ä»¬çš„å˜åˆ†åˆ†å¸ƒä¸­è§£ç å™¨çš„é‡å»ºä¼¼ç„¶æ€§ï¼›è¿™ç¡®ä¿äº†å­¦ä¹ åˆ°çš„åˆ†å¸ƒæ˜¯æ¨¡æ‹Ÿæœ‰æ•ˆçš„æ½œåœ¨ï¼ŒåŸå§‹æ•°æ®å¯ä»¥ä»ä¸­å†ç”Ÿã€‚
- ç¬¬äºŒé¡¹æµ‹é‡äº†å­¦ä¹ åˆ°çš„å˜åˆ†åˆ†å¸ƒä¸æˆ‘ä»¬å¯¹æ½œåœ¨å˜é‡æŒæœ‰çš„å…ˆéªŒä¿¡å¿µçš„ç›¸ä¼¼æ€§ã€‚æœ€å°åŒ–è¿™ä¸ªé¡¹é¼“åŠ±ç¼–ç å™¨å®é™…å­¦ä¹ ä¸€ä¸ªåˆ†å¸ƒï¼Œè€Œä¸æ˜¯å¡Œç¼©æˆä¸€ä¸ªç‹„æ‹‰å…‹Î´å‡½æ•°ã€‚å› æ­¤ï¼Œæœ€å¤§åŒ–ELBOç­‰åŒäºæœ€å¤§åŒ–å…¶ç¬¬ä¸€é¡¹å¹¶æœ€å°åŒ–å…¶ç¬¬äºŒé¡¹ã€‚

VAEçš„ä¸€ä¸ªå†³å®šæ€§ç‰¹å¾æ˜¯ELBOæ˜¯å¦‚ä½•è”åˆä¼˜åŒ–å‚æ•°$\phi$å’ŒÎ¸ã€‚VAEçš„ç¼–ç å™¨é€šå¸¸é€‰æ‹©ä¸ºå…·æœ‰å¯¹è§’çº¿åæ–¹å·®çš„å¤šå…ƒé«˜æ–¯åˆ†å¸ƒï¼Œè€Œå…ˆéªŒé€šå¸¸é€‰æ‹©ä¸ºæ ‡å‡†å¤šå…ƒé«˜æ–¯åˆ†å¸ƒï¼š

$$
\begin{align}
    q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x}) &= \mathcal{N}(\boldsymbol{z}; \boldsymbol{\mu}_{\boldsymbol{\phi}}(\boldsymbol{x}), \boldsymbol{\sigma}_{\boldsymbol{\phi}}^2(\boldsymbol{x})\textbf{I})\\
    p(\boldsymbol{z}) &= \mathcal{N}(\boldsymbol{z}; \boldsymbol{0}, \textbf{I})
\end{align}
$$


ç„¶åï¼ŒELBOä¸­çš„KLæ•£åº¦é¡¹å¯ä»¥è¢«è§£æè®¡ç®—ï¼Œè€Œé‡å»ºé¡¹å¯ä»¥ä½¿ç”¨è’™ç‰¹å¡æ´›ä¼°è®¡æ¥è¿‘ä¼¼ã€‚æˆ‘ä»¬çš„ç›®æ ‡å¯ä»¥è¢«é‡å†™ä¸ºï¼š
$$
\begin{align}
& \quad \,\underset{\boldsymbol{\phi}, \boldsymbol{\theta}}{\arg\max}\, \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x})}\left[\log p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z})\right] - \mathcal{D}_{\text{KL}}(q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x}) \mid\mid p(\boldsymbol{z})) \nonumber \\
& \approx \underset{\boldsymbol{\phi}, \boldsymbol{\theta}}{\arg\max}\, \sum_{l=1}^{L}\log p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z}^{(l)}) - \mathcal{D}_{\text{KL}}(q_{\boldsymbol{\phi}}(\boldsymbol{z}\mid\boldsymbol{x}) \mid\mid p(\boldsymbol{z}))
\end{align}
$$

å…¶ä¸­æ½œåœ¨å˜é‡ $ \{z^{(l)}\}^{L}_{l=1}$ æ˜¯ä» $ q_{\phi}(z|x)$ ä¸­é‡‡æ ·çš„ï¼Œå¯¹äºæ•°æ®é›†ä¸­çš„æ¯ä¸ªè§‚æµ‹ $ x$ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªé»˜è®¤è®¾ç½®ä¸­å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬è®¡ç®—æŸå¤±çš„æ¯ä¸ª $ z^{(l)}$ éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªéšæœºé‡‡æ ·è¿‡ç¨‹ç”Ÿæˆçš„ï¼Œè¿™é€šå¸¸æ˜¯ä¸å¯å¾®åˆ†çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œå½“ $ q_{\phi}(z|x)$ è¢«è®¾è®¡ä¸ºæ¨¡æ‹ŸæŸäº›åˆ†å¸ƒï¼ˆåŒ…æ‹¬å¤šå…ƒé«˜æ–¯åˆ†å¸ƒï¼‰æ—¶ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡é‡å‚æ•°åŒ–æŠ€å·§æ¥è§£å†³ã€‚

é‡å‚æ•°åŒ–æŠ€å·§å°†ä¸€ä¸ªéšæœºå˜é‡é‡å†™ä¸ºä¸€ä¸ªå™ªå£°å˜é‡çš„ç¡®å®šæ€§å‡½æ•°ï¼›è¿™å…è®¸é€šè¿‡æ¢¯åº¦ä¸‹é™æ¥ä¼˜åŒ–ééšæœºé¡¹ã€‚ä¾‹å¦‚ï¼Œä»æ­£æ€åˆ†å¸ƒ $ x \sim \mathcal{N}(x; \mu, \sigma^2)$ ä¸­é‡‡æ ·çš„éšæœºå˜é‡ï¼Œå…¶ä¸­ $ \mu$ æ˜¯ä»»æ„çš„å‡å€¼ï¼Œ$ \sigma^2$ æ˜¯æ–¹å·®ï¼Œå¯ä»¥è¢«é‡å†™ä¸ºï¼š

$$
\begin{align*}
    x &= \mu + \sigma\epsilon \quad \text{with } \epsilon \sim \mathcal{N}(\epsilon; 0, \text{I})
\end{align*}
$$

æ¢å¥è¯è¯´ï¼Œä»»æ„çš„é«˜æ–¯åˆ†å¸ƒå¯ä»¥è¢«è§£é‡Šä¸ºæ ‡å‡†é«˜æ–¯ï¼ˆå…¶ä¸­ $ \epsilon$ æ˜¯ä¸€ä¸ªæ ·æœ¬ï¼‰ï¼Œé€šè¿‡æ·»åŠ å°†å‡å€¼ä»é›¶ç§»åŠ¨åˆ°ç›®æ ‡å‡å€¼ $ \mu$ï¼Œä»¥åŠé€šè¿‡ç›®æ ‡æ–¹å·® $ \sigma^2$ æ‹‰ä¼¸æ–¹å·®ã€‚å› æ­¤ï¼Œé€šè¿‡é‡å‚æ•°åŒ–æŠ€å·§ï¼Œä»ä»»æ„é«˜æ–¯åˆ†å¸ƒä¸­é‡‡æ ·å¯ä»¥é€šè¿‡ä»æ ‡å‡†é«˜æ–¯ä¸­é‡‡æ ·ï¼Œå°†ç»“æœä¹˜ä»¥ç›®æ ‡æ ‡å‡†å·®ï¼Œç„¶åé€šè¿‡ç›®æ ‡å‡å€¼è¿›è¡Œå¹³ç§»æ¥æ‰§è¡Œã€‚

åœ¨VAEä¸­ï¼Œæ¯ä¸ª $ z$ è¢«è®¡ç®—ä¸ºè¾“å…¥ $ x$ å’Œè¾…åŠ©å™ªå£°å˜é‡ $ \epsilon$ çš„ç¡®å®šæ€§å‡½æ•°ï¼š

$$
\begin{align*}
    \boldsymbol{z} &= \boldsymbol{\mu}_{\boldsymbol{\phi}}(\boldsymbol{x}) + \boldsymbol{\sigma}_{\boldsymbol{\phi}}(\boldsymbol{x})\odot\boldsymbol{\epsilon} \quad \text{with } \boldsymbol{\epsilon} \sim \mathcal{N}(\boldsymbol{\epsilon};\boldsymbol{0}, \textbf{I})
\end{align*}
$$

å…¶ä¸­ $ \odot$ è¡¨ç¤ºé€å…ƒç´ ä¹˜ç§¯ã€‚åœ¨é‡å‚æ•°åŒ–çš„ $ z$ ç‰ˆæœ¬ä¸‹ï¼Œæ¢¯åº¦å¯ä»¥ç›¸å¯¹äº $ \phi$ è®¡ç®—ï¼Œä»¥ä¼˜åŒ– $ \mu_{\phi}$ å’Œ $ \sigma_{\phi}$ã€‚å› æ­¤ï¼ŒVAEåˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§å’Œè’™ç‰¹å¡æ´›ä¼°è®¡è”åˆä¼˜åŒ–ELBOã€‚

è®­ç»ƒå®ŒVAEåï¼Œå¯ä»¥é€šè¿‡ä»æ½œåœ¨ç©ºé—´ $ p(z)$ ä¸­é‡‡æ ·ï¼Œç„¶åå°†å…¶é€šè¿‡è§£ç å™¨æ¥ç”Ÿæˆæ–°æ•°æ®ã€‚å½“æ½œåœ¨å˜é‡ $ z$ çš„ç»´åº¦å°äºè¾“å…¥ $ x$ çš„ç»´åº¦æ—¶ï¼Œå˜åˆ†è‡ªç¼–ç å™¨ç‰¹åˆ«æœ‰è¶£ï¼Œå› ä¸ºé‚£æ—¶æˆ‘ä»¬å¯èƒ½æ­£åœ¨å­¦ä¹ ç´§å‡‘ã€æœ‰ç”¨çš„è¡¨ç¤ºã€‚æ­¤å¤–ï¼Œå½“å­¦ä¹ åˆ°ä¸€ä¸ªè¯­ä¹‰ä¸Šæœ‰æ„ä¹‰çš„æ½œåœ¨ç©ºé—´æ—¶ï¼Œæ½œåœ¨å‘é‡å¯ä»¥åœ¨ä¼ é€’ç»™è§£ç å™¨ä¹‹å‰è¿›è¡Œç¼–è¾‘ï¼Œä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶ç”Ÿæˆçš„æ•°æ®ã€‚

### å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆHierarchical Variational Autoencodersï¼‰

å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆHVAEï¼‰æ˜¯å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰çš„æ³›åŒ–ï¼Œå®ƒæ‰©å±•åˆ°æ½œåœ¨å˜é‡çš„å¤šä¸ªå±‚æ¬¡ã€‚åœ¨è¿™ä¸ªæ¡†æ¶ä¸‹ï¼Œæ½œåœ¨å˜é‡æœ¬èº«è¢«è§†ä¸ºç”±å…¶ä»–æ›´é«˜çº§åˆ«çš„ã€æ›´æŠ½è±¡çš„æ½œåœ¨å˜é‡ç”Ÿæˆçš„ã€‚ç›´è§‚åœ°è¯´ï¼Œå°±åƒæˆ‘ä»¬å°†è‡ªå·±çš„ä¸‰ç»´è§‚å¯Ÿå¯¹è±¡è§†ä¸ºç”±æ›´é«˜çº§åˆ«çš„æŠ½è±¡æ½œåœ¨å˜é‡ç”Ÿæˆçš„ä¸€æ ·ï¼ŒæŸæ‹‰å›¾æ´ç©´ä¸­çš„äººå°†ä¸‰ç»´å¯¹è±¡è§†ä¸ºç”±ä»–ä»¬çš„äºŒç»´è§‚å¯Ÿç»“æœç”Ÿæˆçš„æ½œåœ¨å˜é‡ã€‚å› æ­¤ï¼Œä»æŸæ‹‰å›¾æ´ç©´å±…æ°‘çš„è§†è§’æ¥çœ‹ï¼Œä»–ä»¬çš„è§‚å¯Ÿå¯ä»¥è¢«è§†ä¸ºç”±ä¸¤ä¸ªæˆ–æ›´å¤šå±‚æ¬¡çš„æ½œåœ¨å±‚æ¬¡ç»“æ„å»ºæ¨¡ã€‚

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/hvae.webp" alt="Visualizing a Hierarchical VAE" style="zoom:50%;" />
</div>



> é©¬å°”å¯å¤«åˆ†å±‚å˜åˆ†è‡ªåŠ¨ç¼–ç å™¨ã€‚ç”Ÿæˆè¿‡ç¨‹è¢«å»ºæ¨¡ä¸ºé©¬å°”å¯å¤«é“¾ï¼Œå…¶ä¸­æ¯ä¸ªæ½œåœ¨å˜é‡ä»…ä»å‰ä¸€ä¸ªæ½œåœ¨å˜é‡ç”Ÿæˆã€‚

åœ¨ä¸€èˆ¬çš„HVAEä¸­ï¼Œæ¯ä¸ªæ½œåœ¨å˜é‡è¢«å…è®¸ä¾èµ–äºä¹‹å‰æ‰€æœ‰çš„æ½œåœ¨å˜é‡ã€‚ç„¶è€Œï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯ä¸€ä¸ªç‰¹æ®Šæ¡ˆä¾‹ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé©¬å°”å¯å¤«å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆMHVAEï¼‰ã€‚åœ¨MHVAEä¸­ï¼Œç”Ÿæˆè¿‡ç¨‹æ˜¯ä¸€ä¸ªé©¬å°”å¯å¤«é“¾ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå±‚æ¬¡å‘ä¸‹çš„è½¬æ¢éƒ½æ˜¯é©¬å°”å¯å¤«çš„ï¼Œå…¶ä¸­è§£ç æ¯ä¸ªæ½œåœ¨å˜é‡ $ z_t$ ä»…ä¾èµ–äºå‰ä¸€ä¸ªæ½œåœ¨å˜é‡ $ z_{t+1}$ã€‚ç›´è§‚ä¸Šï¼Œè¿™å¯ä»¥ç®€å•åœ°çœ‹ä½œæ˜¯åœ¨å½¼æ­¤ä¹‹ä¸Šå †å VAEï¼Œå¦‚å›¾2æ‰€ç¤ºï¼›æè¿°è¿™ä¸ªæ¨¡å‹çš„å¦ä¸€ä¸ªæ°å½“çš„æœ¯è¯­æ˜¯é€’å½’VAEã€‚æ•°å­¦ä¸Šï¼Œæˆ‘ä»¬è¡¨ç¤ºé©¬å°”å¯å¤«HVAEçš„è”åˆåˆ†å¸ƒå’ŒåéªŒå¦‚ä¸‹ï¼š
$$
\begin{align}
    p(\boldsymbol{x}, \boldsymbol{z}_{1:T}) &= p(\boldsymbol{z}_T)p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z}_1)\prod_{t=2}^{T}p_{\boldsymbol{\theta}}(\boldsymbol{z}_{t-1}\mid\boldsymbol{z}_{t})
\end{align}
$$


ä»–çš„åéªŒè¡¨ç¤ºä¸ºï¼š
$$
\begin{align}
    q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x}) &= q_{\boldsymbol{\phi}}(\boldsymbol{z}_1\mid\boldsymbol{x})\prod_{t=2}^{T}q_{\boldsymbol{\phi}}(\boldsymbol{z}_{t}\mid\boldsymbol{z}_{t-1})
\end{align}
$$


ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å°†ELBOæ‰©å±•ä¸ºï¼š
$$
\begin{align}
\log p(\boldsymbol{x}) &= \log \int p(\boldsymbol{x}, \boldsymbol{z}_{1:T}) d\boldsymbol{z}_{1:T}\\
&= \log \int \frac{p(\boldsymbol{x}, \boldsymbol{z}_{1:T})q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})} d\boldsymbol{z}_{1:T}\\
&= \log \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\left[\frac{p(\boldsymbol{x}, \boldsymbol{z}_{1:T})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\right]\\
&\geq \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\left[\log \frac{p(\boldsymbol{x}, \boldsymbol{z}_{1:T})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\right]
\end{align}
$$


ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„è”åˆåˆ†å¸ƒï¼ˆå…¬å¼(23)ï¼‰å’ŒåéªŒï¼ˆå…¬å¼(24)ï¼‰ä»£å…¥å…¬å¼(28)ï¼Œå¾—åˆ°ä¸€ä¸ªæ›¿ä»£å½¢å¼ï¼š

$$
\begin{align}
\mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\left[\log \frac{p(\boldsymbol{x}, \boldsymbol{z}_{1:T})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\right]
&= \mathbb{E}_{q_{\boldsymbol{\phi}}(\boldsymbol{z}_{1:T}\mid\boldsymbol{x})}\left[\log \frac{p(\boldsymbol{z}_T)p_{\boldsymbol{\theta}}(\boldsymbol{x}\mid\boldsymbol{z}_1)\prod_{t=2}^{T}p_{\boldsymbol{\theta}}(\boldsymbol{z}_{t-1}\mid\boldsymbol{z}_{t})}{q_{\boldsymbol{\phi}}(\boldsymbol{z}_1\mid\boldsymbol{x})\prod_{t=2}^{T}q_{\boldsymbol{\phi}}(\boldsymbol{z}_{t}\mid\boldsymbol{z}_{t-1})}\right]
\end{align}
$$
æ­£å¦‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢æ¢è®¨å˜åˆ†æ‰©æ•£æ¨¡å‹æ—¶æ‰€ç¤ºï¼Œè¿™ä¸ªç›®æ ‡å¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸ºå¯è§£é‡Šçš„ç»„æˆéƒ¨åˆ†ã€‚



## å˜åˆ†æ‰©æ•£æ¨¡å‹ï¼ˆVariational Diffusion Modelsï¼‰

å˜åˆ†æ‰©æ•£æ¨¡å‹ï¼ˆVDMï¼‰å¯ä»¥ç®€å•åœ°çœ‹ä½œæ˜¯ä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªå…³é”®é™åˆ¶çš„é©¬å°”å¯å¤«å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆMarkovian Hierarchical Variational Autoencoder, MHVAEï¼‰ï¼š

1. æ½œåœ¨ç»´åº¦å®Œå…¨ç­‰äºæ•°æ®ç»´åº¦ã€‚
2. æ¯ä¸ªæ—¶é—´æ­¥çš„æ½œåœ¨ç¼–ç å™¨çš„ç»“æ„ä¸æ˜¯å­¦ä¹ å¾—åˆ°çš„ï¼›å®ƒè¢«é¢„å®šä¹‰ä¸ºçº¿æ€§é«˜æ–¯æ¨¡å‹ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯ä»¥å‰ä¸€æ—¶é—´æ­¥çš„è¾“å‡ºä¸ºä¸­å¿ƒçš„é«˜æ–¯åˆ†å¸ƒã€‚
3. æ½œåœ¨ç¼–ç å™¨çš„é«˜æ–¯å‚æ•°éšæ—¶é—´å˜åŒ–ï¼Œä½¿å¾—æœ€ç»ˆæ—¶é—´æ­¥Tçš„æ½œåœ¨åˆ†å¸ƒæ˜¯æ ‡å‡†é«˜æ–¯åˆ†å¸ƒã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬æ˜ç¡®ä¿æŒäº†ä»æ ‡å‡†é©¬å°”å¯å¤«å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ç»§æ‰¿çš„å±‚æ¬¡è½¬æ¢ä¹‹é—´çš„é©¬å°”å¯å¤«æ€§è´¨ã€‚

è®©æˆ‘ä»¬å±•å¼€è¿™äº›å‡è®¾çš„å«ä¹‰ã€‚ä»ç¬¬ä¸€ä¸ªé™åˆ¶å¼€å§‹ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å°†çœŸå®çš„æ•°æ®æ ·æœ¬å’Œæ½œåœ¨å˜é‡è¡¨ç¤ºä¸º $ x_t$ï¼Œå…¶ä¸­ $ t = 0$ è¡¨ç¤ºçœŸå®çš„æ•°æ®æ ·æœ¬ï¼Œ$ t \in [1, T]$ è¡¨ç¤ºå…·æœ‰å±‚æ¬¡ç´¢å¼• $t$ çš„ç›¸åº”æ½œåœ¨å˜é‡ã€‚VDMçš„åéªŒä¸MHVAEçš„åéªŒç›¸åŒï¼ˆå…¬å¼24ï¼‰ï¼Œä½†ç°åœ¨å¯ä»¥é‡å†™ä¸ºï¼š

$$
\begin{align}
    q(\boldsymbol{x}_{1:T}\mid\boldsymbol{x}_0) = \prod_{t = 1}^{T}q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_{t-1})
\end{align}
$$
æ ¹æ®ç¬¬äºŒä¸ªå‡è®¾ï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªæ½œåœ¨å˜é‡åœ¨ç¼–ç å™¨ä¸­çš„åˆ†å¸ƒæ˜¯ä¸€ä¸ªä»¥å®ƒå‰ä¸€ä¸ªå±‚æ¬¡æ½œåœ¨å˜é‡ä¸ºä¸­å¿ƒçš„é«˜æ–¯åˆ†å¸ƒã€‚ä¸MHVAEä¸åŒï¼Œåœ¨VDMä¸­ï¼Œæ¯ä¸ªæ—¶é—´æ­¥ $t$ çš„ç¼–ç å™¨çš„ç»“æ„ä¸æ˜¯å­¦ä¹ å¾—åˆ°çš„ï¼›å®ƒè¢«å›ºå®šä¸ºçº¿æ€§é«˜æ–¯æ¨¡å‹ï¼Œå…¶ä¸­å‡å€¼å’Œæ ‡å‡†å·®å¯ä»¥é¢„å…ˆè®¾ç½®ä¸ºè¶…å‚æ•°ï¼Œæˆ–è€…ä½œä¸ºå‚æ•°å­¦ä¹ ã€‚æˆ‘ä»¬ç”¨å‡å€¼ $ \mu_t(x_t) = \sqrt{\alpha_t} x_{t-1}$ å’Œæ–¹å·® $ \Sigma_t(x_t) = (1 - \alpha_t)I$ æ¥å‚æ•°åŒ–é«˜æ–¯ç¼–ç å™¨ï¼Œå…¶ä¸­ç³»æ•°çš„å½¢å¼è¢«é€‰æ‹©ä»¥ä¿æŒæ½œåœ¨å˜é‡çš„æ–¹å·®åœ¨ç›¸ä¼¼çš„å°ºåº¦ä¸Šï¼›æ¢å¥è¯è¯´ï¼Œç¼–ç è¿‡ç¨‹æ˜¯æ–¹å·®ä¿æŒçš„ã€‚è§‚å¯Ÿï¼Œå…è®¸ä½¿ç”¨å…¶ä»–é«˜æ–¯å‚æ•°åŒ–ï¼Œå¹¶ä¸”ä¼šå¯¼è‡´ç±»ä¼¼çš„æ¨å¯¼ã€‚ä¸»è¦çš„æ”¶è·æ˜¯ $ \alpha_t$ æ˜¯ä¸€ä¸ªï¼ˆå¯èƒ½æ˜¯å¯å­¦ä¹ çš„ï¼‰ç³»æ•°ï¼Œå®ƒå¯ä»¥æ ¹æ®å±‚æ¬¡æ·±åº¦ $t$ å˜åŒ–ï¼Œä»¥ä¿æŒçµæ´»æ€§ã€‚æ•°å­¦ä¸Šï¼Œç¼–ç å™¨è½¬æ¢è¡¨ç¤ºä¸ºï¼š

$$
\begin{align}
    q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_{t-1}) = \mathcal{N}(\boldsymbol{x}_{t} ; \sqrt{\alpha_t} \boldsymbol{x}_{t-1}, (1 - \alpha_t) \textbf{I})
\end{align}
$$


ä»ç¬¬ä¸‰ä¸ªå‡è®¾ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ $ \alpha_t$ æŒ‰ç…§å›ºå®šæˆ–å¯å­¦ä¹ çš„æ—¶é—´è¡¨éšæ—¶é—´æ¼”å˜ï¼Œä½¿å¾—æœ€ç»ˆæ½œåœ¨çš„åˆ†å¸ƒ $ p(x_T)$ æ˜¯æ ‡å‡†é«˜æ–¯åˆ†å¸ƒã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°é©¬å°”å¯å¤«HVAEçš„è”åˆåˆ†å¸ƒï¼ˆå…¬å¼23ï¼‰æ¥å†™å‡ºVDMçš„è”åˆåˆ†å¸ƒï¼š

$$
\begin{align}
p(\boldsymbol{x}_{0:T}) &= p(\boldsymbol{x}_T)\prod_{t=1}^{T}p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t) \\
\text{where,}&\nonumber\\
p(\boldsymbol{x}_T) &= \mathcal{N}(\boldsymbol{x}_T; \boldsymbol{0}, \textbf{I})
\end{align}
$$
æ€»çš„æ¥è¯´ï¼Œè¿™ç»„å‡è®¾æè¿°äº†å›¾åƒè¾“å…¥éšæ—¶é—´é€æ­¥å™ªå£°åŒ–çš„è¿‡ç¨‹ï¼›æˆ‘ä»¬é€šè¿‡é€æ­¥æ·»åŠ é«˜æ–¯å™ªå£°é€æ¸ç ´åä¸€ä¸ªå›¾åƒï¼Œç›´åˆ°æœ€ç»ˆå®ƒå®Œå…¨å˜æˆçº¯é«˜æ–¯å™ªå£°ã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨å›¾3ä¸­ä»¥è§†è§‰æ–¹å¼å‘ˆç°ã€‚

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/vdm_base.webp" alt="Visualizing a Variational Diffusion Model" style="zoom:50%;" />
</div>



> å˜åˆ†æ‰©æ•£æ¨¡å‹çš„è§†è§‰è¡¨ç¤ºã€‚è¾“å…¥éšç€æ—¶é—´çš„æ¨ç§»ç¨³å®šåœ°äº§ç”Ÿå™ªå£°ï¼Œç›´åˆ°å®ƒå˜å¾—ä¸é«˜æ–¯å™ªå£°ç›¸åŒï¼›æ‰©æ•£æ¨¡å‹å­¦ä¹ é€†å‘è¿™ä¸ªè¿‡ç¨‹ã€‚

è¯·è§‚å¯Ÿï¼Œæˆ‘ä»¬çš„ç¼–ç å™¨åˆ†å¸ƒ $ q(x_t | x_{t-1})$ å·²ç»ä¸å†ç”± $\phi$ å‚æ•°åŒ–ï¼Œå› ä¸ºå®ƒä»¬å®Œå…¨è¢«å»ºæ¨¡ä¸ºå…·æœ‰å®šä¹‰çš„å‡å€¼å’Œæ–¹å·®å‚æ•°çš„é«˜æ–¯åˆ†å¸ƒã€‚å› æ­¤ï¼Œåœ¨VDMä¸­ï¼Œæˆ‘ä»¬åªå¯¹å­¦ä¹ æ¡ä»¶åˆ†å¸ƒ $ p_{\theta}(x_{t-1} | x_t)$ æ„Ÿå…´è¶£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¨¡æ‹Ÿæ–°æ•°æ®ã€‚åœ¨ä¼˜åŒ–VDMä¹‹åï¼Œé‡‡æ ·è¿‡ç¨‹å°±åƒä» $ p(x_T)$ ä¸­é‡‡æ ·é«˜æ–¯å™ªå£°ï¼Œç„¶åè¿­ä»£åœ°è¿è¡Œå»å™ªè½¬æ¢ $ p_{\theta}(x_{t-1} | x_t)$ è¿›è¡Œ $T $ æ­¥æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ $ x_0$ã€‚

åƒä»»ä½•HVAEä¸€æ ·ï¼ŒVDMå¯ä»¥é€šè¿‡æœ€å¤§åŒ–ELBOæ¥ä¼˜åŒ–ï¼Œå®ƒå¯ä»¥è¢«æ¨å¯¼ä¸ºï¼š
$$
\begin{align}
\log p(\boldsymbol{x})
&\geq \mathbb{E}_{q(\boldsymbol{x}_{1:T}\mid\boldsymbol{x}_0)}\left[\log \frac{p(\boldsymbol{x}_{0:T})}{q(\boldsymbol{x}_{1:T}\mid\boldsymbol{x}_0)}\right] \\
&=  \begin{aligned}[t]
      \underbrace{\mathbb{E}_{q(\boldsymbol{x}_{1}\mid\boldsymbol{x}_0)}\left[\log p_{\theta}(\boldsymbol{x}_0\mid\boldsymbol{x}_1)\right]}_\text{reconstruction term} &- \underbrace{\mathbb{E}_{q(\boldsymbol{x}_{T-1}\mid\boldsymbol{x}_0)}\left[\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_T\mid\boldsymbol{x}_{T-1}) \mid\mid p(\boldsymbol{x}_T))\right]}_\text{prior matching term} \\
      &- \sum_{t=1}^{T-1}\underbrace{\mathbb{E}_{q(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t+1}\mid\boldsymbol{x}_0)}\left[\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_t\mid\boldsymbol{x}_{t-1}) \mid\mid p_{\theta}(\boldsymbol{x}_{t}\mid\boldsymbol{x}_{t+1}))\right]}_\text{consistency term}
    \end{aligned}
\end{align}
$$

è¯æ˜è¿‡ç¨‹å¦‚ä¸‹ï¼š


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/first_deriv_verbose.svg" alt="Deriving the ELBO of a VDM in terms of Consistency terms" style="zoom:50%;" />
</div>



è¿™ä¸ªæ¨å¯¼å½¢å¼çš„ELBOå¯ä»¥è§£é‡Šä¸ºå…¶å„ä¸ªç»„æˆéƒ¨åˆ†çš„å«ä¹‰ï¼š

1. $ \mathbb{E}_{q(x_1|x_0)} \left[ \log p_{\theta}(x_0 | x_1) \right]$ å¯ä»¥è¢«è§£é‡Šä¸ºä¸€ä¸ªé‡å»ºé¡¹ï¼Œé¢„æµ‹ç»™å®šç¬¬ä¸€æ­¥æ½œåœ¨æ ·æœ¬çš„åŸå§‹æ•°æ®æ ·æœ¬çš„å¯¹æ•°æ¦‚ç‡ã€‚è¿™ä¸ªæœ¯è¯­ä¹Ÿå‡ºç°åœ¨æ ‡å‡†VAEçš„ELBOä¸­ï¼Œå¯ä»¥ç±»ä¼¼åœ°è¿›è¡Œè®­ç»ƒã€‚

2. $ \mathbb{E}_{q(x_{T-1}|x_0)} \left[ \text{KL}(q(x_T | x_{T-1}) \| p(x_T)) \right]$ æ˜¯ä¸€ä¸ªå…ˆéªŒåŒ¹é…é¡¹ï¼›å½“æœ€ç»ˆæ½œåœ¨åˆ†å¸ƒåŒ¹é…é«˜æ–¯å…ˆéªŒæ—¶ï¼Œå®ƒè¢«æœ€å°åŒ–ã€‚è¿™ä¸ªæœ¯è¯­ä¸éœ€è¦ä¼˜åŒ–ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å¯è®­ç»ƒçš„å‚æ•°ï¼›æ­¤å¤–ï¼Œç”±äºæˆ‘ä»¬å‡è®¾äº†ä¸€ä¸ªè¶³å¤Ÿå¤§çš„Tï¼Œä½¿å¾—æœ€ç»ˆåˆ†å¸ƒæ˜¯é«˜æ–¯çš„ï¼Œè¿™ä¸ªæœ¯è¯­å®é™…ä¸Šå˜æˆäº†é›¶ã€‚

3. $ \sum_{t=1}^{T-1} \mathbb{E}_{q(x_{t-1}, x_t, x_{t+1} | x_0)} \left[ \text{KL}(q(x_t | x_{t-1}) \| p_{\theta}(x_t | x_{t+1})) \right]$ æ˜¯ä¸€ä¸ªä¸€è‡´æ€§é¡¹ï¼›å®ƒåŠªåŠ›ä½¿ $ x_t$ çš„åˆ†å¸ƒåœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¿æŒä¸€è‡´ï¼Œå³ä»æ›´å™ªå£°çš„å›¾åƒåˆ°æ›´æ¸…æ™°çš„å›¾åƒçš„å»å™ªæ­¥éª¤å’Œä»æ›´æ¸…æ™°çš„å›¾åƒåˆ°æ›´å™ªå£°çš„å›¾åƒçš„åŠ å™ªæ­¥éª¤ã€‚è¿™ç§ä¸€è‡´æ€§åœ¨æ•°å­¦ä¸Šé€šè¿‡KLæ•£åº¦åæ˜ å‡ºæ¥ã€‚å½“ä¸¤ä¸ªå»å™ªæ­¥éª¤å°½å¯èƒ½åŒ¹é…æ—¶ï¼Œè¿™ä¸ªæœ¯è¯­è¢«æœ€å°åŒ–ï¼Œå¦‚å…¬å¼31ä¸­å®šä¹‰çš„é«˜æ–¯åˆ†å¸ƒ $ q(x_t | x_{t-1})$ã€‚

åœ¨å›¾4ä¸­ï¼Œæˆ‘ä»¬ä»¥è§†è§‰æ–¹å¼è§£é‡Šäº†ELBOçš„è¿™ç§è§£é‡Šï¼›å¯¹äºæ¯ä¸ªä¸­é—´çš„ $ x_t$ï¼Œæˆ‘ä»¬æœ€å°åŒ–ç”±ç²‰è‰²å’Œç»¿è‰²ç®­å¤´è¡¨ç¤ºçš„åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ã€‚åœ¨å®Œæ•´çš„å›¾ä¸­ï¼Œæ¯æ¡ç²‰è‰²ç®­å¤´ä¹Ÿå¿…é¡»ä» $ x_0$ å¼€å§‹ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¡ä»¶é¡¹ã€‚


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/first_derivation.webp" alt="Deriving the ELBO of a VDM in terms of Consistency terms" style="zoom:50%;" />
</div>


> å¯ä»¥é€šè¿‡ç¡®ä¿å¯¹äºæ¯ä¸ªä¸­é—´æ½œåœ¨å˜é‡ï¼Œå…¶ä¸Šæ–¹æ½œåœ¨å˜é‡çš„åéªŒä¸å…¶ä¹‹å‰çš„æ½œåœ¨å˜é‡çš„é«˜æ–¯æŸåç›¸åŒ¹é…æ¥ä¼˜åŒ– VDMã€‚ åœ¨æ­¤å›¾ä¸­ï¼Œå¯¹äºæ¯ä¸ªä¸­é—´æ½œåœ¨å˜é‡ï¼Œæˆ‘ä»¬æœ€å°åŒ–ç²‰è‰²å’Œç»¿è‰²ç®­å¤´è¡¨ç¤ºçš„åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ã€‚

åœ¨è¿™ç§æ¨å¯¼ä¸‹ï¼ŒELBOçš„æ‰€æœ‰é¡¹éƒ½è¢«è®¡ç®—ä¸ºæœŸæœ›ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨è’™ç‰¹å¡æ´›ä¼°è®¡æ¥è¿‘ä¼¼ã€‚ç„¶è€Œï¼Œå®é™…ä¸Šä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ¨å¯¼å‡ºçš„é¡¹æ¥ä¼˜åŒ–ELBOå¯èƒ½æ˜¯æ¬¡ä¼˜çš„ï¼›å› ä¸ºä¸€è‡´æ€§é¡¹æ˜¯ä½œä¸ºä¸¤ä¸ªéšæœºå˜é‡ $ \{x_{t-1}, x_{t+1}\}$ çš„æœŸæœ›æ¥è®¡ç®—çš„ï¼Œå¯¹äºæ¯ä¸ªæ—¶é—´æ­¥ï¼Œå®ƒçš„è’™ç‰¹å¡æ´›ä¼°è®¡çš„æ–¹å·®å¯èƒ½ä¼šæ¯”ä½¿ç”¨æ¯ä¸ªæ—¶é—´æ­¥ä¸€ä¸ªéšæœºå˜é‡ä¼°è®¡çš„é¡¹æ›´é«˜ã€‚ç”±äºå®ƒæ˜¯é€šè¿‡å¯¹ $ T-1$ ä¸ªä¸€è‡´æ€§é¡¹æ±‚å’Œæ¥è®¡ç®—çš„ï¼Œå¯¹äºå¤§çš„ $ T$ å€¼ï¼ŒELBOçš„æœ€ç»ˆä¼°è®¡å€¼å¯èƒ½å…·æœ‰é«˜æ–¹å·®ã€‚

è®©æˆ‘ä»¬å°è¯•æ¨å¯¼å‡ºä¸€ä¸ªELBOçš„å½¢å¼ï¼Œå…¶ä¸­æ¯ä¸ªé¡¹éƒ½æ˜¯å¯¹æœ€å¤šä¸€ä¸ªéšæœºå˜é‡çš„æœŸæœ›ã€‚å…³é”®çš„æ´å¯Ÿæ˜¯æˆ‘ä»¬å¯ä»¥é‡å†™ç¼–ç å™¨è½¬æ¢ä¸º $ q(x_t | x_{t-1}) = q(x_t | x_{t-1}, x_0)$ï¼Œå…¶ä¸­é¢å¤–çš„æ¡ä»¶é¡¹ç”±äºé©¬å°”å¯å¤«æ€§è´¨è€Œå˜å¾—å¤šä½™ã€‚ç„¶åï¼Œæ ¹æ®è´å¶æ–¯è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªè½¬æ¢é‡å†™ä¸ºï¼š

$$
\begin{align}
q(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}, \boldsymbol{x}_0) = \frac{q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0)q(\boldsymbol{x}_t\mid\boldsymbol{x}_0)}{q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_0)}
\end{align}
$$


åˆ©ç”¨è¿™ä¸ªæ–°æ–¹ç¨‹ï¼ŒELBO å¯ä»¥æ¨å¯¼å‡ºä¸ºä»¥ä¸‹å½¢å¼ï¼š

$$
\begin{align}
\log p(\boldsymbol{x})
&\geq \mathbb{E}_{q(\boldsymbol{x}_{1:T}\mid\boldsymbol{x}_0)}\left[\log \frac{p(\boldsymbol{x}_{0:T})}{q(\boldsymbol{x}_{1:T}\mid\boldsymbol{x}_0)}\right]\\
&=  \begin{aligned}[t]
      \underbrace{\mathbb{E}_{q(\boldsymbol{x}_{1}\mid\boldsymbol{x}_0)}\left[\log p_{\boldsymbol{\theta}}(\boldsymbol{x}_0\mid\boldsymbol{x}_1)\right]}_\text{reconstruction term} &- \underbrace{\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_T\mid\boldsymbol{x}_0) \mid\mid p(\boldsymbol{x}_T))}_\text{prior matching term} \\
      &- \sum_{t=2}^{T} \underbrace{\mathbb{E}_{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\left[\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t))\right]}_\text{denoising matching term}
    \end{aligned}
\end{align}
$$

è¯æ˜å¦‚ä¸‹ï¼š

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/second_deriv_verbose.svg" alt="æ ¹æ®å»å™ªåŒ¹é…é¡¹æ¨å¯¼ VDM çš„ ELBO" style="zoom:100%;" />
</div>



å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ°æ¨å¯¼å‡ºäº†ELBOçš„ä¸€ä¸ªè§£é‡Šï¼Œå®ƒå¯ä»¥è¢«ä¼°è®¡ä¸ºè¾ƒä½çš„æ–¹å·®ï¼Œå› ä¸ºæ¯ä¸ªé¡¹éƒ½æ˜¯å¯¹æœ€å¤šä¸€ä¸ªéšæœºå˜é‡çš„æœŸæœ›ã€‚è¿™ç§å…¬å¼ä¹Ÿå…·æœ‰ä¼˜é›…çš„è§£é‡Šï¼Œå½“æ£€æŸ¥æ¯ä¸ªå•ç‹¬çš„é¡¹æ—¶ï¼Œå¯ä»¥æ­ç¤ºå‡ºæ¥ï¼š

1. $ \mathbb{E}_{q(x_1 | x_0)} \left[ \log p_{\theta}(x_0 | x_1) \right]$ å¯ä»¥è¢«è§£é‡Šä¸ºä¸€ä¸ªé‡å»ºé¡¹ï¼›åƒVAEçš„ELBOä¸­çš„ç±»ä¼¼é¡¹ä¸€æ ·ï¼Œè¿™ä¸ªé¡¹å¯ä»¥ä½¿ç”¨è’™ç‰¹å¡æ´›ä¼°è®¡æ¥è¿‘ä¼¼å’Œä¼˜åŒ–ã€‚

2. $ \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_T\mid\boldsymbol{x}_0) \mid\mid p(\boldsymbol{x}_T)) $ è¡¨ç¤ºæœ€ç»ˆå™ªå£°è¾“å…¥çš„åˆ†å¸ƒä¸æ ‡å‡†é«˜æ–¯å…ˆéªŒæœ‰å¤šæ¥è¿‘ã€‚å®ƒæ²¡æœ‰å¯è®­ç»ƒçš„å‚æ•°ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬çš„å‡è®¾ä¸‹ä¹Ÿç­‰äºé›¶ã€‚

3. $ \mathbb{E}_{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\left[\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t))\right]$ æ˜¯ä¸€ä¸ªå»å™ªåŒ¹é…é¡¹ã€‚æˆ‘ä»¬å­¦ä¹ æœŸæœ›çš„å»å™ªè½¬æ¢æ­¥éª¤ $ p_{\theta}(x_{t-1} | x_t)$ ä½œä¸ºå¯å¤„ç†çš„ã€çœŸå®çš„å»å™ªè½¬æ¢æ­¥éª¤ $ q(x_{t-1} | x_t, x_0)$ çš„è¿‘ä¼¼ã€‚ $ q(x_{t-1} | x_t, x_0)$ è½¬æ¢æ­¥éª¤å¯ä»¥ä½œä¸ºçœŸå®çš„ä¿¡å·ï¼Œå› ä¸ºå®ƒå®šä¹‰äº†å¦‚ä½•ä½¿ç”¨æœ€ç»ˆå®Œå…¨å»å™ªçš„å›¾åƒ $ x_0$ æ¥å»å™ªå™ªå£°å›¾åƒ $ x_t$ã€‚å› æ­¤ï¼Œå½“ä¸¤ä¸ªå»å™ªæ­¥éª¤å°½å¯èƒ½åŒ¹é…æ—¶ï¼Œè¿™ä¸ªæœ¯è¯­è¢«æœ€å°åŒ–ï¼Œå¦‚é€šè¿‡å®ƒä»¬ä¹‹é—´çš„KLæ•£åº¦æ¥è¡¡é‡ã€‚

ä¸‹å›¾æè¿°äº†æ­¤ ELBO åˆ†è§£çš„ç›´è§‚è§£é‡Šï¼š


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/second_derivation.webp" alt="Deriving the ELBO of a VDM in terms of Denoising Matching terms" style="zoom:50%;" />
</div>


> VDM è¿˜å¯ä»¥é€šè¿‡å­¦ä¹ æ¯ä¸ªæ½œåœ¨ä¸ªä½“çš„å»å™ªæ­¥éª¤æ¥ä¼˜åŒ–ï¼Œæ–¹æ³•æ˜¯å°†å…¶ä¸æ˜“äºè®¡ç®—çš„åœ°é¢å®å†µå»å™ªæ­¥éª¤ç›¸åŒ¹é…ã€‚ è¿™å†æ¬¡é€šè¿‡å°†ç»¿è‰²ç®­å¤´è¡¨ç¤ºçš„åˆ†å¸ƒä¸ç²‰è‰²ç®­å¤´è¡¨ç¤ºçš„åˆ†å¸ƒç›¸åŒ¹é…æ¥ç›´è§‚åœ°è¡¨ç¤ºã€‚ è‰ºæœ¯è‡ªç”±åœ¨è¿™é‡Œå‘æŒ¥ä½œç”¨ï¼› åœ¨å®Œæ•´çš„å›¾ç‰‡ä¸­ï¼Œæ¯ä¸ªç²‰çº¢è‰²ç®­å¤´ä¹Ÿå¿…é¡»æ¥è‡ªçœŸå®å›¾åƒï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¡ä»¶é¡¹ã€‚

ä½œä¸ºæ—æ³¨ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œåœ¨ELBOçš„æ¨å¯¼è¿‡ç¨‹ä¸­ï¼Œåªä½¿ç”¨äº†é©¬å°”å¯å¤«å‡è®¾ï¼›å› æ­¤ï¼Œè¿™äº›å…¬å¼å¯¹äºä»»ä½•ä»»æ„çš„é©¬å°”å¯å¤«HVAEéƒ½æ˜¯æˆç«‹çš„ã€‚æ­¤å¤–ï¼Œå½“æˆ‘ä»¬è®¾ç½® $ T = 1$ æ—¶ï¼ŒVDMçš„ä¸¤ä¸ªELBOè§£é‡Šå¯¹äºæ ‡å‡†VAEçš„ELBOå…¬å¼ï¼ˆå…¬å¼19ï¼‰æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚

åœ¨è¿™ç§ELBOçš„æ¨å¯¼ä¸­ï¼Œå¤§éƒ¨åˆ†ä¼˜åŒ–æˆæœ¬å†æ¬¡ç”±æ±‚å’Œé¡¹å æ®ï¼Œå®ƒæ”¯é…äº†é‡å»ºé¡¹ã€‚è™½ç„¶æ¯ä¸ªKLæ•£åº¦é¡¹ $ \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t))$ å¯¹äºä»»æ„å¤æ‚çš„é©¬å°”å¯å¤«HVAEsä¸­çš„ä»»æ„åéªŒæ¥è¯´éƒ½æ˜¯éš¾ä»¥æœ€å°åŒ–çš„ï¼Œå› ä¸ºåŒæ—¶å­¦ä¹ ç¼–ç å™¨çš„å¤æ‚æ€§å¢åŠ äº†ï¼Œä½†åœ¨å˜åˆ†æ‰©æ•£æ¨¡å‹ï¼ˆVDMï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨é«˜æ–¯è½¬æ¢å‡è®¾æ¥ä½¿ä¼˜åŒ–å˜å¾—å¯è¡Œã€‚é€šè¿‡è´å¶æ–¯è§„åˆ™ï¼Œæˆ‘ä»¬æœ‰ï¼š
$$
q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) = \frac{q(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}, \boldsymbol{x}_0)q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_0)}{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}
$$



ç”±äºæˆ‘ä»¬å·²ç»çŸ¥é“ $ q(x_t|x_{t-1}, x_0) = q(x_t|x_{t-1}) = \mathcal{N}(x_t; \sqrt{\alpha_t} x_{t-1}, (1 - \alpha_t)I) $ æ ¹æ®æˆ‘ä»¬å¯¹ç¼–ç å™¨è½¬æ¢çš„å‡è®¾ï¼ˆå…¬å¼31ï¼‰ï¼Œå‰©ä¸‹çš„çš„å·¥ä½œæ˜¯æ¨å¯¼å‡º $ q(x_t|x_0) $ å’Œ $ q(x_{t-1}|x_0) $ çš„å½¢å¼ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™äº›ä¹Ÿé€šè¿‡åˆ©ç”¨VDMçš„ç¼–ç å™¨è½¬æ¢æ˜¯çº¿æ€§é«˜æ–¯æ¨¡å‹è¿™ä¸€äº‹å®è€Œå˜å¾—å¯è¡Œã€‚å›æƒ³ä¸€ä¸‹ï¼Œåœ¨é‡æ–°å‚æ•°åŒ–æŠ€å·§ä¸‹ï¼Œæ ·æœ¬ $ x_t \sim q(x_t|x_{t-1}) $ å¯ä»¥è¢«é‡å†™ä¸ºï¼š
$$
\begin{align}
    \boldsymbol{x}_t = \sqrt{\alpha_t}\boldsymbol{x}_{t-1} + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon} \quad \text{with } \boldsymbol{\epsilon} \sim \mathcal{N}(\boldsymbol{\epsilon}; \boldsymbol{0}, \textbf{I})
\end{align}
$$


ç±»ä¼¼åœ°ï¼Œæ ·æœ¬ $ x_{t-1} \sim q(x_{t-1}|x_{t-2}) $ å¯ä»¥è¢«é‡å†™ä¸ºï¼š
$$
\begin{align}
    \boldsymbol{x}_{t-1} = \sqrt{\alpha_{t-1}}\boldsymbol{x}_{t-2} + \sqrt{1 - \alpha_{t-1}}\boldsymbol{\epsilon} \quad \text{with } \boldsymbol{\epsilon} \sim \mathcal{N}(\boldsymbol{\epsilon}; \boldsymbol{0}, \textbf{I})
\end{align}
$$
ç„¶åï¼Œ$ q(x_t|x_0) $ çš„å½¢å¼å¯ä»¥é€šè¿‡é‡å¤åº”ç”¨é‡æ–°å‚æ•°åŒ–æŠ€å·§æ¥é€’å½’æ¨å¯¼å‡ºæ¥ã€‚å‡è®¾æˆ‘ä»¬æœ‰ $ 2T $ ä¸ªéšæœºå™ªå£°å˜é‡ $\{\boldsymbol{\epsilon}_t^*,\boldsymbol{\epsilon}_t\}_{t=0}^T \stackrel{\text{iid}}{\sim} \mathcal{N}(\boldsymbol{\epsilon}; \boldsymbol{0},\textbf{I})$ã€‚é‚£ä¹ˆï¼Œå¯¹äºä»»æ„æ ·æœ¬ $ x_t \sim q(x_t|x_0) $ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™å®ƒä¸ºï¼š
$$
\begin{align}
\boldsymbol{x}_t  &= \sqrt{\alpha_t}\boldsymbol{x}_{t-1} + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1}^*\\
&= \sqrt{\alpha_t}\left(\sqrt{\alpha_{t-1}}\boldsymbol{x}_{t-2} + \sqrt{1 - \alpha_{t-1}}\boldsymbol{\epsilon}_{t-2}^*\right) + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1}^*\\
&= \sqrt{\alpha_t\alpha_{t-1}}\boldsymbol{x}_{t-2} + \sqrt{\alpha_t - \alpha_t\alpha_{t-1}}\boldsymbol{\epsilon}_{t-2}^* + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1}^*\\
&= \sqrt{\alpha_t\alpha_{t-1}}\boldsymbol{x}_{t-2} + \sqrt{\sqrt{\alpha_t - \alpha_t\alpha_{t-1}}^2 + \sqrt{1 - \alpha_t}^2}\boldsymbol{\epsilon}_{t-2} \\
&= \sqrt{\alpha_t\alpha_{t-1}}\boldsymbol{x}_{t-2} + \sqrt{\alpha_t - \alpha_t\alpha_{t-1} + 1 - \alpha_t}\boldsymbol{\epsilon}_{t-2}\\
&= \sqrt{\alpha_t\alpha_{t-1}}\boldsymbol{x}_{t-2} + \sqrt{1 - \alpha_t\alpha_{t-1}}\boldsymbol{\epsilon}_{t-2} \\
&= \ldots\\
&= \sqrt{\prod_{i=1}^t\alpha_i}\boldsymbol{x}_0 + \sqrt{1 - \prod_{i=1}^t\alpha_i}\boldsymbol{\boldsymbol{\epsilon}}_0\\
&= \sqrt{\bar\alpha_t}\boldsymbol{x}_0 + \sqrt{1 - \bar\alpha_t}\boldsymbol{\boldsymbol{\epsilon}}_0 \\
&\sim \mathcal{N}(\boldsymbol{x}_{t} ; \sqrt{\bar\alpha_t}\boldsymbol{x}_0, \left(1 - \bar\alpha_t\right)\textbf{I})
\end{align}
$$


å…¶ä¸­åœ¨å…¬å¼44ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†ä¸¤ä¸ªç‹¬ç«‹çš„é«˜æ–¯éšæœºå˜é‡ä¹‹å’Œä»ç„¶æ˜¯é«˜æ–¯åˆ†å¸ƒçš„äº‹å®ï¼Œå…¶å‡å€¼ä¸ºä¸¤ä¸ªå‡å€¼ä¹‹å’Œï¼Œæ–¹å·®ä¸ºä¸¤ä¸ªæ–¹å·®ä¹‹å’Œã€‚å°† $ \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1}^*$ è§£é‡Šä¸ºä»é«˜æ–¯ $ \mathcal{N}(0, (1 - \alpha_t)I) $ ä¸­æŠ½å–çš„æ ·æœ¬ï¼Œä»¥åŠ $\sqrt{\alpha_t - \alpha_t\alpha_{t-1}}\boldsymbol{\epsilon}_{t-2}^*$ è§£é‡Šä¸ºä»é«˜æ–¯ $ \mathcal{N}(0, (\alpha_t - \alpha_t \alpha_{t-1})I) $ ä¸­æŠ½å–çš„æ ·æœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬çš„å’Œè§†ä¸ºä»é«˜æ–¯ $ \mathcal{N}(0, (1 - \alpha_t \alpha_{t-1})I) $ ä¸­æŠ½å–çš„éšæœºå˜é‡$\mathcal{N}(\boldsymbol{0}, (1 - \alpha_t + \alpha_t - \alpha_t\alpha_{t-1})\textbf{I}) = \mathcal{N}(\boldsymbol{0}, (1 - \alpha_t\alpha_{t-1})\textbf{I})$ã€‚è¿™ä¸ªåˆ†å¸ƒçš„æ ·æœ¬å¯ä»¥ä½¿ç”¨é‡å‚æ•°åŒ–æŠ€å·§è¡¨ç¤ºä¸º $\sqrt{1 - \alpha_t\alpha_{t-1}}\boldsymbol{\epsilon}_{t-2}$ï¼Œå¦‚å…¬å¼46æ‰€ç¤ºã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ¨å¯¼å‡ºäº† $ q(x_t|x_0) $ çš„é«˜æ–¯å½¢å¼ã€‚è¿™ä¸ªæ¨å¯¼å¯ä»¥ä¿®æ”¹å¾—åˆ°æè¿° $ q(x_{t-1}|x_0) $ çš„é«˜æ–¯å‚æ•°åŒ–ã€‚ç°åœ¨ï¼ŒçŸ¥é“äº† $ q(x_t|x_0) $ å’Œ $ q(x_{t-1}|x_0) $ çš„å½¢å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å®ƒä»¬ä»£å…¥è´å¶æ–¯è§„åˆ™æ‰©å±•æ¥è®¡ç®— $ q(x_{t-1}|x_t, x_0) $ çš„å½¢å¼ï¼š

$$
\begin{align}
q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0)
&= \frac{q(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}, \boldsymbol{x}_0)q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_0)}{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\\
&= \frac{\mathcal{N}(\boldsymbol{x}_{t} ; \sqrt{\alpha_t} \boldsymbol{x}_{t-1}, (1 - \alpha_t)\textbf{I})\mathcal{N}(\boldsymbol{x}_{t-1} ; \sqrt{\bar\alpha_{t-1}}\boldsymbol{x}_0, (1 - \bar\alpha_{t-1}) \textbf{I})}{\mathcal{N}(\boldsymbol{x}_{t} ; \sqrt{\bar\alpha_{t}}\boldsymbol{x}_0, (1 - \bar\alpha_{t})\textbf{I})}\\
&\propto \mathcal{N}(\boldsymbol{x}_{t-1} ; \underbrace{\frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})\boldsymbol{x}_{t} + \sqrt{\bar\alpha_{t-1}}(1-\alpha_t)\boldsymbol{x}_0}{1 -\bar\alpha_{t}}}_{\mu_q(\boldsymbol{x}_t, \boldsymbol{x}_0)}, \underbrace{\frac{(1 - \alpha_t)(1 - \bar\alpha_{t-1})}{1 -\bar\alpha_{t}}\textbf{I}}_{\boldsymbol{\Sigma}_q(t)})
\end{align}
$$

è¯æ˜å¦‚ä¸‹ï¼š

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/noise_distribution_deriv.svg" alt="æ¨å¯¼æ¯ä¸ªä¸­é—´å™ªå£°æ½œä¼çš„åˆ†å¸ƒ" style="zoom:100%;" />
</div>


å…¶ä¸­åœ¨ç¬¬5è¡Œä¸­ï¼Œ$ C(x_t, x_0) $ æ˜¯ä¸€ä¸ªå…³äº $ x_{t-1} $ çš„å¸¸æ•°é¡¹ï¼Œå®ƒæ˜¯ $ x_t, x_0 $ å’Œ $ \alpha $ å€¼çš„ç»„åˆï¼›è¯¥é¡¹åœ¨æœ€åä¸€è¡Œä¸­éšå¼è¿”å›ä»¥å®Œæˆå¹³æ–¹ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»å±•ç¤ºäº†åœ¨æ¯ä¸€æ­¥ï¼Œ$ x_{t-1} \sim q(x_{t-1}|x_t, x_0) $ éƒ½æ˜¯æ­£æ€åˆ†å¸ƒçš„ï¼Œå…¶å‡å€¼ $ \mu_{q}(x_t, x_0) $ æ˜¯ $x_t $ å’Œ $ x_0 $ çš„å‡½æ•°ï¼Œæ–¹å·® $ \Sigma_{q}(t) $ æ˜¯ $ \alpha $ ç³»æ•°çš„å‡½æ•°ã€‚è¿™äº› $ \alpha $ ç³»æ•°åœ¨æ¯ä¸ªæ—¶é—´æ­¥æ˜¯å·²çŸ¥å¹¶å›ºå®šçš„ï¼›å®ƒä»¬è¦ä¹ˆè¢«æ°¸ä¹…åœ°è®¾ç½®ä¸ºè¶…å‚æ•°ï¼Œè¦ä¹ˆè¢«è§†ä¸ºå½“å‰æ¨ç†è¾“å‡ºï¼Œç”±ä¸€ä¸ªæ—¨åœ¨æ¨¡æ‹Ÿå®ƒä»¬çš„ç½‘ç»œæ¥å¤„ç†ã€‚æ ¹æ®å…¬å¼53ï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„æ–¹å·®æ–¹ç¨‹é‡å†™ä¸º $ \Sigma_{q}(t) = \sigma^2_{q}(t) I $ï¼Œå…¶ä¸­ï¼š

$$
\begin{align}
    \sigma_q^2(t) = \frac{(1 - \alpha_t)(1 - \bar\alpha_{t-1})}{1 -\bar\alpha_{t}}
\end{align}
$$


ä¸ºäº†å°½å¯èƒ½åœ°å°†è¿‘ä¼¼å»å™ªè½¬æ¢æ­¥éª¤ $ p_{\theta}(x_{t-1}|x_t) $ ä¸çœŸå®å»å™ªè½¬æ¢æ­¥éª¤ $ q(x_{t-1}|x_t, x_0) $ ç›¸åŒ¹é…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶å»ºæ¨¡ä¸ºé«˜æ–¯åˆ†å¸ƒã€‚æ­¤å¤–ï¼Œç”±äºæ‰€æœ‰çš„ $ \alpha $ é¡¹åœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½æ˜¯å·²çŸ¥å¹¶å›ºå®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³æ„é€ è¿‘ä¼¼å»å™ªè½¬æ¢æ­¥éª¤çš„æ–¹å·®ä¸º $ \Sigma_{q}(t) = \sigma^2_{q}(t) I $ã€‚æˆ‘ä»¬å¿…é¡»å°†å‡å€¼ $ \mu_{\theta}(x_t, t) $ å‚æ•°åŒ–ä¸º $x_t $ çš„å‡½æ•°ï¼Œå› ä¸º $ p_{\theta}(x_{t-1}|x_t) $ ä¸ä¾èµ–äº $ x_0 $ã€‚

å›æƒ³ä¸€ä¸‹ï¼Œä¸¤ä¸ªé«˜æ–¯åˆ†å¸ƒä¹‹é—´çš„KLæ•£åº¦æ˜¯ï¼š

$$
\begin{align}
\mathcal{D}_{\text{KL}}(\mathcal{N}(\boldsymbol{x}; \boldsymbol{\mu}_x,\boldsymbol{\Sigma}_x) \mid\mid \mathcal{N}(\boldsymbol{y}; \boldsymbol{\mu}_y,\boldsymbol{\Sigma}_y))
&=\frac{1}{2}\left[\log\frac{\mid\boldsymbol{\Sigma}_y\mid}{\mid\boldsymbol{\Sigma}_x\mid} - d + \text{tr}(\boldsymbol{\Sigma}_y^{-1}\boldsymbol{\Sigma}_x) + (\boldsymbol{\mu}_y-\boldsymbol{\mu}_x)^T \boldsymbol{\Sigma}_y^{-1} (\boldsymbol{\mu}_y-\boldsymbol{\mu}_x)\right]
\end{align}
$$


åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸¤ä¸ªé«˜æ–¯çš„æ–¹å·®è®¾ç½®ä¸ºå®Œå…¨åŒ¹é…ï¼Œä¼˜åŒ–KLæ•£åº¦é¡¹ç®€åŒ–ä¸ºæœ€å°åŒ–ä¸¤ä¸ªåˆ†å¸ƒçš„å‡å€¼ä¹‹é—´çš„å·®å¼‚ï¼š
$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}}{\arg\min}\,  \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t)) \nonumber \\
&= \underset{\boldsymbol{\theta}}{\arg\min}\, \mathcal{D}_{\text{KL}}\left(\mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_q,\boldsymbol{\Sigma}_q\left(t\right)\right) \mid\mid \mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_{\boldsymbol{\theta}},\boldsymbol{\Sigma}_q\left(t\right)\right)\right)\\
&=\underset{\boldsymbol{\theta}}{\arg\min}\, \frac{1}{2\sigma_q^2(t)}\left[\left\lVert\boldsymbol{\mu}_{\boldsymbol{\theta}}-\boldsymbol{\mu}_q\right\rVert_2^2\right]
\end{align}
$$

è¯æ˜å¦‚ä¸‹ï¼š


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/kl_gaussian_deriv.svg" alt="æ¨å¯¼ä¸¤ä¸ªé«˜æ–¯å‡½æ•°ä¹‹é—´çš„ KL" style="zoom:100%;" />
</div>



åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å°† $ \mu_{q} $ ç®€å†™ä¸º $ \mu_{q}(x_t, x_0) $ï¼Œå°† $ \mu_{\theta} $ ç®€å†™ä¸º $ \mu_{\theta}(x_t, t) $ï¼Œä»¥ä¾¿äºä¹¦å†™ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æƒ³è¦ä¼˜åŒ–ä¸€ä¸ª $ \mu_{\theta}(x_t, t) $ æ¥åŒ¹é… $ \mu_{q}(x_t, x_0) $ï¼Œå®ƒä»æˆ‘ä»¬æ¨å¯¼å‡ºçš„å…¬å¼53ä¸­å–çš„å½¢å¼ä¸ºï¼š
$$
\begin{align}
    \boldsymbol{\mu}_q(\boldsymbol{x}_t, \boldsymbol{x}_0) = \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})\boldsymbol{x}_{t} + \sqrt{\bar\alpha_{t-1}}(1-\alpha_t)\boldsymbol{x}_0}{1 -\bar\alpha_{t}}
\end{align}
$$


ç”±äº $ \mu_{\theta}(x_t, t) $ ä¹Ÿä¾èµ–äº $x_t $ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å…¶è®¾ç½®ä¸ºä»¥ä¸‹å½¢å¼æ¥å¯†åˆ‡åŒ¹é… $ \mu_{q}(x_t, x0) $ï¼š

$$
\begin{align}
    \boldsymbol{\mu}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) = \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})\boldsymbol{x}_{t} + \sqrt{\bar\alpha_{t-1}}(1-\alpha_t)\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t)}{1 -\bar\alpha_{t}}
\end{align}
$$


å…¶ä¸­ $ \hat{x}_{\theta}(x_t, t) $ æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œå®ƒçš„ç›®æ ‡æ˜¯ä»å™ªå£°å›¾åƒ $x_t $ å’Œæ—¶é—´ç´¢å¼• $ t $ é¢„æµ‹åŸå§‹å›¾åƒ $ x_0 $ã€‚ç„¶åï¼Œä¼˜åŒ–é—®é¢˜ç®€åŒ–ä¸ºï¼š
$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}}{\arg\min}\,  \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t)) \nonumber \\
&= \underset{\boldsymbol{\theta}}{\arg\min}\, \mathcal{D}_{\text{KL}}\left(\mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_q,\boldsymbol{\Sigma}_q\left(t\right)\right) \mid\mid \mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_{\boldsymbol{\theta}},\boldsymbol{\Sigma}_q\left(t\right)\right)\right)\\
&=\underset{\boldsymbol{\theta}}{\arg\min}\, \frac{1}{2\sigma_q^2(t)}\frac{\bar\alpha_{t-1}(1-\alpha_t)^2}{(1 -\bar\alpha_{t})^2}\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right]
\end{align}
$$

è¯æ˜å¦‚ä¸‹ï¼š

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/image_objective.svg" alt="æ¨å¯¼å›¾åƒé¢„æµ‹ç›®æ ‡" style="zoom:100%;" />
</div>

å› æ­¤ï¼Œä¼˜åŒ–ä¸€ä¸ªVDMå½’ç»“ä¸ºå­¦ä¹ ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥é¢„æµ‹ä»»æ„å™ªå£°ç‰ˆæœ¬çš„åŸå§‹å›¾åƒ $ x_0 $ã€‚æ­¤å¤–ï¼Œé€šè¿‡åœ¨æ‰€æœ‰å™ªå£°æ°´å¹³ä¸Šæœ€å°åŒ–æˆ‘ä»¬æ¨å¯¼å‡ºçš„ELBOç›®æ ‡çš„æ±‚å’Œé¡¹ï¼ˆå…¬å¼38ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨æ—¶é—´æ­¥çš„éšæœºæ ·æœ¬æ¥è¿‘ä¼¼ã€‚ç„¶åå¯ä»¥ä½¿ç”¨éšæ—¶é—´æ­¥é•¿çš„éšæœºæ ·æœ¬è¿›è¡Œä¼˜åŒ–ã€‚
$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}}{\arg\min}\, \sum_{t=2}^{T} \mathbb{E}_{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\left[\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t))\right] \nonumber \\
&= \underset{\boldsymbol{\theta}}{\arg\min}\, \mathbb{E}_{t\sim U\{2, T\}}\left[\mathbb{E}_{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\left[ \frac{1}{2\sigma_q^2(t)}\frac{\bar\alpha_{t-1}(1-\alpha_t)^2}{(1 -\bar\alpha_{t})^2}\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right] \right]\right]
\end{align}
$$

### å­¦ä¹ æ‰©æ•£å™ªå£°å‚æ•°

è®©æˆ‘ä»¬æ¢è®¨å¦‚ä½•è”åˆå­¦ä¹ å˜åˆ†æ‰©æ•£æ¨¡å‹ï¼ˆVDMï¼‰çš„å™ªå£°å‚æ•°[10]ã€‚ä¸€ç§æ½œåœ¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨å…·æœ‰å‚æ•° $ n $ çš„ç¥ç»ç½‘ç»œ $ \hat{n}(t) $ æ¥å¯¹ $ \alpha_t $ è¿›è¡Œå»ºæ¨¡ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºåœ¨æ¯ä¸ªæ—¶é—´æ­¥ $ t $ éƒ½å¿…é¡»å¤šæ¬¡æ‰§è¡Œæ¨æ–­ä»¥è®¡ç®— $ \bar{\alpha}_t $ã€‚å°½ç®¡ç¼“å­˜å¯ä»¥å‡è½»è¿™ç§è®¡ç®—æˆæœ¬ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¨å¯¼å‡ºä¸€ç§æ›¿ä»£æ–¹æ³•æ¥å­¦ä¹ æ‰©æ•£å™ªå£°å‚æ•°ã€‚é€šè¿‡å°†æˆ‘ä»¬çš„æ–¹å·®æ–¹ç¨‹ï¼ˆå…¬å¼54ï¼‰ä»£å…¥æˆ‘ä»¬æ¨å¯¼å‡ºçš„æ¯ä¸ªæ—¶é—´æ­¥ç›®æ ‡ï¼ˆå…¬å¼61ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–ä¸ºï¼š

$$
\begin{align}
\frac{1}{2\sigma_q^2(t)}\frac{\bar\alpha_{t-1}(1-\alpha_t)^2}{(1 -\bar\alpha_{t})^2}\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right] = \frac{1}{2}\left(\frac{\bar\alpha_{t-1}}{1 - \bar\alpha_{t-1}} -\frac{\bar\alpha_t}{1 -\bar\alpha_{t}}\right)\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right]
\end{align}
$$



è¯æ˜å¦‚ä¸‹ï¼š

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/snr_deriv.svg" alt="ä½¿ç”¨ SNR é¡¹å¯¼å‡ºç›®æ ‡" style="zoom:100%;" />
</div>

å›å¿†ä¸€ä¸‹æ–¹ç¨‹50é‚£$q(\boldsymbol{x}_t\mid\boldsymbol{x}_0)$æ˜¯å½¢å¼çš„é«˜æ–¯$\mathcal{N}(\boldsymbol{x}_{t} ; \sqrt{\bar\alpha_t}\boldsymbol{x}_0, \left(1 - \bar\alpha_t\right)\textbf{I})$ã€‚ç„¶åï¼Œéµå¾ª[ä¿¡å™ªæ¯” (SNR)](https://en.wikipedia.org/wiki/Signal-to-noise_ratio#Alternate_definition)çš„å®šä¹‰ï¼š$\frac{\mu^2}{\sigma^2}$ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæ¯ä¸ªæ—¶é—´æ­¥çš„SNRğ‘¡ä½œä¸ºï¼š
$$
\begin{align}
    \text{SNR}(t) &= \frac{\bar\alpha_t}{1 -\bar\alpha_{t}}
\end{align}
$$
ç„¶åï¼Œæˆ‘ä»¬çš„å¯¼å‡ºæ–¹ç¨‹63ï¼ˆå’Œæ–¹ç¨‹61) å¯ä»¥ç®€åŒ–ä¸ºï¼š
$$
\begin{align}
\frac{1}{2\sigma_q^2(t)}\frac{\bar\alpha_{t-1}(1-\alpha_t)^2}{(1 -\bar\alpha_{t})^2}\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right] &= \frac{1}{2}\left(\text{SNR}(t-1) -\text{SNR}(t)\right)\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right]
\end{align}
$$


æ­£å¦‚åç§°æ‰€ç¤ºï¼Œä¿¡å™ªæ¯”ï¼ˆSNRï¼‰è¡¨ç¤ºåŸå§‹ä¿¡å·ä¸å­˜åœ¨å™ªå£°é‡ä¹‹é—´çš„æ¯”ç‡ï¼›è¾ƒé«˜çš„SNRè¡¨ç¤ºæ›´å¤šçš„ä¿¡å·ï¼Œè¾ƒä½çš„SNRè¡¨ç¤ºæ›´å¤šçš„å™ªå£°ã€‚åœ¨æ‰©æ•£æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬è¦æ±‚SNRéšç€æ—¶é—´æ­¥ $ t $ çš„å¢åŠ è€Œå•è°ƒé€’å‡ï¼›è¿™å½¢å¼åŒ–äº†æ‰°åŠ¨è¾“å…¥ $ x_t $ éšç€æ—¶é—´çš„æ¨ç§»å˜å¾—è¶Šæ¥è¶Šå˜ˆæ‚çš„æ¦‚å¿µï¼Œç›´åˆ°åœ¨ $ t = T $ æ—¶å®Œå…¨å˜æˆæ ‡å‡†é«˜æ–¯å™ªå£°ã€‚

æ ¹æ®å…¬å¼(65)ä¸­ç›®æ ‡çš„ç®€åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ç¥ç»ç½‘ç»œå¯¹æ¯ä¸ªæ—¶é—´æ­¥çš„SNRè¿›è¡Œå‚æ•°åŒ–ï¼Œå¹¶ä¸æ‰©æ•£æ¨¡å‹ä¸€èµ·è”åˆå­¦ä¹ [10]ã€‚ç”±äºSNRå¿…é¡»éšæ—¶é—´å•è°ƒé€’å‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è¡¨ç¤ºä¸ºï¼š

$$
\begin{align}
    \text{SNR}(t) = \text{exp}(-\omega_{\boldsymbol{\eta}}(t))
\end{align}
$$
å…¶ä¸­ $ w_n(t) $ è¢«å»ºæ¨¡ä¸ºå…·æœ‰å‚æ•° $ n $ çš„å•è°ƒé€’å¢ç¥ç»ç½‘ç»œã€‚å¯¹ $ w_n(t) $ å–åå¾—åˆ°ä¸€ä¸ªå•è°ƒé€’å‡çš„å‡½æ•°ï¼Œè€ŒæŒ‡æ•°å‡½æ•°åˆ™è¿«ä½¿ç»“æœé¡¹ä¸ºæ­£ã€‚æ³¨æ„ï¼Œå…¬å¼(62)ä¸­çš„ç›®æ ‡ç°åœ¨ä¹Ÿå¿…é¡»å¯¹ $ n $ è¿›è¡Œä¼˜åŒ–ï¼š

$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}, \,\boldsymbol{\eta}}{\arg\min}\, \sum_{t=2}^{T} \mathbb{E}_{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\left[\mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t))\right] \nonumber \\
&= \underset{\boldsymbol{\theta}, \,\boldsymbol{\eta}}{\arg\min}\, \mathbb{E}_{t\sim U\{2, T\}}\left[\mathbb{E}_{q(\boldsymbol{x}_{t}\mid\boldsymbol{x}_0)}\left[ \frac{1}{2}\left(\text{SNR}(t-1) -\text{SNR}(t)\right)\left[\left\lVert\hat{\boldsymbol{x}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \boldsymbol{x}_0\right\rVert_2^2\right] \right]\right]
\end{align}
$$


é€šè¿‡å°†å…¬å¼(66)ä¸­çš„SNRå‚æ•°åŒ–ä¸å…¬å¼(64)ä¸­çš„SNRå®šä¹‰ç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ˜¾å¼åœ°æ¨å¯¼å‡º $ \alpha_t $ ä»¥åŠ $ 1 - \alpha_t $ çš„ä¼˜é›…å½¢å¼ï¼š
$$
\begin{align}
    &\frac{\bar\alpha_t}{1 -\bar\alpha_{t}} = \text{exp}(-\omega_{\boldsymbol{\eta}}(t))\\
    &\therefore \bar\alpha_t = \text{sigmoid}(-\omega_{\boldsymbol{\eta}}(t))\\
    &\therefore 1 - \bar\alpha_t = \text{sigmoid}(\omega_{\boldsymbol{\eta}}(t))
\end{align}
$$


è¿™äº›é¡¹å¯¹äºå„ç§è®¡ç®—æ˜¯å¿…éœ€çš„ï¼›ä¾‹å¦‚ï¼Œåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬è¢«ç”¨æ¥ä½¿ç”¨é‡æ–°å‚æ•°åŒ–æŠ€å·§ä»è¾“å…¥ $ x_0 $ åˆ›å»ºä»»æ„å™ªå£°çš„ $ x_t $ï¼Œå¦‚åœ¨å…¬å¼49ä¸­æ¨å¯¼çš„ã€‚

### ä¸‰ç§ç­‰æ•ˆçš„è§£é‡Š

æ­£å¦‚æˆ‘ä»¬ä¹‹å‰è¯æ˜çš„ï¼Œå˜åˆ†æ‰©æ•£æ¨¡å‹å¯ä»¥é€šè¿‡ç®€å•åœ°å­¦ä¹ ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥é¢„æµ‹åŸå§‹è‡ªç„¶å›¾åƒ $ x_0 $ä»ä»»æ„å™ªå£°ç‰ˆæœ¬ $ x_t $æ¥è®­ç»ƒã€‚ç„¶è€Œï¼Œ$ x_0 $æœ‰ä¸¤ä¸ªå…¶ä»–çš„ç­‰æ•ˆå‚æ•°åŒ–ï¼Œè¿™å¯¼è‡´äº†å˜åˆ†æ‰©æ•£æ¨¡å‹çš„å¦å¤–ä¸¤ç§è§£é‡Šã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨é‡æ–°å‚æ•°åŒ–æŠ€å·§ã€‚åœ¨æˆ‘ä»¬æ¨å¯¼ $ q(x_t|x0) $çš„å½¢å¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°æ’åˆ—å…¬å¼(69)æ¥æ˜¾ç¤ºï¼š

$$
\begin{align}
\boldsymbol{x}_0 &= \frac{\boldsymbol{x}_t - \sqrt{1 - \bar\alpha_t}\boldsymbol{\epsilon}_0}{\sqrt{\bar\alpha_t}}
\end{align}
$$


å°†è¿™ä¸ªä»£å…¥æˆ‘ä»¬ä¹‹å‰æ¨å¯¼å‡ºçš„çœŸå®å»å™ªè½¬æ¢å‡å€¼ $ \mu_{q}(x_t, x_0) $ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°æ¨å¯¼å¦‚ä¸‹ï¼š

$$
\begin{align}
\boldsymbol{\mu}_q(\boldsymbol{x}_t, \boldsymbol{x}_0) &= \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})\boldsymbol{x}_{t} + \sqrt{\bar\alpha_{t-1}}(1-\alpha_t)\boldsymbol{x}_0}{1 -\bar\alpha_{t}}\\
&= \frac{1}{\sqrt{\alpha_t}}\boldsymbol{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar\alpha_t}\sqrt{\alpha_t}}\boldsymbol{\epsilon}_0
\end{align}
$$


å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿‘ä¼¼å»å™ªè½¬æ¢å‡å€¼ $ \mu_{\theta}(x_t, t) $è®¾ç½®ä¸ºï¼š
$$
\begin{align}
\boldsymbol{\mu}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) &= \frac{1}{\sqrt{\alpha_t}}\boldsymbol{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar\alpha_t}\sqrt{\alpha_t}}\boldsymbol{\hat{\epsilon}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t)
\end{align}
$$


ç›¸åº”çš„ä¼˜åŒ–é—®é¢˜å˜ä¸ºï¼š

$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}}{\arg\min}\,  \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t)) \nonumber \\
&= \underset{\boldsymbol{\theta}}{\arg\min}\, \mathcal{D}_{\text{KL}}\left(\mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_q,\boldsymbol{\Sigma}_q\left(t\right)\right) \mid\mid \mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_{\boldsymbol{\theta}},\boldsymbol{\Sigma}_q\left(t\right)\right)\right)\\
&=\underset{\boldsymbol{\theta}}{\arg\min}\, \frac{1}{2\sigma_q^2(t)}\frac{(1 - \alpha_t)^2}{(1 - \bar\alpha_t)\alpha_t}\left[\left\lVert\boldsymbol{\epsilon}_0 - \boldsymbol{\hat{\epsilon}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t)\right\rVert_2^2\right]
\end{align}
$$


åœ¨è¿™é‡Œï¼Œ$ \hat{\epsilon}_{\theta}(x_t, t) $æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œå®ƒå­¦ä¹ é¢„æµ‹å†³å®š $x_t $ä» $ x_0 $çš„æºå™ªå£° $ \epsilon_0 \sim \mathcal{N}(\epsilon; 0, I) $ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»å±•ç¤ºäº†å­¦ä¹ VDMé€šè¿‡é¢„æµ‹åŸå§‹å›¾åƒ $ x_0 $æ˜¯ç­‰åŒäºå­¦ä¹ é¢„æµ‹å™ªå£°ï¼›ç„¶è€Œï¼Œå®è¯ä¸Šï¼Œä¸€äº›å·¥ä½œå‘ç°é¢„æµ‹å™ªå£°åœ¨æ€§èƒ½ä¸Šæ›´ä¼˜ã€‚

ä¸ºäº†æ¨å¯¼å‡ºå˜åˆ†æ‰©æ•£æ¨¡å‹çš„ç¬¬ä¸‰ç§å¸¸è§è§£é‡Šï¼Œæˆ‘ä»¬å¼•ç”¨Tweedieå…¬å¼ã€‚Tweedieå…¬å¼çš„è‹±æ–‡è¡¨è¿°æ˜¯ï¼Œç»™å®šä»æŒ‡æ•°æ—åˆ†å¸ƒä¸­æŠ½å–çš„æ ·æœ¬ï¼Œå…¶çœŸå®å‡å€¼å¯ä»¥é€šè¿‡æ ·æœ¬çš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆå³ç»éªŒå‡å€¼ï¼‰åŠ ä¸Šæ¶‰åŠä¼°è®¡åˆ†æ•°çš„ä¸€äº›æ ¡æ­£é¡¹æ¥ä¼°è®¡ã€‚åœ¨åªæœ‰ä¸€ä¸ªè§‚æµ‹æ ·æœ¬çš„æƒ…å†µä¸‹ï¼Œç»éªŒå‡å€¼å°±æ˜¯æ ·æœ¬æœ¬èº«ã€‚å®ƒé€šå¸¸ç”¨äºå‡å°‘æ ·æœ¬åå·®ï¼›å¦‚æœè§‚æµ‹æ ·æœ¬éƒ½ä½äºåº•å±‚åˆ†å¸ƒçš„ä¸€ç«¯ï¼Œé‚£ä¹ˆè´Ÿåˆ†æ•°å˜å¾—è¾ƒå¤§ï¼Œå¹¶å°†æ ·æœ¬çš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡æ ¡æ­£åˆ°çœŸå®å‡å€¼ã€‚

æ•°å­¦ä¸Šï¼Œå¯¹äºä¸€ä¸ªé«˜æ–¯å˜é‡ $ z \sim \mathcal{N}(z; \mu_z, \Sigma_z) $ï¼ŒTweedieå…¬å¼è¡¨æ˜ï¼š$\mathbb{E}\left[\boldsymbol{\mu}_z\mid\boldsymbol{z}\right] = \boldsymbol{z} + \boldsymbol{\Sigma}_z\nabla_{\boldsymbol{z}} \log p(\boldsymbol{z})$

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å…¶åº”ç”¨äºé¢„æµ‹ç»™å®šå…¶æ ·æœ¬çš„ $x_t $çš„çœŸå®åéªŒå‡å€¼ã€‚ä»å…¬å¼50ï¼Œæˆ‘ä»¬çŸ¥é“ $ q(x_t|x_0) = \mathcal{N}(x_t; \sqrt{\overline{\alpha}_t} x_0, (1 - \overline{\alpha}_t) I) $ã€‚ç„¶åï¼Œæ ¹æ®Tweedieå…¬å¼ï¼Œæˆ‘ä»¬æœ‰ï¼š

$$
\begin{align}
\mathbb{E}\left[\boldsymbol{\mu}_{x_t}\mid\boldsymbol{x}_t\right] = \boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla_{\boldsymbol{x}_t}\log p(\boldsymbol{x}_t)
\end{align}
$$
å…¶ä¸­æˆ‘ä»¬ä¸ºäº†ç®€åŒ–ç¬¦å·ï¼Œå°† $ \nabla_{x_t} \log p(x_t) $å†™ä¸º $ \nabla \log p(x_t) $ã€‚æ ¹æ®Tweedieå…¬å¼ï¼Œ$x_t $ç”Ÿæˆçš„çœŸå®å‡å€¼ $ \mu_{x_t} = \sqrt{\overline{\alpha}_t} x_0 $è¢«å®šä¹‰ä¸ºï¼š

$$
\begin{align}
    \sqrt{\bar\alpha_t}\boldsymbol{x}_0 = \boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla\log p(\boldsymbol{x}_t)\\
    \therefore \boldsymbol{x}_0 = \frac{\boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla\log p(\boldsymbol{x}_t)}{\sqrt{\bar\alpha_t}}
\end{align}
$$


ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¬å¼133å†æ¬¡ä»£å…¥æˆ‘ä»¬çš„çœŸå®å»å™ªè½¬æ¢å‡å€¼ $ \mu_{q}(x_t, x_0) $å¹¶æ¨å¯¼å‡ºä¸€ä¸ªæ–°çš„å½¢å¼ï¼š
$$
\begin{align}
\boldsymbol{\mu}_q(\boldsymbol{x}_t, \boldsymbol{x}_0) &= \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})\boldsymbol{x}_{t} + \sqrt{\bar\alpha_{t-1}}(1-\alpha_t)\boldsymbol{x}_0}{1 -\bar\alpha_{t}}\\
&= \frac{1}{\sqrt{\alpha_t}}\boldsymbol{x}_t + \frac{1 - \alpha_t}{\sqrt{\alpha_t}}\nabla\log p(\boldsymbol{x}_t)
\end{align}
$$

è¯æ˜å¦‚ä¸‹ï¼š


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/pred_score_deriv.svg" alt="ä½¿ç”¨åˆ†æ•°é¡¹å¯¼å‡ºçœŸå®çš„å»å™ªå¹³å‡å€¼" style="zoom:100%;" />
</div>


å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿‘ä¼¼å»å™ªè½¬æ¢å‡å€¼ $ \mu_{\theta}(x_t, t) $è®¾ç½®ä¸ºï¼š
$$
\begin{align}
\boldsymbol{\mu}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) &= \frac{1}{\sqrt{\alpha_t}}\boldsymbol{x}_t + \frac{1 - \alpha_t}{\sqrt{\alpha_t}}\boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t)
\end{align}
$$


ç›¸åº”çš„ä¼˜åŒ–é—®é¢˜å˜ä¸ºï¼š

$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}}{\arg\min}\,  \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t)) \nonumber \\
&= \underset{\boldsymbol{\theta}}{\arg\min}\, \mathcal{D}_{\text{KL}}\left(\mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_q,\boldsymbol{\Sigma}_q\left(t\right)\right) \mid\mid \mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_{\boldsymbol{\theta}},\boldsymbol{\Sigma}_q\left(t\right)\right)\right)\\
&=\underset{\boldsymbol{\theta}}{\arg\min}\, \frac{1}{2\sigma_q^2(t)}\frac{(1 - \alpha_t)^2}{\alpha_t}\left[\left\lVert \boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \nabla\log p(\boldsymbol{x}_t)\right\rVert_2^2\right]
\end{align}
$$



åœ¨è¿™é‡Œï¼Œ$\boldsymbol{\hat{\epsilon}}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) $ æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œå®ƒå­¦ä¹ é¢„æµ‹æºå™ªå£° $ \epsilon_0 \sim \mathcal{N}(e; 0, I) $ï¼Œè¯¥å™ªå£°å†³å®šäº† $ \hat{x}_t $ ä» $ x_0 $ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»å±•ç¤ºäº†é€šè¿‡é¢„æµ‹åŸå§‹å›¾åƒ $ x_0 $ æ¥å­¦ä¹  VDM æ˜¯ç­‰åŒäºå­¦ä¹ é¢„æµ‹å™ªå£°çš„ï¼›ç„¶è€Œï¼Œå®è¯ä¸Šï¼Œä¸€äº›å·¥ä½œå‘ç°é¢„æµ‹å™ªå£°èƒ½å¤Ÿå¸¦æ¥æ›´å¥½çš„æ€§èƒ½[2, 4]ã€‚

ä¸ºäº†æ¨å¯¼å‡ºå˜åˆ†æ‰©æ•£æ¨¡å‹çš„ç¬¬ä¸‰ç§å¸¸è§è§£é‡Šï¼Œæˆ‘ä»¬å¼•ç”¨äº†Tweedieå…¬å¼[11]ã€‚ç”¨è‹±è¯­æ¥è¯´ï¼ŒTweedieå…¬å¼æŒ‡å‡ºï¼Œç»™å®šä»å…¶ä¸­æŠ½å–çš„æ ·æœ¬ï¼ŒæŒ‡æ•°æ—åˆ†å¸ƒçš„çœŸå®å‡å€¼å¯ä»¥é€šè¿‡æ ·æœ¬çš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆä¹Ÿå°±æ˜¯ç»éªŒå‡å€¼ï¼‰åŠ ä¸Šæ¶‰åŠä¼°è®¡åˆ†æ•°çš„ä¸€äº›æ ¡æ­£é¡¹æ¥ä¼°è®¡ã€‚åœ¨åªæœ‰ä¸€ä¸ªè§‚æµ‹æ ·æœ¬çš„æƒ…å†µä¸‹ï¼Œç»éªŒå‡å€¼å°±æ˜¯æ ·æœ¬æœ¬èº«ã€‚å®ƒé€šå¸¸ç”¨äºå‡å°‘æ ·æœ¬åå·®ï¼›å¦‚æœè§‚æµ‹æ ·æœ¬éƒ½ä½äºåº•å±‚åˆ†å¸ƒçš„ä¸€ç«¯ï¼Œé‚£ä¹ˆè´Ÿåˆ†æ•°å˜å¾—è¾ƒå¤§ï¼Œå¹¶æ ¡æ­£æ ·æœ¬çš„æœ´ç´ æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼Œä½¿å…¶æ¥è¿‘çœŸå®å‡å€¼ã€‚

æ•°å­¦ä¸Šï¼Œå¯¹äºä¸€ä¸ªé«˜æ–¯å˜é‡ $ z \sim \mathcal{N}(z; \mu_z, \Sigma_z) $ï¼ŒTweedieå…¬å¼è¡¨æ˜ï¼š$\mathbb{E}\left[\boldsymbol{\mu}_z\mid\boldsymbol{z}\right] = \boldsymbol{z} + \boldsymbol{\Sigma}_z\nabla_{\boldsymbol{z}} \log p(\boldsymbol{z})$

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å…¶åº”ç”¨äºç»™å®šå…¶æ ·æœ¬çš„æƒ…å†µä¸‹é¢„æµ‹ $ \alpha_t $ çš„çœŸå®åéªŒå‡å€¼ã€‚ä»æ–¹ç¨‹50ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š$q(\boldsymbol{x}_t\mid\boldsymbol{x}_0) = \mathcal{N}(\boldsymbol{x}_{t} ; \sqrt{\bar\alpha_t}\boldsymbol{x}_0, \left(1 - \bar\alpha_t\right)\textbf{I})$

ç„¶åï¼Œæ ¹æ®Tweedieå…¬å¼ï¼Œæˆ‘ä»¬æœ‰ï¼š
$$
\begin{align}
\mathbb{E}\left[\boldsymbol{\mu}_{x_t}\mid\boldsymbol{x}_t\right] = \boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla_{\boldsymbol{x}_t}\log p(\boldsymbol{x}_t)
\end{align}
$$


å…¶ä¸­æˆ‘ä»¬ä¸ºäº†ç®€åŒ–ç¬¦å·ï¼Œå°† $ \nabla_{\alpha_t} \log p(\alpha_t) $ å†™ä¸º $ \nabla \log p(\alpha_t) $ã€‚æ ¹æ®Tweedieå…¬å¼ï¼Œ$ \alpha_t $ ç”Ÿæˆçš„çœŸå®å‡å€¼ $ \mu_{\alpha_t} = \sqrt{\alpha_t} x_0 $ è¢«å®šä¹‰ä¸ºï¼š

$$
\begin{align}
    \sqrt{\bar\alpha_t}\boldsymbol{x}_0 = \boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla\log p(\boldsymbol{x}_t)\\
    \therefore \boldsymbol{x}_0 = \frac{\boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla\log p(\boldsymbol{x}_t)}{\sqrt{\bar\alpha_t}}
\end{align}
$$


ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†æ–¹ç¨‹79å†æ¬¡ä»£å…¥æˆ‘ä»¬ä¹‹å‰æ¨å¯¼å‡ºçš„çœŸå®å»å™ªè½¬æ¢å‡å€¼ $ \mu_{q}(\alpha_t, x_0) $ å¹¶æ¨å¯¼å‡ºä¸€ä¸ªæ–°çš„å‚æ•°åŒ–ï¼š
$$
\begin{align}
\boldsymbol{\mu}_q(\boldsymbol{x}_t, \boldsymbol{x}_0) &= \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t-1})\boldsymbol{x}_{t} + \sqrt{\bar\alpha_{t-1}}(1-\alpha_t)\boldsymbol{x}_0}{1 -\bar\alpha_{t}}\\
&= \frac{1}{\sqrt{\alpha_t}}\boldsymbol{x}_t + \frac{1 - \alpha_t}{\sqrt{\alpha_t}}\nabla\log p(\boldsymbol{x}_t)
\end{align}
$$
è¯æ˜å¦‚ä¸‹ï¼š

<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/proofs/pred_score_deriv.svg" alt="ä½¿ç”¨åˆ†æ•°é¡¹å¯¼å‡ºçœŸå®çš„å»å™ªå¹³å‡å€¼" style="zoom:100%;" />
</div>

å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æˆ‘ä»¬çš„è¿‘ä¼¼å»å™ªè½¬æ¢å‡å€¼ $ \mu_{\theta}(\alpha_t, t) $ è®¾ç½®ä¸ºï¼š

$$
\begin{align}
\boldsymbol{\mu}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) &= \frac{1}{\sqrt{\alpha_t}}\boldsymbol{x}_t + \frac{1 - \alpha_t}{\sqrt{\alpha_t}}\boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t)
\end{align}
$$


ç›¸åº”çš„ä¼˜åŒ–é—®é¢˜å˜ä¸ºï¼š
$$
\begin{align}
& \quad \,\underset{\boldsymbol{\theta}}{\arg\min}\,  \mathcal{D}_{\text{KL}}(q(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t, \boldsymbol{x}_0) \mid\mid p_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid\boldsymbol{x}_t)) \nonumber \\
&= \underset{\boldsymbol{\theta}}{\arg\min}\, \mathcal{D}_{\text{KL}}\left(\mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_q,\boldsymbol{\Sigma}_q\left(t\right)\right) \mid\mid \mathcal{N}\left(\boldsymbol{x}_{t-1}; \boldsymbol{\mu}_{\boldsymbol{\theta}},\boldsymbol{\Sigma}_q\left(t\right)\right)\right)\\
&=\underset{\boldsymbol{\theta}}{\arg\min}\, \frac{1}{2\sigma_q^2(t)}\frac{(1 - \alpha_t)^2}{\alpha_t}\left[\left\lVert \boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}_t, t) - \nabla\log p(\boldsymbol{x}_t)\right\rVert_2^2\right]
\end{align}
$$


åœ¨è¿™é‡Œï¼Œ$ s_{\theta}(\alpha_t, t) $ æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œå®ƒå­¦ä¹ é¢„æµ‹ä»»æ„å™ªå£°æ°´å¹³ $ t $ ä¸‹ $ \alpha_t $ çš„å¾—åˆ†å‡½æ•° $ \nabla_{\alpha_t} \log p(\alpha_t) $ï¼Œè¿™æ˜¯ $ \alpha_t $ åœ¨æ•°æ®ç©ºé—´ä¸­çš„æ¢¯åº¦ã€‚

æ•é”çš„è¯»è€…ä¼šè§‚å¯Ÿåˆ°å¾—åˆ†å‡½æ•° $ \nabla \log p(x_t) $ åœ¨å½¢å¼ä¸Šä¸æºå™ªå£° $ \epsilon_0 $ éå¸¸ç›¸ä¼¼ã€‚è¿™å¯ä»¥é€šè¿‡å°†Tweedieå…¬å¼ï¼ˆå…¬å¼133ï¼‰ä¸é‡æ–°å‚æ•°åŒ–æŠ€å·§ï¼ˆå…¬å¼115ï¼‰ç»“åˆèµ·æ¥æ˜ç¡®åœ°å±•ç¤ºï¼š

$$
\begin{align}
\boldsymbol{x}_0 = \frac{\boldsymbol{x}_t + (1 - \bar\alpha_t)\nabla\log p(\boldsymbol{x}_t)}{\sqrt{\bar\alpha_t}} &= \frac{\boldsymbol{x}_t - \sqrt{1 - \bar\alpha_t}\boldsymbol{\epsilon}_0}{\sqrt{\bar\alpha_t}}\\
\therefore (1 - \bar\alpha_t)\nabla\log p(\boldsymbol{x}_t) &= -\sqrt{1 - \bar\alpha_t}\boldsymbol{\epsilon}_0\\
\nabla\log p(\boldsymbol{x}_t) &= -\frac{1}{\sqrt{1 - \bar\alpha_t}}\boldsymbol{\epsilon}_0
\end{align}
$$


å¾—åˆ†å‡½æ•°æµ‹é‡äº†åœ¨æ•°æ®ç©ºé—´ä¸­å¦‚ä½•ç§»åŠ¨ä»¥æœ€å¤§åŒ–å¯¹æ•°æ¦‚ç‡ï¼›ç›´è§‚ä¸Šï¼Œç”±äºæºå™ªå£°è¢«æ·»åŠ åˆ°è‡ªç„¶å›¾åƒä¸­ä»¥ç ´åå®ƒï¼Œå‘ç›¸åæ–¹å‘ç§»åŠ¨â€œå»å™ªâ€äº†å›¾åƒï¼Œå¹¶ä¸”å°†æ˜¯å¢åŠ éšåå¯¹æ•°æ¦‚ç‡çš„æœ€ä½³æ›´æ–°ã€‚æˆ‘ä»¬çš„æ•°å­¦è¯æ˜åªæ˜¯è¯å®äº†è¿™ç§ç›´è§‰ï¼›æˆ‘ä»¬å·²ç»æ˜ç¡®å±•ç¤ºäº†å­¦ä¹ å»ºæ¨¡å¾—åˆ†å‡½æ•°ç­‰åŒäºå»ºæ¨¡æºå™ªå£°çš„è´Ÿå€¼ï¼ˆä¹˜ä»¥ä¸€ä¸ªéšæ—¶é—´å˜åŒ–çš„å¸¸æ•°å› å­ï¼‰ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ¨å¯¼å‡ºäº†ä¼˜åŒ–VDMçš„ä¸‰ç§ç­‰æ•ˆç›®æ ‡ï¼šå­¦ä¹ ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥é¢„æµ‹ä»»æ„å™ªå£°ç‰ˆæœ¬çš„åŸå§‹å›¾åƒ $ x_0 $ï¼Œé¢„æµ‹ä»»æ„å™ªå£°å›¾åƒçš„æºå™ªå£° $ \epsilon_0 $ï¼Œæˆ–è€…é¢„æµ‹ä»»æ„å™ªå£°æ°´å¹³ä¸‹çš„å›¾åƒå¾—åˆ† $ \nabla \log p(x_t) $ã€‚VDMå¯ä»¥é€šè¿‡éšæœºé‡‡æ ·æ—¶é—´æ­¥ $ t $ å¹¶æœ€å°åŒ–é¢„æµ‹ä¸çœŸå®ç›®æ ‡çš„èŒƒæ•°æ¥å¯æ‰©å±•åœ°è®­ç»ƒã€‚

## åˆ†æ•°ç”Ÿæˆæ¨¡å‹ï¼ˆScore-based Generative Modelsï¼‰

æˆ‘ä»¬å·²ç»å±•ç¤ºäº†å˜åˆ†æ‰©æ•£æ¨¡å‹å¯ä»¥é€šè¿‡ç®€å•åœ°ä¼˜åŒ–ä¸€ä¸ªç¥ç»ç½‘ç»œ $ s_{\theta}(x_t, t) $ æ¥é¢„æµ‹ $x_t $ åœ¨ä»»æ„å™ªå£°æ°´å¹³ä¸‹çš„å¾—åˆ†å‡½æ•° $ \nabla \log p(x_t) $ æ¥å­¦ä¹ ã€‚ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬çš„æ¨å¯¼ä¸­ï¼Œå¾—åˆ†é¡¹æ˜¯é€šè¿‡åº”ç”¨Tweedieå…¬å¼å¾—å‡ºçš„ï¼›è¿™å¹¶ä¸ä¸€å®šä¸ºæˆ‘ä»¬æä¾›äº†å…³äºå¾—åˆ†å‡½æ•°ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæˆ–è€…ä¸ºä»€ä¹ˆå€¼å¾—å»ºæ¨¡çš„æ·±åˆ»ç›´è§‰æˆ–æ´å¯Ÿã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘å¦ä¸€ç±»ç”Ÿæˆæ¨¡å‹â€”â€”åŸºäºåˆ†æ•°çš„ç”Ÿæˆæ¨¡å‹ï¼ˆScore-based Generative Modelsï¼‰â€”â€”å¯»æ±‚è¿™ç§ç›´è§‰ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å±•ç¤ºæˆ‘ä»¬ä¹‹å‰æ¨å¯¼å‡ºçš„å˜åˆ†æ‰©æ•£æ¨¡å‹å…¬å¼æœ‰ä¸€ä¸ªç­‰æ•ˆçš„åŸºäºåˆ†æ•°çš„ç”Ÿæˆå»ºæ¨¡å…¬å¼ï¼Œå…è®¸æˆ‘ä»¬æ ¹æ®éœ€è¦åœ¨è¿™ä¸¤ç§è§£é‡Šä¹‹é—´çµæ´»åˆ‡æ¢ã€‚

ä¸ºäº†å¼€å§‹ç†è§£ä¼˜åŒ–å¾—åˆ†å‡½æ•°çš„æ„ä¹‰ï¼Œæˆ‘ä»¬ç»•ä¸ªå¼¯å­ï¼Œé‡æ–°å®¡è§†åŸºäºèƒ½é‡çš„æ¨¡å‹ï¼ˆenergy-based modelsï¼‰ã€‚ä»»æ„çµæ´»çš„æ¦‚ç‡åˆ†å¸ƒå¯ä»¥å†™æˆä»¥ä¸‹å½¢å¼ï¼š

$$
\begin{align}
    p_{\boldsymbol{\theta}}(\boldsymbol{x}) = \frac{1}{Z_{\boldsymbol{\theta}}}e^{-f_{\boldsymbol{\theta}}(\boldsymbol{x})}
\end{align}
$$


å…¶ä¸­ $ f_{\theta}(x) $ æ˜¯ä¸€ä¸ªä»»æ„çµæ´»çš„ã€å¯å‚æ•°åŒ–çš„å‡½æ•°ï¼Œç§°ä¸ºèƒ½é‡å‡½æ•°ï¼Œé€šå¸¸ç”±ç¥ç»ç½‘ç»œå»ºæ¨¡ï¼Œ$ Z_{\theta} $ æ˜¯ä¸€ä¸ªè§„èŒƒåŒ–å¸¸æ•°ï¼Œä»¥ç¡®ä¿ç§¯åˆ† $ \int p_{\theta}(x) \, dx = 1 $ã€‚å­¦ä¹ è¿™æ ·ä¸€ä¸ªåˆ†å¸ƒçš„ä¸€ç§æ–¹æ³•æ˜¯æœ€å¤§ä¼¼ç„¶ï¼›ç„¶è€Œï¼Œè¿™éœ€è¦èƒ½å¤Ÿçµæ´»åœ°è®¡ç®—è§„èŒƒåŒ–å¸¸æ•° $ Z_{\theta} = \int e^{-f_{\theta}(x)} \, dx $ï¼Œå¯¹äºå¤æ‚ $ f_{\theta}(x) $ å‡½æ•°æ¥è¯´å¯èƒ½æ˜¯ä¸å¯èƒ½çš„ã€‚

é¿å…è®¡ç®—æˆ–å»ºæ¨¡è§„èŒƒåŒ–å¸¸æ•°çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªç¥ç»ç½‘ç»œ $ s_{\theta}(x) $ æ¥å­¦ä¹ åˆ†å¸ƒ $ p(x) $ çš„å¾—åˆ†å‡½æ•° $ \nabla \log p(x) $ è€Œä¸æ˜¯èƒ½é‡å‡½æ•°ã€‚è¿™æ˜¯åŸºäºè§‚å¯Ÿåˆ°çš„äº‹å®ï¼Œå³å¯¹æ•°ä¸¤è¾¹åŒæ—¶å–å¯¼æ•°å¾—åˆ°ï¼š

$$
\begin{align}
\nabla_{\boldsymbol{x}} \log p_{\boldsymbol{\theta}}(\boldsymbol{x})
&= \nabla_{\boldsymbol{x}}\log(\frac{1}{Z_{\boldsymbol{\theta}}}e^{-f_{\boldsymbol{\theta}}(\boldsymbol{x})})\\
&= \nabla_{\boldsymbol{x}}\log\frac{1}{Z_{\boldsymbol{\theta}}} + \nabla_{\boldsymbol{x}}\log e^{-f_{\boldsymbol{\theta}}(\boldsymbol{x})}\\
&= -\nabla_{\boldsymbol{x}} f_{\boldsymbol{\theta}}(\boldsymbol{x})\\
&\approx \boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x})
\end{align}
$$


è¿™å¯ä»¥è‡ªç”±åœ°è¡¨ç¤ºä¸ºä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œè€Œä¸æ¶‰åŠä»»ä½•è§„èŒƒåŒ–å¸¸æ•°ã€‚å¾—åˆ†æ¨¡å‹å¯ä»¥é€šè¿‡æœ€å°åŒ–ä¸çœŸå®å¾—åˆ†å‡½æ•°çš„Fisheræ•£åº¦æ¥ä¼˜åŒ–ï¼š
$$
\begin{align}
    \mathbb{E}_{p(\boldsymbol{x})}\left[\left\lVert \boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}) - \nabla\log p(\boldsymbol{x})\right\rVert_2^2\right]
\end{align}
$$


å¾—åˆ†å‡½æ•°ä»£è¡¨ä»€ä¹ˆï¼Ÿå¯¹äºæ¯ä¸€ä¸ª $ x $ï¼Œå¯¹å…¶å¯¹æ•°ä¼¼ç„¶å…³äº $ x $ å–æ¢¯åº¦ï¼ŒåŸºæœ¬ä¸Šæè¿°äº†åœ¨æ•°æ®ç©ºé—´ä¸­å‘å“ªä¸ªæ–¹å‘ç§»åŠ¨ä»¥è¿›ä¸€æ­¥å¢åŠ å…¶ä¼¼ç„¶æ€§ã€‚


<div align=center>
<img src="https://calvinyluo.com/assets/images/diffusion/score_sample.webp" alt="Visualizing sampled paths from Langevin Dynamics against ground-truth scores" style="zoom:50%;" />
</div>


ç›´è§‚åœ°è¯´ï¼Œå¾—åˆ†å‡½æ•°å®šä¹‰äº†æ•´ä¸ªæ•°æ® $ x $ æ‰€å æ®çš„ç©ºé—´ä¸Šçš„ä¸€ä¸ªå‘é‡åœºï¼ŒæŒ‡å‘æ¨¡å¼ã€‚åœ¨å›¾6çš„å³å›¾ä¸­ï¼Œè¿™è¢«è§†è§‰åŒ–åœ°è¡¨ç¤ºå‡ºæ¥ã€‚ç„¶åï¼Œé€šè¿‡å­¦ä¹ çœŸå®æ•°æ®åˆ†å¸ƒçš„å¾—åˆ†å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»åŒä¸€ç©ºé—´ä¸­çš„ä»»æ„ç‚¹å¼€å§‹ï¼Œè¿­ä»£åœ°è·Ÿéšå¾—åˆ†ç›´åˆ°åˆ°è¾¾ä¸€ä¸ªæ¨¡å¼æ¥ç”Ÿæˆæ ·æœ¬ã€‚è¿™ç§é‡‡æ ·è¿‡ç¨‹è¢«ç§°ä¸ºLangevinåŠ¨åŠ›å­¦ï¼Œæ•°å­¦ä¸Šæè¿°ä¸ºï¼š

$$
\begin{align}
    \boldsymbol{x}_{i+1} \leftarrow \boldsymbol{x}_i + c\nabla\log p(\boldsymbol{x}_i) + \sqrt{2c}\boldsymbol{\epsilon},\quad i = 0, 1, ..., K
\end{align}
$$


å…¶ä¸­ $ x_0 $ æ˜¯ä»å…ˆéªŒåˆ†å¸ƒï¼ˆå¦‚å‡åŒ€åˆ†å¸ƒï¼‰ä¸­éšæœºé‡‡æ ·çš„ï¼Œ$ \epsilon \sim \mathcal{N}(\epsilon; 0, I) $ æ˜¯ä¸€ä¸ªé¢å¤–çš„å™ªå£°é¡¹ï¼Œä»¥ç¡®ä¿ç”Ÿæˆçš„æ ·æœ¬ä¸ä¼šæ€»æ˜¯åç¼©åˆ°ä¸€ä¸ªæ¨¡å¼ä¸Šï¼Œè€Œæ˜¯åœ¨å…¶å‘¨å›´å¾˜å¾Šä»¥å®ç°å¤šæ ·æ€§ã€‚æ­¤å¤–ï¼Œç”±äºå­¦ä¹ åˆ°çš„å¾—åˆ†å‡½æ•°æ˜¯ç¡®å®šæ€§çš„ï¼Œæ¶‰åŠå™ªå£°é¡¹çš„é‡‡æ ·ä¸ºç”Ÿæˆè¿‡ç¨‹å¢åŠ äº†éšæœºæ€§ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿé¿å…ç¡®å®šæ€§çš„è½¨è¿¹ã€‚å½“é‡‡æ ·ä»ä½äºå¤šä¸ªæ¨¡å¼ä¹‹é—´çš„ä½ç½®åˆå§‹åŒ–æ—¶ï¼Œè¿™ç‰¹åˆ«æœ‰ç”¨ã€‚LangevinåŠ¨åŠ›å­¦é‡‡æ ·å’Œå™ªå£°é¡¹çš„å¥½å¤„åœ¨å›¾6ä¸­ä»¥è§†è§‰æ–¹å¼å±•ç¤ºã€‚

è¯·è§‚å¯Ÿï¼Œæ–¹ç¨‹(157)ä¸­çš„ç›®æ ‡ä¾èµ–äºæˆ‘ä»¬èƒ½å¤Ÿè®¿é—®çœŸå®å¾—åˆ†å‡½æ•°ï¼Œå¯¹äºåƒè‡ªç„¶å›¾åƒè¿™æ ·çš„å¤æ‚åˆ†å¸ƒï¼Œè¿™æ˜¯æˆ‘ä»¬æ— æ³•è·å¾—çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œå·²ç»æ¨å¯¼å‡ºäº†ç§°ä¸ºå¾—åˆ†åŒ¹é…ï¼ˆscore matchingï¼‰çš„æ›¿ä»£æŠ€æœ¯ï¼Œå¯ä»¥åœ¨ä¸çŸ¥é“çœŸå®å¾—åˆ†çš„æƒ…å†µä¸‹æœ€å°åŒ–è¿™ä¸ªFisheræ•£åº¦ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™æ¥ä¼˜åŒ–ã€‚

æ€»çš„æ¥è¯´ï¼Œå­¦ä¹ å°†åˆ†å¸ƒè¡¨ç¤ºä¸ºå¾—åˆ†å‡½æ•°ï¼Œå¹¶ä½¿ç”¨å®ƒé€šè¿‡Markové“¾è’™ç‰¹å¡æ´›æŠ€æœ¯ï¼ˆå¦‚LangevinåŠ¨åŠ›å­¦ï¼‰ç”Ÿæˆæ ·æœ¬ï¼Œè¢«ç§°ä¸ºåŸºäºåˆ†æ•°çš„ç”Ÿæˆå»ºæ¨¡ï¼ˆScore-based Generative Modelingï¼‰ã€‚



æ ‡å‡†å¾—åˆ†åŒ¹é…å­˜åœ¨ä¸‰ä¸ªä¸»è¦é—®é¢˜ï¼Œè¿™äº›é—®é¢˜ç”±Songå’ŒErmonè¯¦ç»†è¯´æ˜[3]ã€‚é¦–å…ˆï¼Œå½“ $ a_c $ ä½äºé«˜ç»´ç©ºé—´ä¸­çš„ä½ç»´æµå½¢ä¸Šæ—¶ï¼Œå¾—åˆ†å‡½æ•°æ˜¯æœªå®šä¹‰çš„ã€‚è¿™å¯ä»¥ä»æ•°å­¦ä¸Šçœ‹å‡ºï¼›ä¸åœ¨ä½ç»´æµå½¢ä¸Šçš„æ‰€æœ‰ç‚¹å°†å…·æœ‰é›¶æ¦‚ç‡ï¼Œå…¶å¯¹æ•°æ˜¯æœªå®šä¹‰çš„ã€‚è¿™åœ¨å°è¯•å­¦ä¹ è‡ªç„¶å›¾åƒä¸Šçš„ç”Ÿæˆæ¨¡å‹æ—¶ç‰¹åˆ«ä¸æ–¹ä¾¿ï¼Œå› ä¸ºå·²çŸ¥è‡ªç„¶å›¾åƒä½äºæ•´ä¸ªç©ºé—´çš„ä½ç»´æµå½¢ä¸Šã€‚å…¶æ¬¡ï¼Œé€šè¿‡æ ‡å‡†å¾—åˆ†åŒ¹é…è®­ç»ƒå‡ºçš„ä¼°è®¡å¾—åˆ†å‡½æ•°åœ¨ä½å¯†åº¦åŒºåŸŸå°†ä¸å‡†ç¡®ã€‚è¿™ä»æˆ‘ä»¬åœ¨æ–¹ç¨‹93ä¸­æœ€å°åŒ–çš„ç›®æ ‡ä¸­å¯ä»¥çœ‹å‡ºã€‚å› ä¸ºå®ƒæ˜¯å¯¹ $ p(a) $ çš„æœŸæœ›ï¼Œå¹¶ä¸”æ˜ç¡®åœ°åœ¨æ¥è‡ªå®ƒçš„æ ·æœ¬ä¸Šè¿›è¡Œè®­ç»ƒï¼Œæ¨¡å‹å°†ä¸ä¼šä¸ºå¾ˆå°‘çœ‹åˆ°æˆ–æœªè§è¿‡çš„ç¤ºä¾‹æä¾›å‡†ç¡®çš„å­¦ä¹ ä¿¡å·ã€‚è¿™æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„é‡‡æ ·ç­–ç•¥æ¶‰åŠä»é«˜ç»´ç©ºé—´ä¸­çš„éšæœºä½ç½®å¼€å§‹ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯éšæœºå™ªå£°ï¼Œç„¶åæ ¹æ®å­¦ä¹ åˆ°çš„å¾—åˆ†å‡½æ•°ç§»åŠ¨ã€‚ç”±äºæˆ‘ä»¬æ­£åœ¨è·Ÿéšä¸€ä¸ªå˜ˆæ‚æˆ–ä¸å‡†ç¡®çš„å¾—åˆ†ä¼°è®¡ï¼Œæœ€ç»ˆç”Ÿæˆçš„æ ·æœ¬ä¹Ÿå¯èƒ½æ˜¯æ¬¡ä¼˜çš„ï¼Œæˆ–è€…éœ€è¦æ›´å¤šçš„è¿­ä»£æ‰èƒ½æ”¶æ•›åˆ°å‡†ç¡®çš„è¾“å‡ºã€‚

æœ€åï¼Œå³ä½¿ä½¿ç”¨çœŸå®å¾—åˆ†æ‰§è¡Œï¼ŒLangevinåŠ¨åŠ›å­¦é‡‡æ ·ä¹Ÿå¯èƒ½ä¸ä¼šæ··åˆã€‚å‡è®¾çœŸå®æ•°æ®åˆ†å¸ƒæ˜¯ä¸¤ä¸ªä¸ç›¸äº¤åˆ†å¸ƒçš„æ··åˆ
$$
 p(\alpha) = c_1 p_1(\alpha) + c_2 p_2(\alpha)
$$


ç„¶åï¼Œå½“è®¡ç®—å¾—åˆ†æ—¶ï¼Œè¿™äº›æ··åˆç³»æ•°ä¸¢å¤±äº†ï¼Œå› ä¸ºå¯¹æ•°è¿ç®—å°†ç³»æ•°ä»åˆ†å¸ƒä¸­åˆ†ç¦»å‡ºæ¥ï¼Œæ¢¯åº¦è¿ç®—å°†å…¶ç½®é›¶ã€‚ä¸ºäº†å¯è§†åŒ–è¿™ä¸€ç‚¹ï¼Œè¯·æ³¨æ„ä¸Šå›¾ä¸­æ˜¾ç¤ºçš„çœŸå®å¾—åˆ†å‡½æ•°å¯¹ä¸‰ä¸ªåˆ†å¸ƒä¹‹é—´çš„ä¸åŒæƒé‡æ˜¯ä¸å¯çŸ¥çš„ï¼›ä»æ‰€æè¿°çš„åˆå§‹ç‚¹å¼€å§‹çš„LangevinåŠ¨åŠ›å­¦é‡‡æ ·åˆ°è¾¾æ¯ä¸ªæ¨¡å¼çš„æ¦‚ç‡å¤§è‡´ç›¸ç­‰ï¼Œå°½ç®¡å³ä¸‹è§’çš„æ¨¡å¼åœ¨å®é™…çš„é«˜æ–¯æ··åˆä¸­å…·æœ‰æ›´é«˜çš„æƒé‡ã€‚

ç»“æœè¡¨æ˜ï¼Œé€šè¿‡å‘æ•°æ®æ·»åŠ å¤šä¸ªæ°´å¹³çš„é«˜æ–¯å™ªå£°ï¼Œå¯ä»¥åŒæ—¶è§£å†³è¿™ä¸‰ä¸ªç¼ºç‚¹ã€‚é¦–å…ˆï¼Œç”±äºé«˜æ–¯å™ªå£°åˆ†å¸ƒçš„æ”¯æŒæ˜¯æ•´ä¸ªç©ºé—´ï¼Œæ‰°åŠ¨çš„æ•°æ®æ ·æœ¬å°†ä¸å†å±€é™äºä½ç»´æµå½¢ã€‚å…¶æ¬¡ï¼Œæ·»åŠ å¤§é‡çš„é«˜æ–¯å™ªå£°å°†å¢åŠ æ¯ä¸ªæ¨¡å¼åœ¨æ•°æ®åˆ†å¸ƒä¸­è¦†ç›–çš„åŒºåŸŸï¼Œä»è€Œåœ¨ä½å¯†åº¦åŒºåŸŸå¢åŠ æ›´å¤šçš„è®­ç»ƒä¿¡å·ã€‚æœ€åï¼Œæ·»åŠ å…·æœ‰é€æ¸å¢åŠ çš„æ–¹å·®çš„å¤šä¸ªæ°´å¹³çš„é«˜æ–¯å™ªå£°å°†å¯¼è‡´ä¸­é—´åˆ†å¸ƒï¼Œè¿™äº›åˆ†å¸ƒå°Šé‡çœŸå®çš„æ··åˆç³»æ•°ã€‚

æ­£å¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€ä¸ªæ­£å™ªå£°æ°´å¹³åºåˆ— $ \{\sigma_t\}^{T}_{t=1} $ å¹¶å®šä¹‰ä¸€ç³»åˆ—é€æ¸å—åˆ°å¹²æ‰°çš„æ•°æ®åˆ†å¸ƒï¼š
$$
\begin{align}
p_{\sigma_t}(\boldsymbol{x}_t) = \int p(\boldsymbol{x})\mathcal{N}(\boldsymbol{x}_t; \boldsymbol{x}, \sigma_t^2\textbf{I})d\boldsymbol{x}
\end{align}
$$
ç„¶åï¼Œä½¿ç”¨å¾—åˆ†åŒ¹é…å­¦ä¹ ç¥ç»ç½‘ç»œ $ s_{\theta}(\alpha, t) $ æ¥åŒæ—¶å­¦ä¹ æ‰€æœ‰å™ªå£°æ°´å¹³çš„å¾—åˆ†å‡½æ•°ï¼š

$$
\begin{align}
\underset{\boldsymbol{\theta}}{\arg\min}\, \sum_{t=1}^T\lambda(t)\mathbb{E}_{p_{\sigma_t}(\boldsymbol{x}_t)}\left[\left\lVert \boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x}, t) - \nabla\log p_{\sigma_t}(\boldsymbol{x}_t)\right\rVert_2^2\right]
\end{align}
$$


å…¶ä¸­ $ \lambda(t) $ æ˜¯ä¸€ä¸ªæ­£çš„æƒé‡å‡½æ•°ï¼Œå®ƒä¾èµ–äºå™ªå£°æ°´å¹³ $ t $ã€‚æ³¨æ„ï¼Œè¿™ä¸ªç›®æ ‡å‡ ä¹å®Œå…¨åŒ¹é…æˆ‘ä»¬åœ¨æ–¹ç¨‹84ä¸­æ¨å¯¼å‡ºçš„ç”¨äºè®­ç»ƒå˜åˆ†æ‰©æ•£æ¨¡å‹çš„ç›®æ ‡ã€‚æ­¤å¤–ï¼Œä½œè€…æå‡ºäº†é€€ç«LangevinåŠ¨åŠ›å­¦é‡‡æ ·ä½œä¸ºä¸€ç§ç”Ÿæˆè¿‡ç¨‹ï¼Œå…¶ä¸­æ ·æœ¬æ˜¯é€šè¿‡æŒ‰é¡ºåºè¿è¡ŒLangevinåŠ¨åŠ›å­¦æ¥äº§ç”Ÿçš„ï¼Œæ¯ä¸ª $ t = T, T - 1, \ldots, 2, 1 $ã€‚åˆå§‹åŒ–æ˜¯ä»æŸä¸ªå›ºå®šçš„å…ˆéªŒï¼ˆå¦‚å‡åŒ€åˆ†å¸ƒï¼‰ä¸­é€‰æ‹©çš„ï¼Œæ¯ä¸ªåç»­çš„é‡‡æ ·æ­¥éª¤ä»ä¸Šä¸€ä¸ªæ¨¡æ‹Ÿçš„æœ€ç»ˆæ ·æœ¬å¼€å§‹ã€‚å› ä¸ºå™ªå£°æ°´å¹³åœ¨æ—¶é—´æ­¥ $ t $ ä¸Šç¨³æ­¥ä¸‹é™ï¼Œå¹¶ä¸”æˆ‘ä»¬éšç€æ—¶é—´çš„æ¨ç§»å‡å°æ­¥é•¿ï¼Œæ ·æœ¬æœ€ç»ˆä¼šæ”¶æ•›åˆ°ä¸€ä¸ªçœŸå®æ¨¡å¼ã€‚è¿™ä¸åœ¨å˜åˆ†æ‰©æ•£æ¨¡å‹çš„é©¬å°”å¯å¤«HVAEè§£é‡Šä¸­æ‰§è¡Œçš„é‡‡æ ·ç¨‹åºç›´æ¥ç±»ä¼¼ï¼Œå…¶ä¸­éšæœºåˆå§‹åŒ–çš„æ•°æ®å‘é‡åœ¨é™ä½å™ªå£°æ°´å¹³çš„è¿‡ç¨‹ä¸­è¢«è¿­ä»£åœ°ç»†åŒ–ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è®­ç»ƒç›®æ ‡å’Œé‡‡æ ·ç¨‹åºä¸Šå»ºç«‹äº†å˜åˆ†æ‰©æ•£æ¨¡å‹å’ŒåŸºäºå¾—åˆ†çš„ç”Ÿæˆæ¨¡å‹ä¹‹é—´çš„æ˜ç¡®è”ç³»ã€‚

ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å°†æ‰©æ•£æ¨¡å‹è‡ªç„¶åœ°æ¨å¹¿åˆ°æ— é™æ•°é‡çš„æ—¶é—´æ­¥ã€‚åœ¨é©¬å°”å¯å¤«HVAEçš„è§†è§’ä¸‹ï¼Œè¿™å¯ä»¥è¢«è§£é‡Šä¸ºå°†å±‚çº§çš„æ•°é‡æ‰©å±•åˆ°æ— ç©· $ T \rightarrow \infty $ã€‚ä»ç­‰æ•ˆçš„åŸºäºå¾—åˆ†çš„ç”Ÿæˆæ¨¡å‹çš„è§’åº¦æ¥è¡¨ç¤ºè¿™ä¸€ç‚¹æ›´æ¸…æ™°ï¼›åœ¨æ— é™æ•°é‡çš„å™ªå£°å°ºåº¦ä¸‹ï¼Œå›¾åƒåœ¨è¿ç»­æ—¶é—´ä¸Šçš„æ‰°åŠ¨å¯ä»¥è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œå› æ­¤å¯ä»¥ç”¨éšæœºå¾®åˆ†æ–¹ç¨‹ï¼ˆSDEï¼‰æ¥æè¿°ã€‚ç„¶åé€šè¿‡é€†è½¬SDEæ¥æ‰§è¡Œé‡‡æ ·ï¼Œè¿™è‡ªç„¶éœ€è¦åœ¨æ¯ä¸ªè¿ç»­å€¼çš„å™ªå£°æ°´å¹³ä¸Šä¼°è®¡å¾—åˆ†å‡½æ•°[12]ã€‚SDEçš„ä¸åŒå‚æ•°åŒ–æœ¬è´¨ä¸Šæè¿°äº†ä¸åŒçš„æ‰°åŠ¨æ–¹æ¡ˆï¼Œä½¿å¾—çµæ´»åœ°å»ºæ¨¡å™ªå£°è¿‡ç¨‹æˆä¸ºå¯èƒ½ã€‚

## æŒ‡å¯¼ï¼ˆGuidanceï¼‰

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå…³æ³¨äº†å¯¹æ•°æ®åˆ†å¸ƒ $ p(x) $ çš„å»ºæ¨¡ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬é€šå¸¸ä¹Ÿå¯¹å­¦ä¹ æ¡ä»¶åˆ†å¸ƒ $ p(x|y) $ æ„Ÿå…´è¶£ï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡æ¡ä»¶ä¿¡æ¯ $ y $ æ˜ç¡®æ§åˆ¶æˆ‘ä»¬ç”Ÿæˆçš„æ•°æ®ã€‚è¿™æ„æˆäº†åƒCascaded Diffusion Modelsè¿™æ ·çš„å›¾åƒè¶…åˆ†è¾¨ç‡æ¨¡å‹çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯åƒDALL-E 2å’ŒImagenè¿™æ ·çš„æœ€å…ˆè¿›çš„å›¾åƒ-æ–‡æœ¬æ¨¡å‹çš„å…³é”®ã€‚

æ·»åŠ æ¡ä»¶ä¿¡æ¯çš„ä¸€ç§è‡ªç„¶æ–¹æ³•æ˜¯ç®€å•åœ°å°†å…¶ä¸æ—¶é—´æ­¥ä¿¡æ¯ä¸€èµ·ï¼Œåœ¨æ¯æ¬¡è¿­ä»£ä¸­åŠ å…¥ã€‚å›æƒ³æˆ‘ä»¬çš„è”åˆåˆ†å¸ƒä»å…¬å¼(32)ï¼š

$$
p(\boldsymbol{x}_{0:T}) = p(\boldsymbol{x}_T)\prod_{t=1}^Tp_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid \boldsymbol{x}_t)
$$


ç„¶åï¼Œè¦å°†å…¶å˜æˆä¸€ä¸ªæ¡ä»¶æ‰©æ•£æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°åœ¨æ¯ä¸ªè½¬æ¢æ­¥éª¤ä¸­æ·»åŠ ä»»æ„çš„æ¡ä»¶ä¿¡æ¯ $ y $ï¼š

$$
\begin{align}
p(\boldsymbol{x}_{0:T}\mid y) = p(\boldsymbol{x}_T)\prod_{t=1}^Tp_{\boldsymbol{\theta}}(\boldsymbol{x}_{t-1}\mid \boldsymbol{x}_t, y)
\end{align}
$$


ä¾‹å¦‚ï¼Œ$ y $ å¯ä»¥æ˜¯å›¾åƒ-æ–‡æœ¬ç”Ÿæˆä¸­çš„æ–‡æœ¬ç¼–ç ï¼Œæˆ–è€…æ˜¯æ‰§è¡Œè¶…åˆ†è¾¨ç‡çš„ä½åˆ†è¾¨ç‡å›¾åƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åƒä»¥å‰ä¸€æ ·å­¦ä¹ VDMçš„æ ¸å¿ƒç¥ç»ç½‘ç»œï¼Œé€šè¿‡é¢„æµ‹ $ \hat{x}_{\theta}(x_t, t, y) \approx x_0 $ï¼Œ$ \hat{\epsilon}_{\theta}(x_t, t, y) \approx \epsilon_0 $ï¼Œæˆ– $ s_{\theta}(x_t, t, y) \approx \nabla \log p(x_t|y) $ æ¥å®ç°æ¯ç§æ‰€éœ€çš„è§£é‡Šå’Œå®ç°ã€‚

è¿™ç§æ™®é€šå…¬å¼çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œä»¥è¿™ç§æ–¹å¼è®­ç»ƒçš„æ¡ä»¶æ‰©æ•£æ¨¡å‹å¯èƒ½ä¼šå­¦ä¼šå¿½ç•¥æˆ–æ·¡åŒ–ä»»ä½•ç»™å®šçš„æ¡ä»¶ä¿¡æ¯ã€‚å› æ­¤ï¼Œæå‡ºäº†â€œæŒ‡å¯¼â€ä½œä¸ºä¸€ç§æ–¹æ³•ï¼Œä»¥æ›´æ˜ç¡®åœ°æ§åˆ¶æ¨¡å‹ç»™äºˆæ¡ä»¶ä¿¡æ¯çš„æƒé‡ï¼Œä»£ä»·æ˜¯ç‰ºç‰²æ ·æœ¬å¤šæ ·æ€§ã€‚ä¸¤ç§æœ€æµè¡Œçš„å½¢å¼çš„æŒ‡å¯¼è¢«ç§°ä¸ºåˆ†ç±»å™¨å¼•å¯¼ï¼ˆClassifier Guidanceï¼‰å’Œæ— åˆ†ç±»å™¨å¼•å¯¼ï¼ˆClassifier-Free Guidanceï¼‰ã€‚

åˆ†ç±»å™¨å¼•å¯¼ï¼ˆClassifier Guidanceï¼‰

è®©æˆ‘ä»¬ä»æ‰©æ•£æ¨¡å‹çš„åŸºäºåˆ†æ•°çš„å…¬å¼å¼€å§‹ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å­¦ä¹ æ¡ä»¶æ¨¡å‹çš„å¾—åˆ† $ \nabla \log p(x_t|y) $ åœ¨ä»»æ„å™ªå£°æ°´å¹³ $ t $ ä¸‹ã€‚å›é¡¾ä¸€ä¸‹ï¼Œ$ \nabla $ æ˜¯ $ \nabla_{x_t} $ çš„ç®€å†™ï¼Œä¸ºäº†ç®€æ´èµ·è§ã€‚æ ¹æ®è´å¶æ–¯å®šç†ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºä»¥ä¸‹ç­‰ä»·å½¢å¼ï¼š

$$
\begin{align}
\nabla\log p(\boldsymbol{x}_t\mid y) &= \nabla\log \left( \frac{p(\boldsymbol{x}_t)p(y\mid \boldsymbol{x}_t)}{p(y)} \right)\\
&= \nabla\log p(\boldsymbol{x}_t) + \nabla\log p(y\mid \boldsymbol{x}_t) - \nabla\log p(y)\\
&= \underbrace{\nabla\log p(\boldsymbol{x}_t)}_\text{unconditional score} + \underbrace{\nabla\log p(y\mid \boldsymbol{x}_t)}_\text{adversarial gradient}
\end{align}
$$


æˆ‘ä»¬åˆ©ç”¨äº†äº‹å®ï¼Œå³ç›¸å¯¹äº $x_t $ çš„ $ \log p(y) $ çš„æ¢¯åº¦ä¸ºé›¶ã€‚

æˆ‘ä»¬æœ€ç»ˆæ¨å¯¼å‡ºçš„ç»“æœå¯ä»¥è§£é‡Šä¸ºå­¦ä¹ ä¸€ä¸ªæ— åˆ†ç±»å™¨å¾—åˆ†å‡½æ•°ä¸ä¸€ä¸ªåˆ†ç±»å™¨ $ p(y|xt) $ çš„å¯¹æŠ—æ¢¯åº¦çš„ç»„åˆã€‚å› æ­¤ï¼Œåœ¨åˆ†ç±»å™¨å¼•å¯¼ä¸­ï¼Œæ— åˆ†ç±»å™¨æ‰©æ•£æ¨¡å‹çš„å¾—åˆ†åƒä¹‹å‰æ¨å¯¼çš„é‚£æ ·å­¦ä¹ ï¼ŒåŒæ—¶å­¦ä¹ ä¸€ä¸ªåˆ†ç±»å™¨ï¼Œè¯¥åˆ†ç±»å™¨æ¥æ”¶ä»»æ„å™ªå£°çš„ $x_t $ å¹¶å°è¯•é¢„æµ‹æ¡ä»¶ä¿¡æ¯ $ y $ã€‚ç„¶åï¼Œåœ¨é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œç”¨äºé€€ç«LangevinåŠ¨åŠ›å­¦çš„æ•´ä½“æ¡ä»¶å¾—åˆ†å‡½æ•°è¢«è®¡ç®—ä¸ºæ— åˆ†ç±»å™¨å¾—åˆ†å‡½æ•°å’Œå™ªå£°åˆ†ç±»å™¨çš„å¯¹æŠ—æ¢¯åº¦çš„æ€»å’Œã€‚

ä¸ºäº†å¼•å…¥ç»†ç²’åº¦æ§åˆ¶ï¼Œä»¥é¼“åŠ±æˆ–é˜»æ­¢æ¨¡å‹è€ƒè™‘æ¡ä»¶ä¿¡æ¯ï¼Œåˆ†ç±»å™¨å¼•å¯¼é€šè¿‡ä¸€ä¸ª $ \gamma $ è¶…å‚æ•°é¡¹æ¥ç¼©æ”¾å™ªå£°åˆ†ç±»å™¨çš„å¯¹æŠ—æ¢¯åº¦ã€‚åœ¨åˆ†ç±»å™¨å¼•å¯¼ä¸‹å­¦ä¹ å¾—åˆ†å‡½æ•°å¯ä»¥æ€»ç»“ä¸ºï¼š

$$
\begin{align}
    \nabla\log p(\boldsymbol{x}_t\mid y) &= \nabla\log p(\boldsymbol{x}_t) + \gamma\nabla\log p(y\mid \boldsymbol{x}_t)
\end{align}
$$


ç›´è§‚åœ°è¯´ï¼Œå½“ $ \gamma = 0 $ æ—¶ï¼Œæ¡ä»¶æ‰©æ•£æ¨¡å‹å®Œå…¨å¿½ç•¥æ¡ä»¶ä¿¡æ¯ï¼Œå½“ $ \gamma $ å¾ˆå¤§æ—¶ï¼Œæ¡ä»¶æ‰©æ•£æ¨¡å‹å­¦ä¼šäº§ç”Ÿä¸¥é‡ä¾èµ–äºæ¡ä»¶ä¿¡æ¯çš„æ ·æœ¬ã€‚è¿™å°†ä»¥ç‰ºç‰²æ ·æœ¬å¤šæ ·æ€§ä¸ºä»£ä»·ï¼Œå› ä¸ºå®ƒåªä¼šäº§ç”Ÿå®¹æ˜“ä»æä¾›çš„æ¡ä»¶ä¸‹å†ç”Ÿçš„æ ·æœ¬ï¼Œå³ä½¿åœ¨å™ªå£°æ°´å¹³ä¸‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

åˆ†ç±»å™¨å¼•å¯¼çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯å®ƒä¾èµ–äºå•ç‹¬å­¦ä¹ åˆ†ç±»å™¨ã€‚ç”±äºåˆ†ç±»å™¨å¿…é¡»å¤„ç†ä»»æ„å™ªå£°çš„è¾“å…¥ï¼Œè¿™è¶…å‡ºäº†å¤§å¤šæ•°ç°æœ‰çš„é¢„è®­ç»ƒåˆ†ç±»æ¨¡å‹çš„ä¼˜åŒ–èŒƒå›´ï¼Œå› æ­¤å®ƒå¿…é¡»ä¸æ‰©æ•£æ¨¡å‹ä¸€èµ·ç‰¹åˆ«å­¦ä¹ ã€‚

æ— åˆ†ç±»å™¨å¼•å¯¼ï¼ˆClassifier-Free Guidanceï¼‰

åœ¨æ— åˆ†ç±»å™¨å¼•å¯¼ä¸­ï¼Œä½œè€…æ”¾å¼ƒäº†è®­ç»ƒå•ç‹¬çš„åˆ†ç±»å™¨æ¨¡å‹ï¼Œè½¬è€Œä½¿ç”¨ä¸€ä¸ªæ— åˆ†ç±»å™¨æ‰©æ•£æ¨¡å‹å’Œä¸€ä¸ªæ¡ä»¶æ‰©æ•£æ¨¡å‹ã€‚ä¸ºäº†æ¨å¯¼æ— åˆ†ç±»å™¨å¼•å¯¼ä¸‹çš„å¾—åˆ†å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé‡æ–°æ’åˆ—æ–¹ç¨‹(167)æ¥æ˜¾ç¤ºï¼š

$$
\begin{align}
    \nabla\log p(y\mid \boldsymbol{x}_t) = \nabla\log p(\boldsymbol{x}_t\mid y) - \nabla\log p(\boldsymbol{x}_t)
\end{align}
$$


ç„¶åï¼Œå°†è¿™ä¸ªä»£å…¥æ–¹ç¨‹(166)ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š
$$
\begin{align}
\nabla\log p(\boldsymbol{x}_t\mid y)
&= \nabla\log p(\boldsymbol{x}_t) + \gamma\left(\nabla\log p(\boldsymbol{x}_t\mid y) - \nabla\log p(\boldsymbol{x}_t)\right)\\
&= \nabla\log p(\boldsymbol{x}_t) + \gamma\nabla\log p(\boldsymbol{x}_t\mid y) - \gamma\nabla\log p(\boldsymbol{x}_t)\\
&= \underbrace{\gamma\nabla\log p(\boldsymbol{x}_t\mid y)}_\text{conditional score} + \underbrace{(1 - \gamma)\nabla\log p(\boldsymbol{x}_t)}_\text{unconditional score}
\end{align}
$$
å†ä¸€æ¬¡ï¼Œ$ \gamma $ æ˜¯ä¸€ä¸ªæ§åˆ¶æˆ‘ä»¬å­¦ä¹ çš„æ¡ä»¶æ¨¡å‹å…³å¿ƒæ¡ä»¶ä¿¡æ¯ç¨‹åº¦çš„é¡¹ã€‚å½“ $ \gamma = 0 $ æ—¶ï¼Œå­¦ä¹ çš„æ¡ä»¶æ¨¡å‹å®Œå…¨å¿½ç•¥æ¡ä»¶å™¨å¹¶å­¦ä¹ ä¸€ä¸ªæ— åˆ†ç±»å™¨æ‰©æ•£æ¨¡å‹ã€‚å½“ $ \gamma = 1 $ æ—¶ï¼Œæ¨¡å‹æ˜ç¡®å­¦ä¹ æ²¡æœ‰å¼•å¯¼çš„æ™®é€šæ¡ä»¶åˆ†å¸ƒã€‚å½“ $ \gamma > 1 $ æ—¶ï¼Œæ‰©æ•£æ¨¡å‹ä¸ä»…ä¼˜å…ˆè€ƒè™‘æ¡ä»¶å¾—åˆ†å‡½æ•°ï¼Œè€Œä¸”è¿˜å‘è¿œç¦»æ— åˆ†ç±»å™¨å¾—åˆ†å‡½æ•°çš„æ–¹å‘ç§»åŠ¨ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒå‡å°‘äº†ç”Ÿæˆä¸ä½¿ç”¨æ¡ä»¶ä¿¡æ¯çš„æ ·æœ¬çš„æ¦‚ç‡ï¼Œè€Œæœ‰åˆ©äºæ˜ç¡®ä½¿ç”¨æ¡ä»¶ä¿¡æ¯çš„æ ·æœ¬ã€‚è¿™ä¹Ÿé€šè¿‡ç‰ºç‰²æ ·æœ¬å¤šæ ·æ€§ä¸ºä»£ä»·ï¼Œå¢åŠ äº†ç”Ÿæˆä¸æ¡ä»¶ä¿¡æ¯å‡†ç¡®åŒ¹é…çš„æ ·æœ¬çš„å¯èƒ½æ€§ã€‚

ç”±äºå­¦ä¹ ä¸¤ä¸ªå•ç‹¬çš„æ‰©æ•£æ¨¡å‹æ˜¯æ˜‚è´µçš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¡ä»¶å’Œæ— åˆ†ç±»å™¨æ‰©æ•£æ¨¡å‹ä¸€èµ·ä½œä¸ºä¸€ä¸ªå•ä¸€çš„æ¡ä»¶æ¨¡å‹å­¦ä¹ ï¼›æ— åˆ†ç±»å™¨æ‰©æ•£æ¨¡å‹å¯ä»¥é€šè¿‡å°†æ¡ä»¶ä¿¡æ¯æ›¿æ¢ä¸ºå›ºå®šå¸¸æ•°å€¼ï¼ˆå¦‚é›¶ï¼‰æ¥æŸ¥è¯¢ï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯åœ¨æ¡ä»¶ä¿¡æ¯ä¸Šæ‰§è¡Œéšæœºdropoutã€‚æ— åˆ†ç±»å™¨å¼•å¯¼ä¹‹æ‰€ä»¥ä¼˜é›…ï¼Œæ˜¯å› ä¸ºå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿæ›´ç²¾ç»†åœ°æ§åˆ¶æˆ‘ä»¬çš„æ¡ä»¶ç”Ÿæˆè¿‡ç¨‹ï¼ŒåŒæ—¶ä¸éœ€è¦é™¤äº†è®­ç»ƒä¸€ä¸ªå•ä¸€çš„æ‰©æ•£æ¨¡å‹ä¹‹å¤–çš„ä»»ä½•ä¸œè¥¿ã€‚

## ç»“è¯­

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿™ç¯‡åšå®¢æ–‡ç« ä¸­çš„å‘ç°ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†å˜åˆ†æ‰©æ•£æ¨¡å‹ï¼ˆVariational Diffusion Modelsï¼‰æ¨å¯¼ä¸ºé©¬å°”å¯å¤«å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆMarkovian Hierarchical Variational Autoencoderï¼‰çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œå…¶ä¸­ä¸‰ä¸ªå…³é”®å‡è®¾ä½¿å¾—ELBOçš„è®¡ç®—å¯è¡Œå¹¶ä¸”ä¼˜åŒ–å¯æ‰©å±•ã€‚ç„¶åï¼Œæˆ‘ä»¬è¯æ˜äº†ä¼˜åŒ–VDMå½’ç»“ä¸ºå­¦ä¹ ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥é¢„æµ‹ä»¥ä¸‹ä¸‰ä¸ªæ½œåœ¨ç›®æ ‡ä¹‹ä¸€ï¼šä»ä»»ä½•éšæœºå™ªå£°ç‰ˆæœ¬ä¸­é¢„æµ‹åŸå§‹æºå›¾åƒï¼Œä»ä»»ä½•éšæœºå™ªå£°å›¾åƒä¸­é¢„æµ‹åŸå§‹æºå™ªå£°ï¼Œæˆ–è€…é¢„æµ‹ä»»æ„å™ªå£°æ°´å¹³ä¸‹å™ªå£°å›¾åƒçš„å¾—åˆ†å‡½æ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†å­¦ä¹ å¾—åˆ†å‡½æ•°çš„å«ä¹‰ï¼Œå¹¶é€šè¿‡Tweedieå…¬å¼æ˜ç¡®åœ°å°†æ‰©æ•£æ¨¡å‹çš„å˜åˆ†è§†è§’ä¸åŸºäºåˆ†æ•°çš„ç”Ÿæˆå»ºæ¨¡è§†è§’è”ç³»èµ·æ¥ã€‚æœ€åï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•é€šè¿‡å¼•å¯¼ä½¿ç”¨æ‰©æ•£æ¨¡å‹å­¦ä¹ æ¡ä»¶åˆ†å¸ƒã€‚

å°½ç®¡æ‰©æ•£æ¨¡å‹åœ¨ç”Ÿæˆå»ºæ¨¡æ–¹é¢å–å¾—äº†ä»¤äººéš¾ä»¥ç½®ä¿¡çš„æˆåŠŸï¼Œä½†ä»æœ‰ä¸€äº›ç¼ºç‚¹éœ€è¦è€ƒè™‘ï¼Œè¿™äº›ç¼ºç‚¹æ˜¯æœªæ¥å·¥ä½œä»¤äººå…´å¥‹çš„æ–¹å‘ï¼š

æˆ‘ä»¬äººç±»ä¼¼ä¹ä¸å¤ªå¯èƒ½ä»¥è¿™ç§æ–¹å¼è‡ªç„¶åœ°å»ºæ¨¡å’Œç”Ÿæˆæ•°æ®ï¼›æˆ‘ä»¬ä¼¼ä¹ä¸ä¼šå°†æ–°æ ·æœ¬ç”Ÿæˆä¸ºéšæœºå™ªå£°ï¼Œç„¶åé€æ­¥å»å™ªã€‚
å˜åˆ†æ‰©æ•£æ¨¡å‹ï¼ˆVDMï¼‰ä¸äº§ç”Ÿå¯è§£é‡Šçš„æ½œåœ¨è¡¨ç¤ºã€‚è€Œå˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰æœ‰æœ›é€šè¿‡ä¼˜åŒ–å…¶ç¼–ç å™¨å­¦ä¹ åˆ°ä¸€ä¸ªç»“æ„åŒ–çš„æ½œåœ¨ç©ºé—´ï¼Œä½†åœ¨VDMä¸­ï¼Œæ¯ä¸ªæ—¶é—´æ­¥çš„ç¼–ç å™¨å·²ç»è¢«ç»™å®šä¸ºçº¿æ€§é«˜æ–¯æ¨¡å‹ï¼Œå¹¶ä¸”ä¸èƒ½çµæ´»åœ°ä¼˜åŒ–ã€‚å› æ­¤ï¼Œä¸­é—´æ½œåœ¨è¡¨ç¤ºè¢«é™åˆ¶ä¸ºåŸå§‹è¾“å…¥çš„å™ªå£°ç‰ˆæœ¬ã€‚
æ½œåœ¨è¡¨ç¤ºè¢«é™åˆ¶ä¸ºä¸åŸå§‹è¾“å…¥ç›¸åŒçš„ç»´åº¦ï¼Œè¿™è¿›ä¸€æ­¥æŒ«è´¥äº†å­¦ä¹ æœ‰æ„ä¹‰ã€å‹ç¼©çš„æ½œåœ¨ç»“æ„çš„åŠªåŠ›ã€‚
é‡‡æ ·æ˜¯ä¸€ä¸ªæ˜‚è´µçš„è¿‡ç¨‹ï¼Œå› ä¸ºåœ¨ä¸¤ç§å…¬å¼ä¸‹éƒ½å¿…é¡»è¿è¡Œå¤šä¸ªå»å™ªæ­¥éª¤ã€‚ä¸ºäº†ç¡®ä¿æœ€ç»ˆæ½œåœ¨è¡¨ç¤ºå®Œå…¨æ˜¯é«˜æ–¯å™ªå£°ï¼Œæ—¶é—´æ­¥çš„æ•°é‡é€šå¸¸éå¸¸å¤§ï¼›åœ¨é‡‡æ ·æœŸé—´ï¼Œæˆ‘ä»¬å¿…é¡»è¿­ä»£æ‰€æœ‰è¿™äº›æ—¶é—´æ­¥æ¥ç”Ÿæˆä¸€ä¸ªæ ·æœ¬ã€‚

ä½œä¸ºæœ€åä¸€ç‚¹ï¼Œæ‰©æ•£æ¨¡å‹çš„æˆåŠŸçªæ˜¾äº†å±‚æ¬¡å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆHierarchical VAEsï¼‰ä½œä¸ºç”Ÿæˆæ¨¡å‹çš„å¼ºå¤§èƒ½åŠ›ã€‚æˆ‘ä»¬å·²ç»å±•ç¤ºäº†ï¼Œå½“æˆ‘ä»¬æ¨å¹¿åˆ°æ— é™çš„æ½œåœ¨å±‚æ¬¡æ—¶ï¼Œå³ä½¿ç¼–ç å™¨æ˜¯å¹³å‡¡çš„ï¼Œæ½œåœ¨ç»´åº¦æ˜¯å›ºå®šçš„ï¼Œä¸”å‡è®¾äº†é©¬å°”å¯å¤«è½¬æ¢ï¼Œæˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿå­¦ä¹ å¼ºå¤§çš„æ•°æ®æ¨¡å‹ã€‚è¿™è¡¨æ˜ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ·±åº¦å±‚æ¬¡VAEsï¼Œå…¶ä¸­å¯ä»¥æ½œåœ¨åœ°å­¦ä¹ åˆ°å¤æ‚çš„ç¼–ç å™¨å’Œè¯­ä¹‰ä¸Šæœ‰æ„ä¹‰çš„æ½œåœ¨ç©ºé—´ï¼Œå¯ä»¥å®ç°è¿›ä¸€æ­¥çš„æ€§èƒ½æå‡ã€‚
