# CyberBattleSim： 网络攻防模拟工具

## CyberBattleSim 是什么

CyberBattleSim是一款微软365 Defender团队开源的人工智能攻防对抗模拟工具，来源于微软的一个实验性研究项目。该项目专注于对网络攻击入侵后横向移动阶段进行威胁建模，用于研究在模拟抽象企业网络环境中运行的自动化智能体的交互。

网络拓扑和一组预定义的漏洞定义了进行模拟的环境。攻击者利用现有漏洞，通过横向移动在网络中进化，目标是通过利用计算机节点中植入的参数化漏洞来获取网络的所有权。防御者试图遏制攻击者并将其从网络中驱逐。 CyberBattleSim 为其模拟提供了 OpenAI Gym 接口，以促进强化学习算法的实验。

## 为什么要有模拟环境？

CyberBattleSim 仿真运行时环境提供高保真度和控制，框架中使用的是参数化的虚拟环境，模拟环境性能要求低，更轻量，速度快，抽象，并且可控性更强，适用于强化学习实验。优点如下：

- 抽象级别高，只需要建模系统重要的方面；例如应用程序级网络通信与数据包级网络模拟，忽略了低层的信息（例如，文件系统、注册表）。
- 灵活性：定义一个新的机器是很容易的，不需要考虑底层的驱动等，可以限制动作空间为可以管理且相关的子集。
- 可有效捕获全局状态，从而简化调试和诊断。
- 轻量级：在单台机器/进程的内存中运行。

CyberBattleSim的仿真固然简单，但是简单是具有优势的。高度抽象的性质使得无法直接应用于现实系统，从而防止了潜在的恶意训练的自动化智能体使用。同时，可以使我们更专注于特定的安全性方面，例如研究和快速实验最新的机器学习和AI算法。

当前的内网渗透实现方式侧重于横向移动，希望理解网络拓扑和配置并施加影响。基于这一目标，没有必要对实际的网络流量进行建模。

该项目主要采用了免模型学习（Model-Free），虽然在效率上不如有模型学习（Model-Based）（缺点是如果模型跟实际场景不一致，那么在实际使用场景下会表现的不好），但是这种方式更加容易实现，也容易在真实场景下调整到很好的状态。所以免模型学习方法更受欢迎，得到更加广泛的开发和测试。

## CyberBattleSim 的工作原理

### 将强化学习应用于安全

让我们通过一个Demo示例来介绍如何使用 RL 术语进行模拟。我们的网络环境由有向注释图给出，其中节点代表计算机，边代表其他节点的知识或节点之间发生的通信。

在强化学习背景下思考软件安全问题：攻击者或防御者可以被视为在计算机网络提供的环境中进化的智能体。他们的动作是可用的网络和计算机命令。攻击者的目标通常是从网络中窃取机密信息。防御者的目标是驱逐攻击者或通过执行其他类型的操作来减轻他们对系统的行为。

![图片.png](https://github.com/microsoft/CyberBattleSim/raw/main/docs/.attachments/image-377114ff-cdb7-4bee-88da-cac09640f661.png)

> *图 1. 将强化学习概念映射到安全领域*

CyberBattleSim中的强化学习建模：

- 环境：状态就是网络，单个智能体，部分可观测（智能体无法观测到所有的结点和边），静态的，确定性的，离散的，post-breach
- 行动空间（智能体可以逐步探索网络）：本地攻击，远程攻击，认证连接
- 观测空间：发现结点，获取结点，发现凭证，特权提升，可用攻击
- 奖励：基于结点的内在价值，如SQL server比测试机器重要

计算机网络系统比视频游戏复杂得多。虽然视频游戏通常一次允许执行少量操作，但与计算机和网络系统交互时，可以执行大量操作。例如，与棋盘游戏中有限的位置列表不同，网络系统的状态可能非常庞大，并且不易可靠地检索。

### CyberBattleSim 示例

CyberBattleSim 专注于对网络攻击的后入侵横向移动阶段进行威胁建模。该环境由计算机节点网络组成。它由固定的网络拓扑和一组预定义的漏洞参数化，智能体可以利用这些漏洞在网络中横向移动。模拟攻击者的目标是通过利用这些植入的漏洞来控制网络的某些部分。当模拟攻击者在网络中移动时，防御者智能体会监视网络活动以检测攻击者的存在并遏制攻击。

为了说明这一点，下图描绘了一个网络的简单示例，其中机器运行不同的操作系统、软件。每台机器都有一组属性、价值，并且都存在预先分配的漏洞。蓝色边缘代表节点之间运行的流量，并由通信协议标记。

![图片.png](https://github.com/microsoft/CyberBattleSim/raw/main/docs/.attachments/image-9f950a75-2c63-457a-b109-56091f84711a.png)

> *图 2. 计算机网络模拟中横向移动的直观表示*

该项目中的环境（environment）定义：

- 网络中结点的属性：如Windows，Linux，ApacheWebSite，MySql，nginx/1.10.3，SQLServer等。
- 开放的ports：如HTTPS，SSH，RDP，PING，GIT等。
- 本地漏洞包括：CredScanBashHistory，CredScan-HomeDirectory，CredScan-HomeDirectory等。
- 远程漏洞包括：ScanPageContent，ScanPageSource，NavigateWebDirectoryFurther，NavigateWebDirectory等。
- 防火墙配置为：允许进出的服务为RDP，SSH，HTTPS，HTTP，其他服务默认不允许。
- 定义了部分奖励与惩罚：发现新结点奖励，发现结点属性奖励，发现新凭证奖励，试图连接未打开端口的处罚，重复使用相同漏洞的惩罚等。

假设**智能体**代表攻击者。入侵后假设意味着一个节点最初感染了攻击者的代码（我们称攻击者*拥有*该节点）。模拟攻击者的**目标** 是通过发现并取得网络中节点的所有权来最大化累积奖励。环境是 **部分可观察的**：智能体无法提前看到网络图的所有节点和边。相反，攻击者采取行动，从其当前拥有的节点开始逐步探索网络。有 **三种类型的操作**，为智能体提供了开发和探索能力的混合：执行本地攻击、执行远程攻击和连接到其他节点。操作由底层操作应发生的源节点参数化，并且仅允许在智能体拥有的节点上执行。奖励 **是** 一个浮点数，表示节点的内在值（例如，SQL 服务器的价值大于测试机器）。

在图示的示例中，模拟攻击者从模拟的 Windows 7 节点（左侧，橙色箭头指向）入侵网络。它利用 SMB 文件共享协议中的漏洞横向移动到 Windows 8 节点，然后使用一些缓存的凭据登录另一台 Windows 7 计算机。然后，它利用 IIS 远程漏洞来控制 IIS 服务器，最后使用泄露的连接字符串访问 SQL DB。

该环境模拟了支持多个平台的异构计算机网络，并有助于展示如何使用最新的操作系统并使这些系统保持最新状态，从而使组织能够利用 Windows 10 等平台中最新的强化和保护技术。模拟 Gym 环境通过网络布局的定义、支持的漏洞列表以及漏洞所在的节点进行参数化。模拟不支持机器代码执行，因此实际上不会发生任何安全漏洞。我们改为使用定义以下内容的先决条件抽象地对漏洞进行建模：漏洞活跃的节点、成功利用的概率以及结果和副作用的高级定义。节点具有预先分配的命名属性，先决条件通过布尔公式表示。

防御 智能体主要通过预测攻击成功的可能性的基础之上实现了识别、减缓攻击的行为。主要通过重装镜像（re-image）的方式抵御攻击，通过计算攻击者的步骤数和持续性的奖励分数来衡量当前攻击策略的优劣性。通过返回的数据字段内容来确认各种攻击的成功性。(防御遍历所有节点，如果发现该节点可能存在漏洞（定义了一个概率函数计算可能性），先使该节点不可用，再通过重装镜像的方式抵御攻击）。

## 支持的漏洞和攻击类型

模拟环境由网络定义参数化，网络定义由底层网络图本身以及支持的漏洞及其所在节点的描述组成。由于模拟不运行任何代码，因此无法实际实现漏洞和利用。相反，我们通过定义以下内容对每个漏洞进行抽象建模： 确定漏洞在给定节点上是否处于活动状态的前提条件；攻击者成功利用它的概率；以及成功利用的副作用。每个节点都有一组分配的命名属性。然后，前置条件被表示为可能的节点属性（或标志）集上的布尔表达式。

### 漏洞结果

每个漏洞都有一个预定义的结果，其中可能包括：

- 一组泄露的凭据；
- 对网络中另一个节点的引用被泄露；
- 泄露节点信息（节点属性）；
- 节点的所有权；
- 节点上的权限升级。

远程漏洞的示例包括：

- 公开凭据的 SharePoint 站点`ssh`（但不一定是远程计算机的 ID）暴露；
- 授予计算机访问权限的*ssh* 漏洞；
- 在提交历史记录中泄露凭据的 GitHub 项目；
-  SharePoint 站点的文件包含存储帐户的 SAS Token；

本地漏洞示例：

- 从系统缓存中提取身份验证Token或凭据；
- 升级到SYSTEM权限；
- 升级至管理员权限。

漏洞可以在节点级别就地定义，也可以全局定义并由前置条件布尔表达式激活。

### 基准：衡量进展

我们提供了一个基本的随机防御者，它根据预定义的成功概率检测和缓解正在进行的攻击。为了比较智能体的性能，主要关注两个指标：为实现其目标而采取的模拟步骤数，以及跨训练时期模拟步骤的累积奖励。通过步骤梳理与累计的分数，评估最先进的强化学习算法，以研究自主智能体如何与它们交互并从中学习。

## 安全问题建模

Gym 环境的可参数化特性允许对各种安全问题进行建模。以一个Demo示例为例，在下图所示的计算机系统上玩的“夺旗”游戏。

![图片.png](https://github.com/microsoft/CyberBattleSim/raw/main/docs/.attachments/image-8cfbbc68-6db1-42f2-867d-5502ff56c4b3.png)

例如，下面的代码片段受到[夺旗](https://en.wikipedia.org/wiki/Capture_the_flag#Computer_security)挑战的启发，其中攻击者的目标是夺取网络中有价值的节点和资源的所有权。我们在[toy_ctf.py](https://github.com/microsoft/CyberBattleSim/blob/main/cyberbattle/samples/toyctf/toy_ctf.py)的 Python 代码中正式定义了这个网络。以下是代码片段，展示了我们如何定义节点`Website`及其属性、防火墙配置和植入的漏洞：

```python
nodes = {
    "Website": m.NodeInfo(
        services=[
            m.ListeningService("HTTPS"),
            m.ListeningService("SSH", allowedCredentials=[
                    "ReusedMySqlCred-web"])],
        firewall=m.FirewallConfiguration(
                    incoming=default_allow_rules,
                    outgoing=default_allow_rules
                    + [
                        m.FirewallRule("su", m.RulePermission.ALLOW),
                        m.FirewallRule("sudo", m.RulePermission.ALLOW)]),
        value=100,
        properties=["MySql", "Ubuntu", "nginx/1.10.3"],
        owned_string="FLAG: Login using insecure SSH user/password",
        vulnerabilities=dict(
            ScanPageContent=m.VulnerabilityInfo(
                description="Website page content shows a link to GitHub repo",
                type=m.VulnerabilityType.REMOTE,
                outcome=m.LeakedNodesId(["GitHubProject"]),
                reward_string="page content has a link to a Github project",
                cost=1.0
            ),
            ScanPageSource=m.VulnerabilityInfo(
                description="Website page source contains refrence to"
                            "browseable relative web directory",
                type=m.VulnerabilityType.REMOTE,
                outcome=m.LeakedNodesId(["Website.Directory"]),
                reward_string="Viewing the web page source reveals a URL to"
                              "a .txt file and directory on the website",
                cost=1.0
            ),
            ...
            )
    ),
    ...
```

> *图 4.**描述模拟环境实例的**代码*

我们提供了一个 Jupyter 笔记本，以便在此示例中以交互方式扮演攻击者：

### CyberBattleSim 实例过程

*通过 Gym 界面，我们可以轻松实例化自动化智能体，并观察它们在此类环境中的演变情况。下面的屏幕截图显示了在此模拟中运行随机智能体*的结果- 即在模拟的每个步骤中随机选择要执行的操作的智能体。

![图片.png](https://github.com/microsoft/CyberBattleSim/raw/main/docs/.attachments/image-cdb2b5e1-92f9-4a9e-af9f-b1a9bcae96a5.png)

> *图 5. 与模拟交互的随机智能体*

Jupyter 笔记本中的上图显示了累积奖励函数如何随着模拟步长（左）和探索的网络图（右）而增长，其中受感染的节点以红色标记。在这次运行中，大约需要 500 步才能达到此状态。日志显示许多尝试的操作都失败了，一些是因为防火墙规则阻止了流量，一些是因为使用了错误的凭据。在现实世界中，这种不稳定的行为应该会迅速触发警报，而防御性 XDR 系统（如 Microsoft 365 Defender）和 SIEM/SOAR 系统（如 Azure Sentinel）会迅速做出反应并驱逐恶意行为者。

这种Demo示例为攻击者提供了一种最佳策略，只需大约 20 次操作即可完全控制网络。人类玩家平均需要大约 50 次操作才能在第一次尝试中赢得这场游戏。由于网络是静态的，经过反复玩，人类可以记住正确的奖励动作顺序，并可以快速确定最佳解决方案。

### 项目中强化学习算法比较

使用多种算法在环境中获得的结果`CyberBattleChain10`：分别为Tabular Q-learning, Credential lookups, DQL(deep Q-learning), Exploiting DQL。

为了进行基准测试，我们创建了一个大小可变的简单Demo环境，并尝试了各种强化算法。下图总结了结果，其中 Y 轴是在多次重复的Epiosode（X 轴）中采取的完全控制网络的行动数量（越低越好）。如图所示，其中X轴是在多个episode，（Y轴）中为获得网络的完全所有权而采取的迭代数量（越低越好）。某些算法（如Exploiting DQL）随着episode增加可以逐渐改进并达很高水平，而有些算法在50 episode后仍在苦苦挣扎！

![image.png](https://github.com/microsoft/CyberBattleSim/raw/main/docs/.attachments/image-54d83b7b-65d1-4d6a-b0f6-d41b31460c81.png)

累积奖励图提供了另一种比较方式，其中智能体每次感染一个节点都会获得奖励。深色线表示中位数，而阴影表示一个标准差。这再次表明某些智能体（红色、蓝色和绿色）的表现明显优于其他智能体（橙色）。

![image.png](https://github.com/microsoft/CyberBattleSim/raw/main/docs/.attachments/image-f8f00fe7-466f-4d2b-aaee-dd20720854db.png)

## CyberBattleSim 评估

项目的优势

1. 借助OpenAI工具包，可以为复杂的计算机系统构建高度抽象的模拟，可视化的图像表达，使用户可以容易看到这些智能体的进化行为，通过步骤梳理与累计的分数，可以对当前的场景有个较好的展示，并评估出最合适的强化学习算法（其中经过实验得到的结果为Exploiting DQL算法最优
2. CyberBattleSim的仿真固然简单，但是简单是具有优势的。高度抽象的性质使得无法直接应用于现实系统，从而防止了潜在的恶意训练的自动化智能体使用。同时，这种简单可以更专注于特定的安全性方面，例如研究和快速试验最新的机器学习和AI算法。项目目前专注于横向移动技术，目的是了解网络拓扑和配置如何影响这些技术。考虑到这样的目标，微软认为没有必要对实际的网络流量进行建模，但这是该项目实际应用的重大限制。
3. 该项目相比于其他强化学习自动化渗透项目：如DEEPEXPLOIT框架，AutoPentest-DRL框架，这两个框架都使用了强化学习，nmap扫描，Metasploit攻击，但是他们并没有有效利用强化学习，主要原因在于他们的action只是根据各种漏洞对应相应的payload获取shell，该模式更像是监督学习，因为没有环境观察与反馈。CyberBattleSim项目有它自己的优势，虽然该项目并没有实现真实攻击，但是该项目完整地诠释了强化学习的步骤（包含观察环境与反馈），如果能开发出合适的工具使用，那么就可以实现更高效，准确度更高的渗透。

项目存在的问题

1. CyberBattleSim 除了提供智能体之外还可以通过Gym的基础提供参数化构建的虚拟网络环境、漏洞类型、漏洞出现的节点等。所以该项目其实只是一个强化学习的自动化攻击框架，并没有进行实际的攻击，网络中的所有节点，漏洞，漏洞类型等都是使用各种参数自定义的。

2. 该项目的攻击方式包括本地攻击，远程攻击和连接其他节点，每种攻击只举了几个例子，然而实际过程中远远不止于此，需要学习训练就会是一个很耗时的过程。且该项目采用免模型学习（虽然该方法会更适用于当前网络环境），实际渗透中因为攻击方式众多，需要训练的时间也会更长，具体学习渗透的时间犹未可知。

3. CyberBattleSim项目提供的只是自动化攻击内网渗透项目当中必不可少的沙盒，只是一个用户产生虚拟攻防场景数据的工具，距离真实的项目还有很长的路要走，现有的强化学习最好的例子只存在于游戏（2016年：AlphaGo Master 击败李世石，使用强化学习的 AlphaGo Zero 仅花了40天时间；2019年4月13日：OpenAI 在《Dota2》的比赛中战胜了人类世界冠军），对于复杂的自动化攻击并不一定能胜任。

项目的发展

该项目更适合比较强化学习算法在内网渗透的优劣，因为该项目高度虚拟化，不考虑底层网络的信息，要使该项目成为一个真实的内网渗透工具是一个极大挑战。如下列出可能对该项目有所贡献的改进：

1. 实现一个类似端口扫描操作(非确定性)的nmap，用来收集信息，而且该步骤不仅仅是渗透的开始工作，在渗透过程中也需要更新信息。
2. 与现有的攻击工具结合或者开发更适合强化学习模型的攻击工具，用来真实的攻击。
3. 奖励的定义也是强化学习中重要的一项内容，可以通过通用漏洞评分系统（CVSS）的组成部分所确定的漏洞得分来定义。

## 总结

本文针对自动化内网渗透这一方向对微软的开源项目CyberBattleSim做了介绍，通过对其内部原理和源码的分析，笔者指出了该项目的优势，存在的问题及其发展前景。该项目只是自动化攻击内网渗透项目中必不可少的沙盒，自动化渗透还有很长的路要走。
