# Verl ç›¸å…³ç‰¹æ€§ä»‹ç»

- VeRLæ¡†æ¶çš„è®ºæ–‡ï¼ˆ[HybridFlow]ï¼‰ï¼š[https://arxiv.org/pdf/2409.19256](https://arxiv.org/pdf/2409.19256)

- VeRLæ¡†æ¶çš„å®˜æ–¹è§£è¯»ï¼š[https://mp.weixin.qq.com/s/JYQQs2vqnhRz82rtDI-1OQ](https://mp.weixin.qq.com/s/JYQQs2vqnhRz82rtDI-1OQ)

- ä»“åº“åœ°å€ï¼š[https://github.com/volcengine/verl](https://github.com/volcengine/verl)

- - Docsï¼š[Welcome to verlâ€™s documentation!](https://verl.readthedocs.io/en/)

- çŸ¥ä¹ä¸Šçš„ä¸€äº›é˜…è¯»ç¬”è®°ï¼š

- - https://zhuanlan.zhihu.com/p/26833089345
  - https://zhuanlan.zhihu.com/p/25763072556



## Verl  ä»‹ç»

### 1. RLï¼ˆPost-Trainingï¼‰å¤æ‚è®¡ç®—æµç¨‹ç»™ LLM è®­ç»ƒå¸¦æ¥å…¨æ–°çš„æŒ‘æˆ˜

åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œæ•°æ®æµï¼ˆDataFlowï¼‰æ˜¯ä¸€ç§é‡è¦çš„è®¡ç®—æ¨¡å¼æŠ½è±¡ï¼Œç”¨äºè¡¨ç¤ºæ•°æ®ç»è¿‡ä¸€ç³»åˆ—å¤æ‚è®¡ç®—åå®ç°ç‰¹å®šåŠŸèƒ½ã€‚ç¥ç»ç½‘ç»œçš„è®¡ç®—å°±æ˜¯å…¸å‹çš„ DataFlow ï¼Œå¯ä»¥ç”¨è®¡ç®—å›¾ï¼ˆComputational Graphï¼‰æ¥æè¿°ï¼Œå…¶ä¸­èŠ‚ç‚¹ä»£è¡¨è®¡ç®—æ“ä½œï¼Œè¾¹è¡¨ç¤ºæ•°æ®ä¾èµ–ã€‚

å¤§æ¨¡å‹ RL çš„è®¡ç®—æµç¨‹æ¯”ä¼ ç»Ÿç¥ç»ç½‘ç»œæ›´ä¸ºå¤æ‚ã€‚åœ¨ RLHF ä¸­ï¼Œéœ€è¦åŒæ—¶è®­ç»ƒå¤šä¸ªæ¨¡å‹ï¼Œå¦‚ Actor ã€Critic ã€å‚è€ƒç­–ç•¥ï¼ˆReference Policyï¼‰å’Œå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€’å¤§é‡æ•°æ®ã€‚è¿™äº›æ¨¡å‹æ¶‰åŠä¸åŒçš„è®¡ç®—ç±»å‹ï¼ˆå‰å‘åå‘ä¼ æ’­ã€ä¼˜åŒ–å™¨æ›´æ–°ã€è‡ªå›å½’ç”Ÿæˆç­‰ï¼‰ï¼Œå¯èƒ½é‡‡ç”¨ä¸åŒçš„å¹¶è¡Œç­–ç•¥ã€‚

ä¼ ç»Ÿçš„åˆ†å¸ƒå¼ RL é€šå¸¸å‡è®¾æ¨¡å‹å¯åœ¨å•ä¸ª GPU ä¸Šè®­ç»ƒï¼Œæˆ–ä½¿ç”¨æ•°æ®å¹¶è¡Œæ–¹å¼ [4,5]ï¼Œå°†æ§åˆ¶æµå’Œè®¡ç®—æµåˆå¹¶åœ¨åŒä¸€è¿›ç¨‹ä¸­ã€‚è¿™åœ¨å¤„ç†å°è§„æ¨¡æ¨¡å‹æ—¶æ•ˆæœè‰¯å¥½ï¼Œä½†é¢å¯¹å¤§æ¨¡å‹ï¼Œè®­ç»ƒéœ€è¦å¤æ‚çš„å¤šç»´å¹¶è¡Œï¼Œæ¶‰åŠå¤§é‡åˆ†å¸ƒå¼è®¡ç®—ï¼Œä¼ ç»Ÿæ–¹æ³•éš¾ä»¥åº”å¯¹ã€‚

###  2. HybridFlow è§£è€¦æ§åˆ¶æµå’Œè®¡ç®—æµï¼Œå…¼é¡¾çµæ´»é«˜æ•ˆ

å¤§æ¨¡å‹ RL æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªäºŒç»´çš„ DataFlow é—®é¢˜ï¼šhigh-level çš„æ§åˆ¶æµï¼ˆæè¿° RL ç®—æ³•çš„æµç¨‹ï¼‰+ low-level çš„è®¡ç®—æµï¼ˆæè¿°åˆ†å¸ƒå¼ç¥ç»ç½‘ç»œè®¡ç®—ï¼‰ã€‚

è¿‘æœŸå¼€æºçš„ RLHF æ¡†æ¶ï¼Œå¦‚ DeepSpeed-Chat [6]ã€OpenRLHF [7] å’Œ NeMo-Aligner [8]ï¼Œé‡‡ç”¨äº†ç»Ÿä¸€çš„å¤šæ§åˆ¶å™¨ï¼ˆMulti-Controllerï¼‰æ¶æ„ã€‚å„è®¡ç®—èŠ‚ç‚¹ç‹¬ç«‹ç®¡ç†è®¡ç®—å’Œé€šä¿¡ï¼Œé™ä½äº†æ§åˆ¶è°ƒåº¦çš„å¼€é”€ã€‚ç„¶è€Œï¼Œæ§åˆ¶æµå’Œè®¡ç®—æµé«˜åº¦è€¦åˆï¼Œå½“è®¾è®¡æ–°çš„ RL ç®—æ³•ï¼Œç»„åˆç›¸åŒçš„è®¡ç®—æµå’Œä¸åŒçš„æ§åˆ¶æµæ—¶ï¼Œéœ€è¦é‡å†™è®¡ç®—æµä»£ç ï¼Œä¿®æ”¹æ‰€æœ‰ç›¸å…³æ¨¡å‹ï¼Œå¢åŠ äº†å¼€å‘éš¾åº¦ã€‚

ä¸æ­¤å‰æ¡†æ¶ä¸åŒï¼ŒHybridFlow é‡‡ç”¨äº†æ··åˆç¼–ç¨‹æ¨¡å‹ï¼Œæ§åˆ¶æµç”±å•æ§åˆ¶å™¨ï¼ˆSingle-Controllerï¼‰ç®¡ç†ï¼Œå…·æœ‰å…¨å±€è§†å›¾ï¼Œå®ç°æ–°çš„æ§åˆ¶æµç®€å•å¿«æ·ï¼Œè®¡ç®—æµç”±å¤šæ§åˆ¶å™¨ï¼ˆMulti-Controllerï¼‰è´Ÿè´£ï¼Œä¿è¯äº†è®¡ç®—çš„é«˜æ•ˆæ‰§è¡Œï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„æ§åˆ¶æµä¸­å¤ç”¨ã€‚

å°½ç®¡ç›¸æ¯”çº¯ç²¹çš„å¤šæ§åˆ¶å™¨æ¶æ„ï¼Œè¿™å¯èƒ½å¸¦æ¥ä¸€å®šçš„æ§åˆ¶è°ƒåº¦å¼€é”€ï¼Œä½† HybridFlow é€šè¿‡ä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼Œé™ä½äº†æ§åˆ¶æµä¸è®¡ç®—æµä¹‹é—´çš„ä¼ è¾“é‡ï¼Œå…¼é¡¾äº†çµæ´»æ€§å’Œé«˜æ•ˆæ€§ã€‚

### 3. ç³»ç»Ÿè®¾è®¡ä¹‹ä¸€ï¼šHybrid Programming Model (ç¼–ç¨‹æ¨¡å‹åˆ›æ–°)

#### æ¡†æ¶é€»è¾‘åˆ†æ

![img](https://pic3.zhimg.com/v2-120db60c9af032bb5ddaab7ba831221e_1440w.jpg)



è¿™æ˜¯ç›®å‰verlè®­ç»ƒæ¡†æ¶çš„é…ç½®æƒ…å†µï¼Œå¯¹äºä¸åŒçš„è®­ç»ƒè§’è‰²ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„é¢„è®­ç»ƒæ¨¡å‹åŠè®­ç»ƒåç«¯çš„æ”¯æŒï¼ˆå¤šæ§åˆ¶å™¨)ã€‚éšåå°†ä»–ä»¬ä¸`main_ppo.py`ä¸­å¯¹åº”çš„è§’è‰²è¿›è¡Œç»‘å®šï¼Œç„¶åä»¥å‚æ•°çš„å½¢å¼ä¼ å…¥åˆ°`ray_trainer.py`ä¸­è¿›è¡Œè°ƒç”¨ã€‚å¯¹äºtraineræ–‡ä»¶ä¸­å®é™…æ˜¯ä»¥ä¸€ä¸ªå•æ§åˆ¶æµå‡½æ•°`fit()`çš„æ–¹å¼æ¥è¿›è¡Œï¼Œåªéœ€è¦ä»å¯¹åº”çš„æ¨¡å‹ä¸­è·å¾—è®¡ç®—å€¼çš„æƒ…å†µï¼Œç„¶åå†å¯¼å…¥åˆ°å¯¹åº”çš„ç®—æ³•æ¨¡å—ä¸å·¥å…·æ¨¡å—ä¸­ï¼Œå°±å¯ä»¥å¿«é€Ÿçš„å¼€å±•RLè®­ç»ƒä»»åŠ¡ã€‚

1.è¿è¡Œæ¡†æ¶ä¸­æµ…é»„è‰²è¡¨ç¤ºæ¨ç†æ¡†æ¶ï¼Œæ·±é»„è‰²è¡¨ç¤ºè®­ç»ƒæ¡†æ¶

2.è™šçº¿æ¨¡å—è¡¨ç¤ºåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¹¶ä¸ä¸€å®šè¢«éœ€è¦ï¼Œå¯ä»¥ç»“åˆè®­ç»ƒç®—æ³•è¿›è¡Œåˆ å‡

3.Rewardæ¨¡å‹æœ‰åŸºäºæ¨¡å‹ä¸åŸºäºè§„åˆ™çš„æ–¹æ³•ï¼Œå¹¶ä¸”ç›®å‰è®­ç»ƒæ¨ç†æ¡†æ¶å¯èƒ½éƒ½æœ‰æ”¯æŒï¼Œæ‰€ä»¥æš‚æ—¶å†™ä¸ºoptionalã€‚

4.Actoræ¨¡å—ç”±äºè¦è¿›è¡Œrolloutå’Œtrainingä¸¤ä¸ªé˜¶æ®µï¼Œå› æ­¤ä¼šåœ¨è®­ç»ƒå’Œæ¨ç†æ¡†æ¶ä¹‹é—´è¿›è¡Œåˆ‡æ¢(verlä¸­åœ¨`sharding_manager`æ–‡ä»¶ç›®å½•ä¸‹)

#### 3.1 å°è£…å•æ¨¡å‹åˆ†å¸ƒå¼è®¡ç®—

åœ¨ HybridFlow ä¸­ï¼Œæ¯ä¸ªæ¨¡å‹ï¼ˆå¦‚ Actorã€Criticã€å‚è€ƒç­–ç•¥ã€å¥–åŠ±æ¨¡å‹ç­‰ï¼‰çš„åˆ†å¸ƒå¼è®¡ç®—è¢«å°è£…ä¸ºç‹¬ç«‹çš„æ¨¡å—ï¼Œç§°ä¸ºæ¨¡å‹ç±»ã€‚

è¿™äº›æ¨¡å‹ç±»ç»§æ‰¿äºåŸºç¡€çš„å¹¶è¡Œ Worker ç±»ï¼ˆå¦‚ 3DParallelWorker ã€FSDPWorker ç­‰ï¼‰ï¼Œé€šè¿‡æŠ½è±¡çš„ API æ¥å£ï¼Œå°è£…äº†æ¨¡å‹çš„å‰å‘ã€åå‘è®¡ç®—ã€ä¼˜åŒ–å™¨æ›´æ–°å’Œè‡ªå›å½’ç”Ÿæˆç­‰æ“ä½œã€‚è¯¥å°è£…æ–¹å¼æé«˜äº†ä»£ç çš„å¤ç”¨æ€§ï¼Œä¾¿äºæ¨¡å‹çš„ç»´æŠ¤å’Œæ‰©å±•ã€‚

å¯¹äºä¸åŒçš„ RL æ§åˆ¶æµï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥å¤ç”¨å°è£…å¥½çš„æ¨¡å‹ç±»ï¼ŒåŒæ—¶è‡ªå®šä¹‰éƒ¨åˆ†ç®—æ³•æ‰€éœ€çš„æ•°å€¼è®¡ç®—ï¼Œå®ç°ä¸åŒç®—æ³•ã€‚å½“å‰ HybridFlow å¯ä½¿ç”¨ Megatron-LM [13] å’Œ PyTorch FSDP [14] ä½œä¸ºè®­ç»ƒåç«¯ï¼ŒåŒæ—¶ä½¿ç”¨ vLLM [15] ä½œä¸ºè‡ªå›å½’ç”Ÿæˆåç«¯ï¼Œæ”¯æŒç”¨æˆ·ä½¿ç”¨å…¶ä»–æ¡†æ¶çš„è®­ç»ƒå’Œæ¨ç†è„šæœ¬è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/IrH3BAPESuiahEibicAGHwOUHDjGSoSsicz8mibzJMoGH9c0bPYbbjOWBUiciaFBV3STgEM6HXIW3Vvmib3k6AOJnWt3uQ/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



#### 3.2 çµæ´»çš„æ¨¡å‹éƒ¨ç½²

HybridFlow æä¾›äº†èµ„æºæ± ï¼ˆResourcePoolï¼‰æ¦‚å¿µï¼Œå¯ä»¥å°†ä¸€ç»„ GPU èµ„æºè™šæ‹ŸåŒ–ï¼Œå¹¶ä¸ºæ¯ä¸ªæ¨¡å‹åˆ†é…è®¡ç®—èµ„æºã€‚ä¸åŒçš„èµ„æºæ± å®ä¾‹å¯ä»¥å¯¹åº”ä¸åŒè®¾å¤‡é›†åˆï¼Œæ”¯æŒä¸åŒæ¨¡å‹åœ¨åŒä¸€ç»„æˆ–ä¸åŒç»„ GPU ä¸Šéƒ¨ç½²ã€‚è¿™ç§çµæ´»çš„æ¨¡å‹éƒ¨ç½²æ–¹å¼ï¼Œæ»¡è¶³äº†ä¸åŒç®—æ³•ã€æ¨¡å‹å’Œç¡¬ä»¶ç¯å¢ƒä¸‹çš„èµ„æºå’Œæ€§èƒ½éœ€æ±‚ã€‚

![img](https://pica.zhimg.com/v2-677f0e776144e14a21c6fa7af61acde6_1440w.jpg)

é¦–å…ˆæ„å»ºçš„å››ç±»æ¨¡å‹ï¼Œä¼šé€šè¿‡Rayï¼Œæ˜ å°„æ”¾ç½®åˆ°ä¸åŒçš„æœºå™¨ä¸Šã€‚éšå

ï¼ˆ1ï¼‰å…ˆä½¿ç”¨vllmæ¡†æ¶å’Œpromptå¯¹Actorå…ˆè¿›è¡Œresponseçš„è¾“å‡ºï¼ˆä½¿ç”¨ä¸“ç”¨æ¨ç†æ¡†æ¶å¯ä»¥è®©æ¨ç†çš„é€Ÿåº¦æ›´å¿«ï¼‰ã€‚

ï¼ˆ2ï¼‰ç„¶åå°†è¾“å‡ºçš„ç»“æœè¾“å…¥ç»™å…¶ä»–ä¸‰ä¸ªæ¡†æ¶è¿›è¡Œè¿è¡Œï¼ˆä¸€èˆ¬ä½¿ç”¨è®­ç»ƒæ¡†æ¶ï¼Œå› ä¸ºè®­ç»ƒæ¡†æ¶å¯ä»¥é¿å…ç²¾åº¦é—®é¢˜ï¼‰ï¼Œä»¥è·å¾—åœ¨RLç®—æ³•(ä¾‹å¦‚PPOï¼ŒGRPOç­‰æ¡†æ¶)æ‰€éœ€è¦çš„è®¡ç®—è¾“å…¥ã€‚

ï¼ˆ3ï¼‰æœ€åç»“åˆè®¡ç®—ç»“æœï¼Œå†ä½¿ç”¨è®­ç»ƒæ¡†æ¶æ¥å¯¹Actorå’ŒCriticæ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚

#### 3.3 ç»Ÿä¸€æ¨¡å‹é—´çš„æ•°æ®åˆ‡åˆ†

åœ¨å¤§æ¨¡å‹ RL è®¡ç®—æµç¨‹ä¸­ï¼Œä¸åŒæ¨¡å‹ä¹‹é—´çš„æ•°æ®ä¼ è¾“æ¶‰åŠå¤æ‚çš„å¤šå¯¹å¤šå¹¿æ’­å’Œæ•°æ®é‡åˆ†ç‰‡ã€‚

ä¸ºè§£å†³è¯¥é—®é¢˜ï¼ŒHybridFlow è®¾è®¡äº†ä¸€å¥—é€šç”¨æ•°æ®ä¼ è¾“åè®®ï¼ˆTransfer Protocolï¼‰ï¼ŒåŒ…æ‹¬æ”¶é›†ï¼ˆcollectï¼‰å’Œåˆ†å‘ï¼ˆdistributeï¼‰ä¸¤ä¸ªéƒ¨åˆ†ã€‚

é€šè¿‡åœ¨æ¨¡å‹ç±»çš„æ“ä½œä¸Šæ³¨å†Œç›¸åº”çš„ä¼ è¾“åè®®ï¼Œæ¯”å¦‚ï¼š@register(transfer_mode=3D_PROTO)ï¼ŒHybridFlow å¯ä»¥åœ¨æ§åˆ¶å™¨å±‚ï¼ˆSingle-Controllerï¼‰ç»Ÿä¸€ç®¡ç†æ•°æ®çš„æ”¶é›†å’Œåˆ†å‘ï¼Œå®ç°æ¨¡å‹é—´æ•°æ®çš„è‡ªåŠ¨é‡åˆ†ç‰‡ï¼Œæ”¯æŒä¸åŒå¹¶è¡Œåº¦ä¸‹çš„æ¨¡å‹é€šä¿¡ã€‚

HybridFlow æ¡†æ¶å·²ç»æ”¯æŒå¤šç§æ•°æ®ä¼ è¾“åè®®ï¼Œæ¶µç›–å¤§éƒ¨åˆ†æ•°æ®é‡åˆ‡åˆ†åœºæ™¯ã€‚åŒæ—¶ï¼Œç”¨æˆ·å¯çµæ´»åœ°è‡ªå®šä¹‰æ”¶é›†ï¼ˆcollectï¼‰å’Œåˆ†å‘ï¼ˆdistributeï¼‰å‡½æ•°ï¼Œå°†å…¶æ‰©å±•åˆ°æ›´å¤æ‚çš„æ•°æ®ä¼ è¾“åœºæ™¯ã€‚



![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/IrH3BAPESuiahEibicAGHwOUHDjGSoSsicz8licpiakd4SicTbHtIgeia5U18HXyuJyic8elNC8iaQ5CTM43zcScfAzzq3pA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



#### 3.4 æ”¯æŒå¼‚æ­¥ RL æ§åˆ¶æµ

åœ¨ HybridFlow ä¸­ï¼Œæ§åˆ¶æµéƒ¨åˆ†é‡‡ç”¨å•æ§åˆ¶å™¨æ¶æ„ï¼Œå¯çµæ´»å®ç°å¼‚æ­¥ RL æ§åˆ¶æµã€‚

å½“æ¨¡å‹éƒ¨ç½²åœ¨ä¸åŒè®¾å¤‡é›†åˆä¸Šæ—¶ï¼Œä¸åŒæ¨¡å‹è®¡ç®—å¯å¹¶è¡Œæ‰§è¡Œï¼Œè¿™æé«˜äº†ç³»ç»Ÿçš„å¹¶è¡Œåº¦å’Œæ•ˆç‡ã€‚å¯¹äºéƒ¨ç½²åœ¨åŒä¸€ç»„è®¾å¤‡ä¸Šçš„æ¨¡å‹ï¼ŒHybridFlow é€šè¿‡è°ƒåº¦æœºåˆ¶å®ç°äº†é¡ºåºæ‰§è¡Œï¼Œé¿å…èµ„æºäº‰å¤ºå’Œå†²çªã€‚

#### 3.5 å°‘é‡ä»£ç çµæ´»å®ç°å„ç§ RL æ§åˆ¶æµç®—æ³•


å¾—ç›Šäºæ··åˆç¼–ç¨‹æ¨¡å‹çš„è®¾è®¡ï¼ŒHybridFlow å¯ä»¥æ–¹ä¾¿åœ°å®ç°å„ç§ RLHF ç®—æ³•ï¼Œå¦‚ PPO [9]ã€ReMax [10]ã€Safe-RLHF [11]ã€GRPO [12] ç­‰ã€‚ç”¨æˆ·åªéœ€è°ƒç”¨æ¨¡å‹ç±»çš„ API æ¥å£ï¼ŒæŒ‰ç®—æ³•é€»è¾‘ç¼–å†™æ§åˆ¶æµä»£ç ï¼Œæ— éœ€å…³å¿ƒåº•å±‚çš„åˆ†å¸ƒå¼è®¡ç®—å’Œæ•°æ®ä¼ è¾“ç»†èŠ‚ã€‚

ä¾‹å¦‚ï¼Œå®ç° PPO ç®—æ³•åªéœ€å°‘é‡ä»£ç ï¼Œé€šè¿‡è°ƒç”¨ actor.generate_sequences ã€critic.compute_values ç­‰å‡½æ•°å³å¯å®Œæˆã€‚åŒæ—¶ï¼Œç”¨æˆ·åªéœ€è¦ä¿®æ”¹å°‘é‡ä»£ç å³å¯è¿ç§»åˆ° Safe-RLHF ã€ReMax ä»¥åŠ GRPO ç®—æ³•ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/IrH3BAPESuiahEibicAGHwOUHDjGSoSsicz8Y3fibjOtmOpOHUfCiaiaQicDiaPLBmWebhI2cB4BQTPc6D5KX08AhAawDvA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



### 4. ç³»ç»Ÿè®¾è®¡ä¹‹äºŒï¼š3D-HybridEngine ï¼ˆè®­ç»ƒæ¨ç†æ··åˆæŠ€æœ¯ï¼‰é™ä½é€šä¿¡å†…å­˜å¼€é”€

åœ¨ Online RL ç®—æ³•ä¸­ï¼ŒActor æ¨¡å‹éœ€è¦åœ¨è®­ç»ƒå’Œç”Ÿæˆï¼ˆRolloutï¼‰é˜¶æ®µä¹‹é—´é¢‘ç¹åˆ‡æ¢ï¼Œä¸”ä¸¤ä¸ªé˜¶æ®µå¯èƒ½é‡‡ç”¨ä¸åŒå¹¶è¡Œç­–ç•¥ã€‚

å…·ä½“è€Œè¨€ï¼Œè®­ç»ƒé˜¶æ®µï¼Œéœ€è¦å­˜å‚¨æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼Œæ¨¡å‹å¹¶è¡Œåº¦ï¼ˆModel Parallel Size, MPï¼‰å¯èƒ½ç›¸åº”å¢é«˜ï¼Œè€Œç”Ÿæˆé˜¶æ®µï¼Œæ¨¡å‹æ— éœ€å­˜å‚¨æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼ŒMP å’Œæ•°æ®å¹¶è¡Œåº¦ï¼ˆData Parallel Size, DPï¼‰å¯èƒ½è¾ƒå°ã€‚å› æ­¤ï¼Œåœ¨ä¸¤ä¸ªé˜¶æ®µä¹‹é—´ï¼Œæ¨¡å‹å‚æ•°éœ€è¦é‡æ–°åˆ†ç‰‡å’Œåˆ†é…ï¼Œä¾èµ–ä¼ ç»Ÿé€šä¿¡ç»„æ„å»ºæ–¹æ³•ä¼šå¸¦æ¥é¢å¤–é€šä¿¡å’Œå†…å­˜å¼€é”€ã€‚

æ­¤å¤–ï¼Œä¸ºäº†åœ¨æ–°çš„å¹¶è¡Œåº¦é…ç½®ä¸‹ä½¿ç”¨æ¨¡å‹å‚æ•°ï¼Œé€šå¸¸éœ€è¦åœ¨æ‰€æœ‰ GPU ä¹‹é—´è¿›è¡Œå…¨èšåˆï¼ˆAll-Gatherï¼‰æ“ä½œï¼Œå¸¦æ¥äº†å·¨å¤§çš„é€šä¿¡å¼€é”€ï¼Œå¢åŠ äº†è¿‡æ¸¡æ—¶é—´ã€‚

ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHybridFlow è®¾è®¡äº† 3D-HybridEngine ï¼Œæå‡äº†è®­ç»ƒå’Œç”Ÿæˆè¿‡ç¨‹æ•ˆç‡ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/IrH3BAPESuiahEibicAGHwOUHDjGSoSsicz89JadxTZdMK7U6TpPrLY53F7icJZ8wmjiapJsvoaFL5rpQkOUtmt1BvjA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

æ³¨ï¼š3D-HybridEngine ä¸€æ¬¡è¿­ä»£çš„æµç¨‹

3D-HybridEngine é€šè¿‡ä¼˜åŒ–å¹¶è¡Œåˆ†ç»„æ–¹æ³•ï¼Œå®ç°äº†é›¶å†—ä½™çš„æ¨¡å‹å‚æ•°é‡ç»„ï¼Œå…·ä½“åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

- å®šä¹‰ä¸åŒçš„å¹¶è¡Œç»„

åœ¨è®­ç»ƒå’Œç”Ÿæˆé˜¶æ®µï¼Œ3D-HybridEngine ä½¿ç”¨ä¸åŒçš„ä¸‰ç»´å¹¶è¡Œé…ç½®ï¼ŒåŒ…æ‹¬ï¼šæµæ°´çº¿å¹¶è¡Œï¼ˆPPï¼‰ã€å¼ é‡å¹¶è¡Œï¼ˆTPï¼‰å’Œæ•°æ®å¹¶è¡Œï¼ˆDPï¼‰çš„å¤§å°ã€‚è®­ç»ƒé˜¶æ®µçš„å¹¶è¡Œé…ç½®ä¸º ğ‘-ğ‘¡-ğ‘‘ ã€‚åœ¨ç”Ÿæˆé˜¶æ®µï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªæ–°çš„å¾®æ•°æ®å¹¶è¡Œç»„ï¼ˆMicro DP Groupï¼Œğ‘‘ğ‘”ï¼‰ï¼Œç”¨äºå¤„ç† Actor æ¨¡å‹å‚æ•°å’Œæ•°æ®çš„é‡ç»„ã€‚ç”Ÿæˆé˜¶æ®µçš„å¹¶è¡Œé…ç½®ä¸º ğ‘ğ‘”-ğ‘¡ğ‘”-ğ‘‘ğ‘”-ğ‘‘ ã€‚

- é‡ç»„æ¨¡å‹å‚æ•°è¿‡ç¨‹

é€šè¿‡å·§å¦™åœ°é‡æ–°å®šä¹‰ç”Ÿæˆé˜¶æ®µçš„å¹¶è¡Œåˆ†ç»„ï¼Œå¯ä»¥ä½¿æ¯ä¸ª GPU åœ¨ç”Ÿæˆé˜¶æ®µå¤ç”¨è®­ç»ƒé˜¶æ®µå·²æœ‰çš„æ¨¡å‹å‚æ•°åˆ†ç‰‡ï¼Œé¿å…åœ¨ GPU å†…å­˜ä¸­ä¿å­˜é¢å¤–çš„æ¨¡å‹å‚æ•°ï¼Œæ¶ˆé™¤å†…å­˜å†—ä½™ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/IrH3BAPESuiahEibicAGHwOUHDjGSoSsicz89NqZ1EfmvTr6SC22vgCTFPZibVqTvnXB65VhWorqMwt4CMyvEfxibZIw/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



- å‡å°‘é€šä¿¡å¼€é”€

å‚æ•°é‡ç»„è¿‡ç¨‹ä¸­ï¼Œ3D-HybridEngine ä»…åœ¨æ¯ä¸ªå¾®æ•°æ®å¹¶è¡Œç»„ï¼ˆMicro DP Groupï¼‰å†…è¿›è¡Œ All-Gather æ“ä½œï¼Œè€Œéæ‰€æœ‰ GPU ä¹‹é—´è¿›è¡Œã€‚è¿™å¤§å¤§å‡å°‘äº†é€šä¿¡é‡ï¼Œé™ä½è¿‡æ¸¡æ—¶é—´ï¼Œæé«˜äº†æ•´ä½“çš„è®­ç»ƒæ•ˆç‡ã€‚



# Verl æºç è§£æ





## æ ¸å¿ƒä»£ç é˜…è¯»

### ä»£ç ç»“æ„

VeRLä»“åº“çš„æ ¸å¿ƒä»£ç é€»è¾‘ï¼ˆ[verl](https://github.com/volcengine/verl/)ï¼‰æ ‘å¦‚ä¸‹æ‰€ç¤ºï¼š

![img](https://picx.zhimg.com/v2-e53bc000f470ea3c9c0c747afa8ff1df_1440w.jpg)



### Trainer ç»„ä»¶

traineræ–‡ä»¶ä¸‹ä¸»è¦æ”¾ç½®äº†æ ¸å¿ƒçš„è®­ç»ƒé€»è¾‘ï¼Œä¸»è¦å°è£…äº†æ•´ä½“RLç®—æ³•çš„æ§åˆ¶æµç¨‹ã€‚ç›®å‰æ”¯æŒçš„è®­ç»ƒé€»è¾‘åŒ…æ‹¬ï¼š

#### 1. SFT

fsdp_sft_trainer.pyï¼šåŸºäºFSDPï¼ˆdpsd zero3ï¼‰å®ç°çš„SFTè®­ç»ƒé€»è¾‘ï¼Œverlæ”¯æŒåœ¨RLè®­ç»ƒå‰é€šè¿‡sftæ¥cold-start policyï¼›

1. åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªTorch-nativeçš„FSDPæ ‡å‡†Trainerçš„å®ç°ï¼›

2. åŸºäºulysesså®ç°äº†sftè®­ç»ƒæ—¶å¯¹è¶…é•¿åºåˆ—çš„åºåˆ—å¹¶è¡Œæ”¯æŒï¼›

3. Devicemeshï¼štorch2.2å¼•å…¥çš„æ–°æœºåˆ¶ï¼Œç”¨äºç®¡ç†è®¾å¤‡&è¿›ç¨‹ç»„ä¹‹é—´çš„NCCLæ•°æ®é€šä¿¡ã€‚Verlå€Ÿç”¨äº†è¯¥æœºåˆ¶ç®€åŒ–äº†å¯¹äºæ•°æ®ä¼ è¾“çš„æ§åˆ¶é€»è¾‘ã€‚
   1. æ–‡æ¡£ï¼š[https://pytorch.org/tutorials/recipes/distributed_device_mesh.html](https://pytorch.org/tutorials/recipes/distributed_device_mesh.html)
   2. Devicemeshå¯¹äºç®¡ç†å„ç§å¹¶è¡Œï¼ˆæ¨¡å‹ã€æ•°æ®å¹¶è¡Œï¼‰æ—¶è®¾å¤‡ä¹‹é—´çš„é€šä¿¡éå¸¸æœ‰ç”¨ï¼Œä¸å†éœ€è¦æ‰‹æ’¸è¿›ç¨‹ç»„ï¼Œä»¥åŠæ‰‹åŠ¨ç®¡ç†rankå’Œæ‹“æ‰‘äº†ï¼Œæ–¹ä¾¿å¾ˆå¤šï¼›


#### 2. PPO/GRPO/[Reinforce++](https://zhida.zhihu.com/search?content_id=254557983&content_type=Article&match_order=1&q=Reinforce%2B%2B&zhida_source=entity)/RLOOç­‰RLç®—æ³•

1. main_ppo.pyï¼šRLç®—æ³•çš„å…¥å£ç¨‹åºï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªä¸»è¦åŠŸèƒ½ï¼š

   1. é€‰æ‹©å¥–åŠ±å‡½æ•°ï¼ˆmodel-based or rule-basedï¼‰ï¼ŒåŸºäºReward Managerä»¥åŠç”¨æˆ·è‡ªå®šä¹‰çš„æ‰“åˆ†è§„åˆ™ï¼ˆä¸€èˆ¬å®šä¹‰åœ¨utils/reward_scoreç›®å½•ä¸‹ï¼‰ï¼›
   2. å¯ä»¥æ ¹æ®æ•°æ®é›†ä¸­æ¯æ¡æ ·æœ¬æŒ‡å®šçš„reward_styleï¼Œé€‰æ‹©é’ˆå¯¹æ€§çš„reward funcï¼›

2. é€‰æ‹©è®­ç»ƒåç«¯ï¼ˆFSDP or Megatronï¼‰ï¼š

   1. Verlæ”¯æŒåŸºäºFSDPå’ŒMegatronä¸¤å¥—åç«¯è¿›è¡Œæ¨¡å‹çš„è®­ç»ƒå’Œå‰å‘ä¼ æ’­æ¨ç†ï¼Œåè€…ä¸»è¦åœ¨æ¨¡å‹è§„æ¨¡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä½†æ˜¯è‡ªå®šä¹‰çš„ä¿®æ”¹æ¯”è¾ƒéº»çƒ¦ï¼Œæ”¯æŒæ–°æ¶æ„æ¯”è¾ƒéº»çƒ¦ï¼Œä¸€èˆ¬å­¦æœ¯ç•ŒFSDPåç«¯å°±å¤Ÿç”¨äº†ã€‚å·¥ä¸šç•Œè¿½æ±‚æè‡´æ€§èƒ½æ—¶ä¼šéœ€è¦megatronï¼Œå¯ä»¥è¿›è¡Œè®¸å¤šå®šåˆ¶åŒ–çš„ä¼˜åŒ–æ¥æå‡è®­ç»ƒååï¼›
   2. è°ƒç”¨RayPPOTrainerè¿›è¡Œå…·ä½“çš„è®­ç»ƒæµç¨‹ï¼›
      1. å…ˆè°ƒç”¨trainerçš„init_workerså‡½æ•°åˆå§‹åŒ–å„ä¸ªrlè§’è‰²çš„workergroupï¼Œç„¶åè°ƒç”¨fitå‡½æ•°æ‰§è¡Œå®é™…çš„è®­ç»ƒ

3. RayPPOTrainer.pyï¼š

   1. åˆå§‹åŒ–RLä¸­çš„å„ä¸ªRoleï¼šRLç®—æ³•ä¸­æœ¬èº«æ¶‰åŠè¾ƒå¤šè§’è‰²ï¼ˆActorã€Criticã€RMã€Refï¼‰çš„åä½œï¼Œéœ€è¦é¢„å…ˆå®šä¹‰å¥½å„ä¸ªæ¨¡å‹çš„è§’è‰²ï¼Œæ¶‰åŠresource_poolçš„å®šä¹‰å’Œåˆ†é…ã€workerdictå’Œworkergroupçš„åˆå§‹åŒ–å’Œåˆ†é…ï¼›
   2. WorkerGroupæœºåˆ¶æ”¯æŒäº†æ¯ç±»colocate model groupçš„å…·ä½“å®ç°ï¼ŒåŒ…å«ï¼š
      1. actor_rollout_wgï¼šæ”¯æŒactorã€generatoräºŒè€…äº’ç›¸åˆ‡æ¢ï¼ˆé€šè¿‡reload/offload paramså’Œreshardï¼‰çš„hybrid engineï¼›
      2. critic_wgï¼ˆå¯é€‰ï¼‰ï¼šæ”¯æŒcriticè§’è‰²ï¼Œä»…ppoéœ€è¦ï¼›
      3. ref_policy_wgï¼ˆå¯é€‰ï¼‰ï¼šæ”¯æŒreferenceè§’è‰²ï¼Œå¼€å¯kléœ€è¦ï¼›
      4. rm_wgï¼ˆå¯é€‰ï¼‰ï¼šæ”¯æŒRMè§’è‰²ï¼Œmodel based rewardéœ€è¦ï¼›
      5. ç”±init_workersæ–¹æ³•åˆå§‹åŒ–èµ„æºæ± å’Œå„ä¸ªworker groupï¼›
   3. ResourcePoolManagerï¼šèµ„æºæ± ç®¡ç†ï¼Œå°è£…rayçš„placement_groupï¼Œå°†æŒ‡å®šçš„è§’è‰²åˆç†åˆ†é…åˆ°è®¾å¤‡ä¸Šï¼›

4. å®ç°äº†ä¸€äº›PPOç®—æ³•è®¡ç®—lossæ‰€éœ€è¦çš„å‡½æ•°ï¼Œå¦‚ï¼š

   1. apply_kl_penaltyï¼šè®¡ç®—PPOçš„token-level kl rewardï¼›

   2. KL lossæ˜¯åœ¨core_algos.pyé‡Œé¢å®ç°çš„ï¼›

   3. compute_advantageï¼šè®¡ç®—ä¼˜åŠ¿å‡½æ•°çš„é€»è¾‘ï¼Œæ ¸å¿ƒç®—æ³•ä¾ç„¶æ˜¯åœ¨core_algos.pyé‡Œé¢å®ç°çš„ï¼›

   4. VeRLåŒæ—¶æ”¯æŒPPO/GRPO/Reinforce++/RLOO/Remaxç­‰ç®—æ³•ï¼Œè¿™äº›RLç®—æ³•çš„æ ¸å¿ƒåŒºåˆ«ç‚¹åœ¨äºadvantageæ˜¯å¦‚ä½•è®¡ç®—çš„ï¼ˆcriticé¢„æµ‹baselineï¼Œgroupè®¡ç®—baselineï¼Œbatchå†…ç•™ä¸€æ³•ç­‰ç­‰ï¼‰ï¼Œå› æ­¤VeRLé€‰æ‹©å°†adv_estimatorå•ç‹¬å‡ºä¸€å¥—é€»è¾‘ï¼Œä¸»ä½“åŒæ ·æ˜¯æ”¾åœ¨core_algos.pyå†…éƒ¨ï¼›

   5. å®ç°äº†ä¸€äº›timerï¼Œmetricè®¡ç®—çš„å‡½æ•°ï¼ˆcompute_data_metricsã€compute_timing_metricsï¼‰ï¼Œä»¥åŠsave/loadç­‰æ–­ç‚¹ç»­è®­å’Œckptä¿å­˜çš„é€»è¾‘ï¼ˆ_save_checkpointã€_load_checkpointï¼‰ï¼Œè¿˜æœ‰validateçš„é€»è¾‘ï¼ˆ_validateï¼‰å’Œdpè´Ÿè½½å‡è¡¡çš„é€»è¾‘ï¼ˆ_balance_batchï¼‰çš„é€»è¾‘ç­‰ç­‰ï¼›

   6. fitæ–¹æ³•å®ç°äº†rlç®—æ³•çš„å®Œæ•´çš„training loopï¼Œè°ƒç”¨äº†å„ä¸ªworkerè¿›è¡Œå®é™…çš„è®¡ç®—ï¼›

      éœ€è¦æ³¨æ„ï¼Œfitæ–¹æ³•æ˜¯åœ¨å•è¿›ç¨‹è¿è¡Œçš„ï¼Œå› æ­¤å¦‚æœæ˜¯åœ¨ray clusterä¸Šè¿è¡Œï¼Œå°½å¯èƒ½ä¸è¦æŠŠtrainerè°ƒåº¦åœ¨headèŠ‚ç‚¹ä¸Šï¼Œå¯èƒ½è´Ÿè½½å‹åŠ›ä¼šæ¯”è¾ƒå¤§ï¼›

####  3. main_generation.py é€‚ç”¨äºç¦»çº¿ç”Ÿæˆ

#### 4. main_eval.py è¯„ä¼°ä»£ç 

#### 5. core_algos.py

core_algos.py æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–‡ä»¶ï¼ŒåŒ…å«äº†ï¼š

1. å„ç§lossçš„è®¡ç®—é€»è¾‘ï¼š
   1. policy_lossï¼ˆè®­ç»ƒpolicy modelï¼Œå³actorï¼‰,
   2. value_lossï¼ˆè®­ç»ƒvalue modelï¼Œå³criticï¼‰ï¼Œ
   3. entropy_lossï¼ˆpolicy modelè®­ç»ƒçš„é¢å¤–trick lossï¼Œé€šè¿‡ç†µæ­£åˆ™æå‡é‡‡æ ·å¤šæ ·æ€§ï¼‰ï¼Œ
   4. kl_lossï¼ˆgrpoç­‰ç®—æ³•ä¼šæŠŠkl losså¤–ç½®ï¼‰ï¼›
2. å„ç§advantageçš„è®¡ç®—é€»è¾‘ï¼š
   1. å„ä¸ªrlç®—æ³•çš„æ ¸å¿ƒåŒºåˆ†ç‚¹ä¸»è¦åœ¨advå¦‚ä½•å®ç°ï¼Œè¿™é‡Œå®ç°äº†å„ç§rlç®—æ³•çš„adv estimationï¼›

å„ç±»RLè®­ç»ƒè¿‡ç¨‹ä¸­çš„å·¥ç¨‹å’Œç®—æ³•è¶…å‚å¯ä»¥å‚è€ƒdocï¼š[Config Explanation](https://verl.readthedocs.io/en/latest/examples/config.html)



### Workersç»„ä»¶

workersæ–‡ä»¶å¤¹ä¸‹å®šä¹‰äº†RLä¸­å„ä¸ªè§’è‰²çš„workerï¼ˆhigh-levelï¼Œä¸»è¦è´Ÿè´£æè¿°é€»è¾‘ï¼‰ï¼Œä»¥åŠå„ä¸ªè§’è‰²è®¡ç®—æ—¶å®é™…ä¾èµ–çš„workerï¼ˆlow-levelï¼Œä¸»è¦è´Ÿè´£æè¿°è¿ç®—ï¼‰ï¼›

è¿™é‡Œå†å›é¡¾ä¸€ä¸‹ï¼šworkerè¢«workerdictå°è£…åï¼Œæ¯ä¸ªè®¾å¤‡ï¼ˆGPUï¼‰ä¼šè¿è¡Œä¸€ä¸ªã€‚ä¸€ä¸ªcolocateçš„RL è§’è‰²ä¾æ‰˜WorkerGroupè¿›è¡Œç®¡ç†ï¼Œæ¯ä¸ªworkergroupä¸‹ç®¡ç†ç€ä¸€ç»„è¿œç¨‹è¿è¡Œçš„ workersã€‚WorkerGroup ä½œä¸ºsingle controllerä¸ workers ä¹‹é—´çš„ä¸­ä»‹ã€‚æˆ‘ä»¬å°† worker çš„æ–¹æ³•ç»‘å®šåˆ° WorkerGroup çš„æ–¹æ³•ä¸Šï¼Œé€šè¿‡è£…é¥°å™¨å®ç°å…·ä½“çš„æ–¹æ³•æ‰§è¡Œ/æ•°æ®åˆ†å‘çš„é€»è¾‘ã€‚

#### 1. fsdp_workers.pyï¼š

åŸºäºFSDPè®­ç»ƒåç«¯ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—RLè®­ç»ƒè¿‡ç¨‹ä¸­å¯èƒ½ä½¿ç”¨çš„Workerã€‚è¿™äº›workersæ˜¯åŸºäºå®é™…è´Ÿè´£è¿ç®—çš„workerï¼ˆåé¢ä¼šä»‹ç»ï¼‰æ‰€è¿›è¡Œçš„è¿›ä¸€æ­¥å°è£…ï¼›

##### ActorRolloutRefWorkerï¼š

1. å¯ä»¥é€‰æ‹©æ‰®æ¼”å•ç‹¬çš„RLä¸­çš„Actorï¼ˆPolicy Modelï¼‰ã€Rolloutï¼ˆè´Ÿè´£generate responseï¼‰ã€Referenceï¼ˆè´Ÿè´£æä¾›ref_log_probè®¡ç®—KLï¼‰ï¼›
2. å¯ä»¥é€‰æ‹©åŸºäºhybrid engineï¼ŒåŒæ—¶æ‰®æ¼”å¤šä¸ªè§’è‰²ï¼Œç„¶åverlé€šè¿‡å‚æ•°çš„offload/reload/reshardè¿›è¡Œçµæ´»çš„åˆ‡æ¢ï¼›
3. ç›®å‰æ”¯æŒäº†Data Parallelismï¼ˆfsdpï¼‰å’ŒSequence Parallelismï¼ˆcontextç»´åº¦ï¼ŒåŸºäºulysesså®ç°ï¼‰ï¼›
4. å…³é”®æ–¹æ³•ï¼š
   1. init_modelï¼šæ ¹æ®configæŒ‡å®šçš„modelç±»å‹ï¼Œæ¥åˆå§‹åŒ–å½“å‰workerï¼š
   2. update_actorï¼š
      1. åŸºäºDataParallelPPOActorçš„update_policyï¼Œè®¡ç®—policy-Losså¹¶æ›´æ–°Policyæ¨¡å‹çš„æƒé‡ï¼›
      2. åŸºäºulysses_sharding_manageræ”¯æŒsequence parallelçš„æ•°æ®å‰å¤„ç†å’Œåå¤„ç†ï¼Œä»è€Œå®ç°åºåˆ—å¹¶è¡Œï¼›

   3. generate_sequencesï¼š
      1. åŸºäºvllmå°è£…çš„rolloutå¼•æ“ï¼Œæ¨ç†ç”Ÿæˆæ•°æ®ï¼Œä½¿ç”¨rollout_sharding_managerç®¡ç†æ•°æ®çš„å½¢çŠ¶ï¼Œmatch rolloutå¼•æ“çš„åˆ‡åˆ†ï¼›
      2. compute_log_probï¼šåŸºäºactorçš„è®­ç»ƒå¼•æ“ï¼ŒåŒæ­¥è®¡ç®—old_logprobsï¼Œæ–¹ä¾¿è¿›è¡Œimportance samplingï¼›

   4. compute_ref_log_prob: åŸºäºè®­ç»ƒå¼•æ“ï¼Œè®¡ç®—ref_logprobsï¼Œæ–¹ä¾¿è®¡ç®—kl constraintï¼›
   5. save_checkpoint/load_checkpointï¼šå®ç°æ¨¡å‹å‚æ•°çš„offload/reloadï¼Œä»¥åŠä¿å­˜åˆ°å¤–éƒ¨ç¡¬ç›˜ï¼›
   6. _build_model_optimizerï¼š
      1. æŒ‡å®šoptim_configä¸€èˆ¬æ˜¯actorï¼Œéœ€è¦åŸºäºFSDPè¿›è¡Œè®­ç»ƒï¼Œéœ€è¦åˆå§‹åŒ–fsdp wrapçš„æ¨¡å‹ï¼ˆè¿›ä¸€æ­¥ä¼ ç»™DataParallelPPOActorå°è£…ï¼‰ã€optimizerå’Œlr_schedulerï¼›
      2. ä¸æŒ‡å®šoptim_configä¸€èˆ¬æ˜¯refï¼Œç»Ÿä¸€æ¨ç†å¼•æ“å’Œè®­ç»ƒå¼•æ“ï¼Œç¡®ä¿KLè®¡ç®—çš„æ•°å€¼å‡†ç¡®æ€§ï¼›

   7. æ‰€æœ‰çš„æ¶‰åŠè¿ç®—çš„å‡½æ•°ï¼Œéƒ½æœ‰dispatch_modeè£…é¥°å™¨ï¼Œä»¥å®ç°workergroupå†…éƒ¨çš„æ•°æ®ä¼ è¾“é€»è¾‘ï¼ˆsingle-controllerçš„è®¾è®¡æ¨¡å¼ï¼‰ï¼›


##### CriticWorkerï¼š

1. å’ŒActorRolloutRefWorkeré€»è¾‘å¤§ä½“ä¸€è‡´ï¼Œåªä¸è¿‡åŸºäºçš„åç«¯æ˜¯DataParallelPPOCriticï¼›
2. ä¸éœ€è¦rolloutï¼Œä¸”é¢å¤–å¤šå‡ºäº†compute_valuesè¿™ä¸ªæ“ä½œï¼Œé€šè¿‡value headè®¡ç®—token-level valueä»¥ä¾¿PPOè®¡ç®—Advï¼›

##### RewardModelWorkerï¼š

1. åŸºäºæ¨¡å‹çš„RMæ‰“åˆ†å®ç°ï¼›



#### 2. megatron_workers.pyï¼š

megatron_workers.py åŸºäºmegatronåç«¯å®ç°çš„RL workersï¼›

1. åŸºäºmegatronæ”¯æŒ4Då¹¶è¡Œï¼ŒDPã€TPã€SPã€PPï¼›
2. æ ¸å¿ƒé€»è¾‘åŸºæœ¬å’ŒFSDPç‰ˆæœ¬ä¸€è‡´ï¼Œä½†æ˜¯åº•å±‚é€»è¾‘éœ€è¦é€‚é…megatronæ¡†æ¶ï¼›

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹å…·ä½“çš„Actorè¿ç®—Workerï¼Œå®ƒä»¬è¢«æ”¾ç½®åœ¨å½“å‰ç›®å½•çš„å­æ–‡ä»¶å¤¹ä¸‹ï¼Œé»˜è®¤éƒ½æœ‰fdspï¼ˆtorch-nativeï¼‰å’Œmegatronä¸¤ä¸ªå†™æ³•çš„ç‰ˆæœ¬ï¼Œä»¥å…¼å®¹ä¸¤å¥—è®­ç»ƒå¼•æ“ï¼š

##### Actorï¼š

1. RLç®—æ³•ï¼ˆå¦‚PPOï¼‰ä¸­æ‰®æ¼”Actorè§’è‰²çš„Workerï¼ˆReference modelä¹Ÿå¯ä»¥å€Ÿç”¨ï¼‰ï¼›
2. æ ¸å¿ƒåŠŸèƒ½æœ‰ï¼š
   1. compute_log_probï¼šä¸ºäº†è®¡ç®—KLæˆ–è€…Importance Samplingï¼Œå‰å‘ä¼ æ’­æ¨ç†å¾—åˆ°å„tokenä½ç½®çš„logitså’Œå¯¹æ•°æ¦‚ç‡ï¼›
   2. update_policyï¼šåŸºäºé¢„å…ˆè®¡ç®—å¥½çš„advantageï¼Œè®¡ç®—policy lossã€entropy losså’Œkl lossï¼Œç„¶åæ›´æ–°policy modelï¼›

##### Criticï¼š

1. Actor-Critic-based RLç®—æ³•ï¼ˆå¦‚PPOï¼‰ä¸­æ‰®æ¼”Criticè§’è‰²çš„Workerï¼›
2. æ ¸å¿ƒåŠŸèƒ½æœ‰ï¼š
   1. compute_valuesï¼šè®¡ç®—Valuesï¼Œå‚ä¸è®¡ç®—PPOç®—æ³•çš„advantageï¼›
   2. update_criticï¼šè®¡ç®—value lossï¼Œç„¶åæ›´æ–°value modelï¼›

##### Reward_modelï¼š

1. åŸºäºModel-basedçš„æ‰“åˆ†æ¨¡å‹ï¼Œè®¡ç®—response-level rewardï¼›
2. æ ¸å¿ƒåŠŸèƒ½ä¸»è¦å°±æ˜¯compute_rewardï¼›
3. rule-based rewardä¸éœ€è¦ï¼›

##### Rolloutï¼š

1. æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯åœ¨è®­ç»ƒæ—¶å€™rollout responseï¼Œä¸»è¦å‡½æ•°ä¸ºgenerate_sequencesï¼›
2. æ”¯æŒä¸åŒçš„ç”Ÿæˆå¼•æ“åç«¯ï¼š
   1. åŸç”Ÿçš„rollouté€»è¾‘ï¼Œæœ€ç®€å•çš„ä»logits->softmax->samplingçš„é€»è¾‘ï¼›
   2. huggingface TGIåç«¯çš„rollouté€»è¾‘ï¼›
   3. vllmçš„rollouté€»è¾‘ï¼›
      1. ç›®å‰å¼€æºç‰ˆæœ¬çš„æ¨ç†å¼•æ“ä»¥vllmä¸ºä¸»ï¼Œä½†sglangä¹Ÿåœ¨æ¥å…¥ä¸­ï¼›
      2. åŸºäºthird_partyä¸­ä¿®æ”¹çš„vllm engineè¿›è¡Œæ¨ç†ï¼›
      3. repreaté‡‡æ ·æ²¡æœ‰ä½¿ç”¨n_sampleså‚æ•°è€Œæ˜¯ç›´æ¥repeat_interleaveè¾“å…¥ï¼Œå¤šæ¬¡ç”Ÿæˆï¼›
      4. old_log_probsæ²¡æœ‰ä½¿ç”¨vllmå¼•æ“å¾—åˆ°çš„ç»“æœï¼Œä¸ºäº†ç¡®ä¿importance samplingå’Œkl divergenceè®¡ç®—çš„å‡†ç¡®æ€§ï¼Œè¦ç”¨è®­ç»ƒå¼•æ“ï¼ˆFSDPæˆ–è€…Megatronï¼‰ç»Ÿä¸€è®¡ç®—ï¼Œé¿å…å¼•æ“ä¸åŒå¸¦æ¥çš„è¯¯å·®ï¼›

æ­¤å¤–ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹è¿˜æœ‰sharding_managerï¼Œä¸»è¦æ˜¯è´Ÿè´£ç®¡ç†ä¸åŒçš„parallelismä¸‹çš„shardingï¼ŒåŒ…æ‹¬ï¼š

1. data shardingï¼ˆpreprocess_dataï¼Œpostprocess_dataï¼‰ï¼›
2. device meshçš„ç®¡ç†ï¼›
3. æ¨¡å‹å‚æ•°çš„reload & offloadé€»è¾‘ï¼ˆåŸºäºä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰



### Single Controllerç»„ä»¶

å®ç°verlçš„æ ¸å¿ƒæ··åˆç¼–ç¨‹æ¨¡å‹çš„é‡ç‚¹ï¼Œå³åŸºäºsingle controlleræœºåˆ¶å»ç®¡ç†RLçš„æ§åˆ¶æµï¼›

1. Workerï¼šæ–¹ä¾¿ç®¡ç†workerè¿›ç¨‹åœ¨workergroupè¿›ç¨‹ç»„å†…éƒ¨çš„ä¿¡æ¯ï¼ˆå¦‚rank_idå’Œworld_sizeï¼‰ï¼Œä»¥åŠèµ„æºåˆ†é…çš„ä¿¡æ¯ï¼›

2. ResourcePoolï¼šç®¡ç†æŸä¸ªèµ„æºæ± ï¼ŒåŒ…æ‹¬æ± å†…èŠ‚ç‚¹ä¿¡æ¯å’Œè¿›ç¨‹ä¿¡æ¯ï¼›

3. Workergroupï¼šç®¡ç†å¤šä¸ªworkeræ‰€ç»„æˆçš„workergroupï¼Œå¦‚è´Ÿè´£ç®¡ç†data parallelismã€‚æœ€é‡è¦çš„å‡½æ•°æ˜¯_bind_worker_methodï¼š

4. 1. å°†ç”¨æˆ·å®šä¹‰çš„æ–¹æ³•bindåˆ°WorkerGroupå®ä¾‹ä¸Šï¼›
   2. å¤„ç†è¢«@registerè£…é¥°å™¨ä¿®é¥°çš„æ–¹æ³•ï¼›
   3. é…ç½®æ•°æ®åˆ†å‘/æ”¶é›†æ¨¡å¼å’Œæ‰§è¡Œæ¨¡å¼ï¼›
   4. åŒæ­¥æ‰§è¡Œå½“å‰groupå†…æ‰€æœ‰workerçš„è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”æ ¹æ®åˆ†å‘&æ‰§è¡Œæ¨¡å¼æ­£ç¡®ç®¡ç†æ‰§è¡Œé€»è¾‘å’Œæ•°æ®ä¼ è¾“é€»è¾‘ï¼›

5. Decoratorï¼šä¸»è¦å®šä¹‰äº†å„ç§workerçš„æ•°æ®åˆ†å‘å’Œå‡½æ•°æ‰§è¡Œæ¨¡å¼çš„è£…é¥°å™¨ï¼Œè£…é¥°åï¼Œworkergroupåœ¨æ‰§è¡Œworkerçš„æ–¹æ³•æ—¶ï¼Œå°†ä¼šé€šè¿‡è£…é¥°å™¨è‡ªåŠ¨é…ç½®æ•°æ®åˆ†å‘å’Œæ‰§è¡Œçš„æ¨¡å¼ï¼›

6. Rayï¼šè¯¥å¤„ä»£ç ä¸»è¦æ˜¯åŸºäºrayåç«¯ï¼Œå»ç®¡ç†worker(WorkerDict)å’Œworkergroup(RayWorkerGroup)ã€‚é€šè¿‡Pythonè¯­æ³•ç³–ï¼Œå®ç°äº†workerçš„method rebindï¼Œä»¥è®©åŒä¸€ä¸ªworkergroupåœ¨ä¸åŒçš„rlè§’è‰²ä¹‹é—´çµæ´»åˆ‡æ¢ï¼›



### Modelsç»„ä»¶

ä¸»è¦åŒ…å«å¸¸è§æ¨¡å‹ç»“æ„ï¼ˆä¸»è¦æ˜¯llamaç»“æ„å’Œqwen2ç»“æ„ï¼Œå…è®¸ç”¨æˆ·é›†æˆæ›´å¤šçš„ç»“æ„ï¼‰çš„å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼š

1. Transformersç‰ˆæœ¬çš„æ¨¡å‹ç»“æ„å®šä¹‰ï¼š

2. 1. FSDPç‰ˆæœ¬çš„RLè®­ç»ƒæ¨ç†ã€Rolloutå¼•æ“ã€å¯¼å‡ºæ¨¡å‹æƒé‡éœ€è¦ä½¿ç”¨ï¼›
   2. è‡ªå®šä¹‰æ–°çš„æ¨¡å‹ç»“æ„ï¼š[Add models with the FSDP backend](https://verl.readthedocs.io/en/latest/advance/fsdp_extension.html)

3. Megatronç‰ˆæœ¬çš„æ¨¡å‹ç»“æ„å®šä¹‰ï¼š

4. 1. Megatronç‰ˆæœ¬çš„RLè®­ç»ƒæ¨ç†éœ€è¦ä½¿ç”¨ï¼›
   2. Megatronç‰ˆæœ¬éœ€é’ˆå¯¹4D Parallelismåšè¾ƒå¤šçš„é€‚é…ï¼›
   3. è‡ªå®šä¹‰æ–°çš„æ¨¡å‹ç»“æ„ï¼š[Add models with the Megatron-LM backend](https://verl.readthedocs.io/en/latest/advance/megatron_extension.html)



### Utilsç»„ä»¶

åœ¨utilsæ–‡ä»¶å¤¹ä¸‹å®šä¹‰äº†ä¸€äº›é‡è¦çš„å·¥å…·å’Œç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š

1. Datasetï¼š

2. 1. ä¸»è¦åŒ…æ‹¬ï¼šrlã€sftå’Œrmçš„datasetï¼›
   2. å¤„ç†æ•°æ®é›†ä¸­çš„å„ä¸ªkeyï¼ŒåŒ…æ‹¬å–å‡ºäº†åˆ¶ä½œå¥½çš„parqueté‡Œé¢çš„promptåˆ—ï¼Œapply_chat_ml + tokenizeåè®¾ä¸ºinput_idsï¼›
   3. VeRLçš„datasetå’Œdataloaderæ²¡æœ‰å’Œè®­ç»ƒè¿‡ç¨‹å¼ºç»‘å®šï¼Œå¯ä»¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ¯”è¾ƒè½»æ¾åœ°åšåˆ°dataloaderçš„é‡è½½æˆ–è€…ä¿®æ”¹ï¼Œæ‰€ä»¥å®ç°ä¸€äº›åŠŸèƒ½ä¼šæ¯”è¾ƒæ–¹ä¾¿ï¼Œå¦‚åŠ¨æ€çš„è¯¾ç¨‹å­¦ä¹ ç­‰ï¼›

3. Debugï¼š

4. 1. ä¸»è¦åŒ…æ‹¬ï¼šç›‘æ§Performanceï¼ˆå¦‚GPU usageï¼‰å’ŒTrajectoryï¼ˆå³ä¿å­˜rolloutç»“æœï¼‰çš„é€»è¾‘ï¼›

5. Loggerï¼š

6. 1. é¡¾åæ€ä¹‰ï¼Œä¸»è¦æ˜¯å°†ä¸€äº›ç›‘æ§æŒ‡æ ‡è¾“å‡ºåˆ°æŒ‡å®šçš„ä½ç½®ï¼ˆconsoleæˆ–è€…wandbï¼‰çš„é€»è¾‘ï¼›

7. Megatronï¼š

8. 1. ä¸»è¦æ˜¯ä¸ºäº†åœ¨verlä¸­ä½¿ç”¨megatronæ‰€ç¼–å†™çš„ä¸€äº›utilsï¼Œä»¥åŠå¯¹åŸæœ‰megatronå®ç°é€‚é…verlæ‰€è¿›è¡Œçš„ä¸€äº›patchï¼›

9. Reward_scoreï¼š

10. 1. è¿™é‡Œä¸»è¦å­˜ç€é€‚é…ä¸åŒçš„rule-graderæ‰€ç¼–å†™çš„é€»è¾‘ï¼ŒåŒ…æ‹¬å„ç§parse answerçš„é€»è¾‘å’Œcompare answerçš„é€»è¾‘ï¼›

11. å…¶ä»–ï¼šå¦‚checkpointç®¡ç†çš„å·¥å…·ã€hdfsæ–‡ä»¶ç®¡ç†çš„å·¥å…·ã€æ”¯æŒulysess/seq_balancingç­‰featureçš„å·¥å…·ç­‰ï¼›

### third_partyç»„ä»¶

ç›®å‰ä¸»è¦æ˜¯å¯¹å¼€æºçš„æ¨ç†å¼•æ“vLLMï¼Œåšäº†ä¸€äº›é’ˆå¯¹verlè¿›è¡Œçš„å®šåˆ¶åŒ–é€‚é…å’Œå°è£…ï¼ˆå¦‚SPMDï¼‰ï¼›
ä¸»è¦æ˜¯ç»§æ‰¿äº†åŸå§‹çš„vllmï¼Œä»¥æ”¯æŒverlæ‰€éœ€è¦çš„ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚å–å‡ºç‰¹å®šè®¡ç®—ç»“æœã€æ›´å¥½åœ°æ”¯æŒhybrid engineï¼ˆå¦‚sync/offload paramsï¼Œdevice meshç®¡ç†ï¼Œweight loaderçš„å…¼å®¹...ï¼‰ç­‰ï¼›

### Protocolç»„ä»¶

 ä¸ºäº†æ”¯æŒRLè¿‡ç¨‹ä¸­æ›´å¥½çš„æ•°æ®ç®¡ç†å’Œä¼ è¾“ï¼Œverlè®¾è®¡äº†DataProtoè¿™ä¸€æ•°æ®ç»“æ„ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

1. åŸºäºTensorDictæ‰€å®ç°çš„batchï¼Œç”¨äºç®¡ç†a dictionary of tensorsï¼›
2. åŸºäºDictæ‰€å®ç°çš„meta_infoï¼Œç”¨äºç®¡ç†å½“å‰DataProtoçš„ä¿¡æ¯ï¼›
3. å…¶ä½™non-tensoræ•°æ®ï¼Œå­˜åœ¨non_tensor_batchä¸­ï¼›
4. ä»¥åŠDataProtoä½¿ç”¨æ‰€éœ€è¦çš„å„ç±»æ•°æ®ç®¡ç†é€»è¾‘ï¼Œå¦‚popã€chunkã€unionã€concatã€renameã€reorderç­‰ç­‰ï¼›

DataProtoFutureåˆ™æ˜¯ä¸ºäº†æ”¯æŒDataProtoçš„å¼‚æ­¥å¤„ç†è€Œæ„é€ çš„ï¼Œæ”¯æŒè´Ÿè´£reduceçš„collect_fnå’Œè´Ÿè´£scatterçš„dispatch_fnï¼Œä»è€Œæ–¹ä¾¿workerçš„éé˜»å¡æ‰§è¡Œã€‚
